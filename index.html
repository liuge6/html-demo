<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>圆牌小手机</title>
    <style id="main-style-definitions">
        :root { --phone-width: 375px; --phone-height: 812px; --primary-bg: #f0f0f0; --secondary-bg: #ffffff; --accent-color: #07c160; --text-color: #111111; --light-text-color: #888888; --bubble-sent-bg: #95ec69; --bubble-received-bg: #ffffff; --border-color: #e0e0e0; --transfer-bg: #f99534; --gift-bg: #f8b4c4; --like-color: #e74c3c; --danger-color: #e74c3c; --payment-request-bg: #ffd700; --orange-color: #f99534; --home-clock-color: #000000; }
        
        html, body { height: 100%; overflow: hidden; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #333; display: flex; justify-content: center; align-items: center; color: var(--text-color); }
        #phone-container { 
            width: 100%; height: 100%; 
            max-width: 430px; 
            max-height: 932px; 
            background-color: var(--primary-bg); 
            overflow: hidden; position: relative; 
            display: flex; flex-direction: column; 
            border: none; 
            border-radius: 0; 
            box-shadow: none; 
            box-sizing: border-box; 
        }
        .phone-screen { width: 100%; height: 100%; background-size: cover; background-position: center; background-repeat: no-repeat; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; background-color: var(--primary-bg); box-sizing: border-box; padding-top: 44px; }
        #screen-home, #screen-call { padding-top: 0; }
        .screen.active { display: flex; }
        #screen-chat, #screen-worldbook, #screen-wechat, #screen-gomoku, #screen-music, #screen-rps, #screen-icon-customizer { overflow: hidden; }
        
        #dynamic-island {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 36px; background: #000; border-radius: 18px; z-index: 11;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 8px; box-sizing: border-box; overflow: hidden;
        }
        #dynamic-island.music-active { width: 200px; cursor: pointer; }
        #dynamic-island.expanded { width: 250px; height: 85px; }
        .music-info { display: none; align-items: center; color: white; width: 100%; }
        #dynamic-island.music-active .music-info { display: flex; }
        #island-album-art { width: 24px; height: 24px; border-radius: 4px; background-color: #333; color: var(--accent-color); font-size: 18px; display: flex; align-items: center; justify-content: center; }
        #island-album-art svg { width: 16px; height: 16px; fill: var(--accent-color); }
        .music-waveform { display: flex; align-items: center; height: 20px; }
        .music-waveform.paused .bar { animation-play-state: paused; transform: scaleY(1); }
        .music-waveform .bar { width: 2px; height: 4px; background-color: var(--accent-color); margin: 0 1px; border-radius: 1px; animation: wave 1.2s infinite ease-in-out; }
        .music-waveform .bar:nth-child(2) { animation-delay: -1.1s; }
        .music-waveform .bar:nth-child(3) { animation-delay: -1.0s; }
        .music-waveform .bar:nth-child(4) { animation-delay: -0.9s; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(4); } }
        .music-controls { display: none; width: 100%; justify-content: space-around; align-items: center; padding: 10px; box-sizing: border-box; flex-direction: column; position: relative; }
        #dynamic-island.expanded .music-info { display: none; }
        #dynamic-island.expanded .music-controls { display: flex; }
        #island-song-info { color: white; font-size: 14px; text-align: center; margin-bottom: 8px; width: 100%; }
        #island-song-title { font-weight: bold; }
        #island-song-artist { font-size: 12px; opacity: 0.7; }
        .music-controls .buttons { display: flex; justify-content: space-around; width: 100%; }
        .music-control-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }
        .music-control-btn svg { width: 24px; height: 24px; fill: white; }
        #island-close-btn {
            position: absolute; top: 5px; right: 5px;
            width: 20px; height: 20px; background-color: rgba(255, 255, 255, 0.2);
            border: none; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        #island-close-btn svg { width: 10px; height: 10px; fill: #aaa; }
        
        .status-bar { height: 44px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 10; flex-shrink: 0; position: absolute; width: 100%; top: 0; left: 0; pointer-events: none; }
        .status-bar .time { font-weight: 600; width: 50px; text-align: center; color: var(--home-clock-color); text-shadow: none; pointer-events: all; cursor: pointer; }
        .status-bar .icons { display: flex; align-items: center; justify-content: flex-end; color: var(--home-clock-color); text-shadow: none; width: auto; min-width: 50px; }
        
        #screen-home { background-color: transparent; justify-content: space-between; flex-direction: column; padding-top: 0; }
        #home-layout { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; padding: 0 20px; box-sizing: border-box; }
        
        #home-top-widget {
            position: relative;
            width: 100%;
            margin: 50px auto 20px;
            flex-shrink: 0;
            pointer-events: none;
        }
        #home-top-widget-bg {
            width: 100%;
            display: block;
        }
        #home-top-widget-content {
            position: absolute;
            top: 21%;
            left: 24.5%;
            width: 52.7%;
            height: 54%;
            cursor: pointer;
            overflow: hidden;
            border-radius: 3px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: auto;
        }
        #home-top-widget-content img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        #home-grid-container {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            align-content: start;
        }
        
        #home-large-photo-widget {
            grid-column: 1 / 3;
            grid-row: 1 / 3;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            background-color: rgba(255,255,255,0.2);
        }
        #home-large-photo-widget img { width: 100%; height: 100%; object-fit: cover; }

        #home-profile-widget {
            grid-column: 3 / 5;
            grid-row: 3 / 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        #home-profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            object-fit: cover;
            margin-bottom: 5px;
        }
        #home-profile-text1, #home-profile-text2 {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 8px;
            cursor: text;
        }
        #home-profile-text2 {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .app-icon { width: 60px; display: flex; flex-direction: column; align-items: center; cursor: pointer; text-align: center; justify-self: center; align-self: center; }
        .app-icon .icon { width: 60px; height: 60px; border-radius: 15px; background-color: var(--secondary-bg); margin-bottom: 5px; font-size: 30px; display: flex; justify-content: center; align-items: center; object-fit: cover; }
        .app-icon span { font-size: 12px; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        
        #home-dock {
            flex-shrink: 0;
            padding: 10px 20px;
            margin: 0 15px 15px;
            background: rgba(240, 240, 240, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 80px;
            box-sizing: border-box;
        }
        #home-dock .app-icon span { display: none; }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; height: 44px; background-color: var(--primary-bg); border-bottom: 1px solid var(--border-color); box-sizing: border-box; flex-shrink: 0; }
        .header .title-container { flex-grow: 1; text-align: center; margin: 0 5px; overflow: hidden; }
        .header .title { font-size: 17px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #chat-status-indicator { font-size: 12px; color: var(--light-text-color); display: none; }
        .header .left-actions, .header .right-actions { display: flex; align-items: center; gap: 2px; flex-shrink: 0; flex-basis: 90px; }
        .header .left-actions { justify-content: flex-start; }
        .header .right-actions { justify-content: flex-end; }
        .header .back-btn { font-size: 17px; font-weight: normal; cursor: pointer; }
        .header .action-btn { font-size: 24px; cursor: pointer; background: none; border: none; padding: 5px; display: flex; align-items: center; justify-content: center; }
        .header .action-btn svg { width: 22px; height: 22px; fill: #333; }
        
        .content-container { flex-grow: 1; overflow-y: auto; background-color: var(--secondary-bg); min-height: 0; }
        .list-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .list-item.pinned { background-color: #f7f7f7; }
        .list-item .info { flex-grow: 1; margin: 0 10px; }
        .list-item .name { font-size: 16px; }
        .list-item .action-button { padding: 5px 10px; border: 1px solid var(--border-color); border-radius: 5px; background: #fff; cursor: pointer; }
        .list-item .delete-btn { background: none; border: none; font-size: 18px; color: var(--danger-color); cursor: pointer; padding: 5px; }
        .contact-list, .moments-feed, .forum-feed { display: none; }
        .contact-list.active, .moments-feed.active, .forum-feed.active { display: block; }
        .list-item-avatar { width: 48px; height: 48px; border-radius: 6px; margin-right: 12px; object-fit: cover; }
        .group-icon-indicator { position: absolute; bottom: 0; right: 0; background-color: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 1px 3px; border-radius: 3px; }
        .wechat-nav { display: flex; height: 50px; border-top: 1px solid var(--border-color); background-color: var(--primary-bg); flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; color: var(--light-text-color); }
        .nav-item.active { color: var(--accent-color); }
        .nav-item .icon svg { width: 24px; height: 24px; fill: currentColor; }
        .nav-item .text { font-size: 10px; margin-top: 2px; }
        .moments-header { position: relative; height: 250px; background-size: cover; background-position: center; color: white; cursor: pointer; }
        .moments-user { position: absolute; bottom: -20px; right: 15px; display: flex; align-items: flex-end; }
        .moments-user .info { text-align: right; margin-right: 10px; text-shadow: 1px 1px 2px #000; }
        .moments-user .name { font-weight: bold; font-size: 18px; }
        .moments-user .signature { font-size: 13px; opacity: 0.9; display: block; margin-top: 4px; }
        .moments-user img { width: 70px; height: 70px; border-radius: 8px; border: 2px solid white; object-fit: cover; }
        .moments-list, .forum-list { padding: 40px 0 10px 0; background: var(--secondary-bg); }
        .forum-list { padding: 10px 0; }
        .moment-item, .forum-post-item { padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; position: relative; }
        .moment-item .avatar, .forum-post-item .avatar { width: 42px; height: 42px; border-radius: 5px; margin-right: 10px; object-fit: cover; flex-shrink: 0; }
        .moment-item .content, .forum-post-item .content { flex-grow: 1; }
        .moment-item .author, .forum-post-item .author { font-weight: 600; color: #576b95; }
        .forum-post-item .title { font-size: 16px; font-weight: bold; margin-bottom: 8px; }
        .moment-item .text, .forum-post-item .text { margin: 5px 0; font-size: 15px; white-space: pre-wrap; word-break: break-all; }
        .moment-item .moment-image-container, .forum-post-item .post-image-container { margin-top: 8px; cursor: pointer; }
        .moment-item .moment-image-container img, .forum-post-item .post-image-container img { max-width: 150px; max-height: 150px; border-radius: 8px; }
        
        .moment-item .actions { display: flex; justify-content: space-between; align-items: center; color: var(--light-text-color); font-size: 13px; margin-top: 8px; }
        .moment-item .actions .left-actions { display: flex; align-items: center; gap: 8px; }
        .moment-item .actions .moment-delete-btn { color: var(--light-text-color); background: none; border: none; padding: 0; cursor: pointer; }
        .moment-item .actions .moment-delete-btn svg { width: 16px; height: 16px; fill: currentColor; vertical-align: middle; }
        .moment-item .actions .action-buttons { display: flex; gap: 15px; align-items: center; }
        .moment-item .actions .action-btn { color: var(--light-text-color); font-size: 13px; display: flex; align-items: center; gap: 4px; background: none; border: 1px solid var(--border-color); padding: 3px 8px; border-radius: 15px; cursor: pointer; }
        .moment-item .actions .action-btn:hover { background-color: #f0f0f0; }
        .moment-item .actions .action-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .moment-item .actions .like-btn.liked { color: var(--like-color); border-color: var(--like-color); }

        .forum-post-item .actions { display: flex; justify-content: space-between; align-items: center; color: var(--light-text-color); font-size: 13px; margin-top: 10px; }
        .forum-post-item .actions .left-actions { display: flex; align-items: center; gap: 8px; }
        .forum-post-item .actions .forum-delete-post-btn { color: var(--light-text-color); background: none; border: none; padding: 0; cursor: pointer; }
        .forum-post-item .actions .forum-delete-post-btn svg { width: 16px; height: 16px; fill: currentColor; vertical-align: middle; }
        .forum-post-item .actions .action-buttons { display: flex; gap: 15px; align-items: center; }
        .forum-post-item .actions .action-btn { color: var(--light-text-color); font-size: 13px; display: flex; align-items: center; gap: 4px; background: none; border: 1px solid var(--border-color); padding: 3px 8px; border-radius: 15px; cursor: pointer; }
        .forum-post-item .actions .action-btn:hover { background-color: #f0f0f0; }
        .forum-post-item .actions .action-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .forum-post-item .actions .forum-like-post-btn.liked { color: var(--like-color); border-color: var(--like-color); }
        
        .moment-likes, .forum-post-likes { background-color: #f7f7f7; margin-top: 8px; padding: 5px 8px; border-radius: 3px; font-size: 14px; color: #576b95; display: flex; align-items: center; gap: 5px; }
        .moment-likes .like-icon-svg, .forum-post-likes .like-icon-svg { width: 14px; height: 14px; fill: var(--like-color); flex-shrink: 0; }
        .moment-likes .liker-name, .forum-post-likes .liker-name { font-weight: 600; }
        
        .moment-comments { background-color: #f7f7f7; margin-top: 8px; padding: 5px 8px; border-radius: 3px; font-size: 14px; }
        .forum-post-comments { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .moment-comment { cursor: pointer; }
        .moment-comment .comment-author { font-weight: 600; color: #576b95; }
        .forum-post-comment { display: flex; margin-bottom: 15px; }
        .forum-comment-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; object-fit: cover; flex-shrink: 0; }
        .forum-comment-main { flex-grow: 1; }
        .forum-comment-author-line { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
        .forum-comment-author { font-weight: 600; color: #576b95; font-size: 14px; }
        .forum-comment-content { font-size: 14px; white-space: pre-wrap; word-break: break-all; }
        .forum-comment-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; color: var(--light-text-color); font-size: 12px; }
        .forum-comment-actions { display: flex; align-items: center; gap: 5px; }
        .forum-comment-like-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 3px; color: var(--light-text-color); }
        .forum-comment-like-btn.liked { color: var(--like-color); }
        .forum-comment-like-btn svg { width: 14px; height: 14px; fill: currentColor; }
        .comment-input-container { display: none; margin-top: 5px; }
        .comment-input-container.active { display: flex; }
        .comment-input-container input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 4px; padding: 5px; font-size: 14px; }
        .comment-input-container button { margin-left: 5px; padding: 5px 10px; border: none; background-color: var(--accent-color); color: white; border-radius: 4px; cursor: pointer; }
        #chat-area { flex-grow: 1; padding: 10px; overflow-y: auto; background-size: cover; background-position: center; display: flex; flex-direction: column; min-height: 0; scroll-behavior: smooth; }
        #chat-area.deletion-mode .message { cursor: pointer; }
        #chat-area.deletion-mode .message.selected-for-deletion { opacity: 0.5; box-shadow: 0 0 0 2px var(--danger-color) inset; border-radius: 12px; }
        .message { display: flex; margin-bottom: 10px; max-width: 80%; align-items: flex-end; position: relative; }
        .message .avatar { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; flex-shrink: 0; }
        .message .bubble { position: relative; padding: 10px 12px; border-radius: 8px; line-height: 1.4; word-wrap: break-word; white-space: pre-wrap; cursor: pointer; }
        .message .bubble.html-content { padding: 0; background-color: transparent; overflow: hidden; }
        #gomoku-chat-bubble-ai, #gomoku-chat-bubble-player { max-width: 84px; min-width: 30px; width: auto; word-break: keep-all; overflow-wrap: break-word; white-space: normal; line-height: 1.3; font-size: 14px; padding: 8px 10px; border-radius: 12px; background-color: var(--bubble-received-bg); border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.1); hyphens: none; }
        #gomoku-chat-bubble-player { background-color: var(--bubble-sent-bg); }
        .message.sent { margin-left: auto; flex-direction: row-reverse; }
        .message.sent .avatar { margin-left: 10px; }
        .message.sent .bubble { background-color: var(--bubble-sent-bg); }
        .message.received { margin-right: auto; }
        .message.received .avatar { margin-right: 10px; }
        .message.received .bubble { background-color: var(--bubble-received-bg); }
        
        .message-actions {
            display: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
            gap: 8px;
            z-index: 5;
        }
        .message.sent .message-actions { left: -30px; }
        .message.received .message-actions { right: -30px; }
        .message.quote-active .message-actions { display: flex; }

        .quote-icon, .edit-icon {
            background-color: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .edit-icon svg {
            width: 12px;
            height: 12px;
            fill: white;
        }

        .message.system { align-self: center; max-width: 100%; }
        .message.system .bubble { background-color: #e6e6e6; color: #888; font-size: 12px; padding: 4px 8px; text-align: center; cursor: default; white-space: pre-wrap; word-break: break-all; }
        .message.thinking .bubble { background-color: var(--bubble-received-bg); padding: 10px 12px; display: flex; align-items: center; cursor: default; }
        .message.thinking .dot { height: 8px; width: 8px; margin: 0 2px; background-color: #aaa; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .message.thinking .dot:nth-child(1) { animation-delay: -0.32s; } .message.thinking .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        /* --- 核心修改：恢复通用卡片气泡的样式 --- */
        .message.image .bubble, .message.sticker .bubble, .message.transfer .bubble, .message.payment_request .bubble, .message.image_description .bubble, .message.gift .bubble, .message.location .bubble, .message.chat_music .bubble { 
            background-color: transparent !important; 
            padding: 0 !important; 
        }
        /* --- 核心修改：仅针对音乐卡片的气泡，移除其固有高度以实现对齐 --- */
        .message.chat_music .bubble {
            line-height: 0;
        }

        .message.image .bubble img, .message.sticker .bubble img, .message.image_description .bubble img { max-width: 150px; max-height: 150px; display: block; border-radius: 8px; }
        .transfer-container { background-color: var(--transfer-bg); color: white; display: flex; width: 220px; border-radius: 8px; overflow: hidden; cursor: pointer; }
        .message.received.transfer:hover .transfer-container { filter: brightness(1.1); }
        .transfer-container[data-status="accepted"], .transfer-container[data-status="returned"] { background-color: #fcdab8; }
        .transfer-content { padding: 8px 10px; flex-grow: 1; }
        .transfer-icon { background-color: rgba(255,255,255,0.2); width: 35px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .transfer-icon svg { width: 24px; height: 24px; fill: white; }
        .transfer-amount { font-size: 16px; font-weight: bold; }
        .transfer-memo { font-size: 12px; opacity: 0.9; margin-top: 2px; }
        .transfer-footer { font-size: 11px; opacity: 0.8; margin-top: 6px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 4px; }
        .transfer-container[data-status="accepted"] .transfer-footer::after { content: " · 已收款"; font-weight: bold; }
        .transfer-container[data-status="returned"] .transfer-footer::after { content: " · 已退还"; }
        .gift-container { background-color: var(--gift-bg); color: white; display: flex; width: 220px; border-radius: 8px; overflow: hidden; cursor: pointer; }
        .message.received.gift:hover .gift-container, .message.sent.gift:hover .gift-container { filter: brightness(1.1); }
        .gift-content { padding: 8px 10px; flex-grow: 1; }
        .gift-icon { background-color: rgba(255,255,255,0.2); width: 50px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .gift-title { font-size: 16px; font-weight: bold; }
        .gift-footer { font-size: 11px; opacity: 0.8; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 4px; }
        
        .location-container { background-color: #e4f1fe; color: #333; display: flex; width: 220px; border-radius: 8px; overflow: hidden; cursor: pointer; border: 1px solid #d2e3f3; }
        .message.received.location:hover .location-container, .message.sent.location:hover .location-container { filter: brightness(0.98); }
        .location-content { padding: 8px 10px; flex-grow: 1; }
        .location-icon { background-color: #d2e3f3; width: 50px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .location-icon svg { width: 28px; height: 28px; fill: var(--accent-color); }
        .location-title { font-size: 16px; font-weight: 500; }
        .location-footer { font-size: 11px; color: #888; margin-top: 10px; border-top: 1px solid #d2e3f3; padding-top: 4px; }

        .chat-music-container {
            background-color: var(--secondary-bg);
            display: flex;
            width: 220px;
            height: 56px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid var(--border-color);
            padding: 0;
            box-sizing: border-box;
            align-items: stretch;
            gap: 0;
        }
        .message.sent .chat-music-container {
            background-color: var(--bubble-sent-bg);
            border-color: #89d961;
        }
        .chat-music-cover {
            width: 56px;
            height: 56px;
            border-radius: 0;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #ddd;
        }
        .chat-music-info {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-left: 10px;
            line-height: 1.4;
        }
        .chat-music-title {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-color);
        }
        .chat-music-artist {
            font-size: 12px;
            color: var(--light-text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }
        .message.sent .chat-music-title {
            color: #111;
        }
        .message.sent .chat-music-artist {
            color: #333;
        }
        .chat-music-play-icon {
            width: auto;
            height: auto;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-right: 12px;
        }
        .chat-music-play-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--light-text-color);
        }
        .message.sent .chat-music-play-icon svg {
            fill: #555;
        }

        .payment-request-container { background-color: var(--payment-request-bg); color: #333; width: 240px; border-radius: 8px; overflow: hidden; padding: 10px; box-sizing: border-box; }
        .payment-request-container[data-status="paid"], .payment-request-container[data-status="declined"] { background-color: #f0f0f0; }
        .payment-request-header { display: flex; align-items: center; font-weight: bold; margin-bottom: 10px; }
        .payment-request-header span:first-child { font-size: 24px; margin-right: 8px; }
        .payment-request-header span:first-child svg { width: 28px; height: 28px; fill: #a67c00; }
        .payment-request-body { margin-bottom: 10px; }
        .payment-request-item { font-size: 16px; font-weight: 500; }
        .payment-request-amount { font-size: 20px; font-weight: bold; }
        .payment-request-footer { border-top: 1px solid rgba(0,0,0,0.1); padding-top: 8px; }
        .payment-request-footer button { width: 100%; background: var(--accent-color); color: white; border: none; border-radius: 5px; padding: 8px; font-size: 14px; cursor: pointer; }
        .payment-request-footer .status-text { text-align: center; font-weight: bold; color: var(--light-text-color); }
        .message.voice .bubble { display: flex; align-items: center; min-width: 80px; justify-content: space-between; }
        .voice-bar-container { display: flex; align-items: flex-end; height: 20px; }
        .voice-bar { width: 3px; background-color: currentColor; margin: 0 1px; border-radius: 2px; }
        .message.sent .voice-bar { background-color: #333; }
        .message.received .voice-bar { background-color: #888; }
        .voice-play-icon { font-size: 20px; }
        .message.sent .voice-play-icon { margin-right: 8px; color: #333; }
        .message.received .voice-play-icon { margin-left: 8px; color: #888; }
        .voice-duration { font-size: 14px; color: #555; }
        .message.sent .voice-duration { margin-left: 10px; }
        .message.received .voice-duration { margin-right: 10px; }
        .quote-bubble { background-color: rgba(0,0,0,0.05); padding: 5px 8px; border-radius: 6px; margin-bottom: 5px; font-size: 13px; border-left: 3px solid var(--accent-color); }
        .quote-bubble .author { font-weight: bold; color: #555; }
        .quote-bubble .text { color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #chat-input-area { background-color: var(--primary-bg); flex-shrink: 0; }
        #reply-preview-container { display: none; padding: 5px 10px; background-color: #e9e9e9; font-size: 12px; color: #555; }
        #reply-preview-container.active { display: flex; justify-content: space-between; align-items: center; }
        #reply-preview-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #cancel-reply-btn { cursor: pointer; font-weight: bold; font-size: 16px; padding: 0 5px; }
        #chat-input-controls { display: flex; align-items: flex-end; padding: 8px; gap: 8px; background-color: var(--primary-bg); }
        #chat-input { flex-grow: 1; min-height: 38px; padding: 8px 12px; border-radius: 18px; border: 1px solid var(--border-color); background-color: var(--secondary-bg); font-size: 16px; line-height: 1.4; box-sizing: border-box; }
        .input-btn { font-size: 28px; cursor: pointer; color: #555; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; }
        #chat-actions-toggle-btn { background-color: var(--secondary-bg); border: 1px solid var(--border-color); }
        #get-ai-response-btn { background-color: var(--secondary-bg); border: 1px solid var(--border-color); }
        #get-ai-response-btn svg { width: 24px; height: 24px; }
        #send-btn { background-color: var(--orange-color); color: white; border: none; width: 38px; height: 38px; padding: 0; }
        #send-btn:disabled { background-color: #fddcb5; cursor: default; }
        #send-btn svg { width: 20px; height: 20px; fill: white; }
        #chat-actions-panel { display: none; padding: 15px; grid-template-columns: repeat(4, 1fr); gap: 15px; border-top: 1px solid var(--border-color); }
        #chat-actions-panel.active { display: grid; }
        .action-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .action-item .icon { width: 50px; height: 50px; border-radius: 10px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 24px; margin-bottom: 5px; border: 1px solid #e0e0e0; }
        .action-item .icon svg { width: 28px; height: 28px; fill: #555; }
        .action-item span { font-size: 12px; color: var(--light-text-color); }
        .settings-content { padding: 20px; flex-grow: 1; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-group.horizontal { display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 31px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        #worldbook-content { min-height: 200px; }
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--secondary-bg); padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; box-sizing: border-box; max-height: 90%; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-content h3 { margin-top: 0; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 8px; border: 1px dashed var(--border-color); background-color: #f0f0f0; cursor: pointer; display: flex; justify-content: center; align-items: center; color: var(--light-text-color); font-size: 12px; text-align: center; overflow: hidden; object-fit: cover; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; background-color: var(--accent-color); color: white; font-size: 16px; cursor: pointer; margin-top: 10px; text-decoration: none; text-align: center; display: inline-block; }
        .btn-secondary { background-color: #ccc; } .btn-danger { background-color: var(--danger-color); }
        .btn:disabled { background-color: #b4eebc; cursor: not-allowed; }
        #gomoku-opponent-selection, #gomoku-game-board { display: none; width: 100%; height: 100%; flex-direction: column; }
        #gomoku-opponent-selection.active, #gomoku-game-board.active { display: flex; }
        .gomoku-container { padding: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; background: #eee; flex-grow: 1; }
        .player-info { display: flex; justify-content: space-around; align-items: center; width: 100%; }
        .player-card { position: relative; display: flex; flex-direction: column; align-items: center; gap: 5px; width: 80px; }
        .player-card img { width: 50px; height: 50px; border-radius: 8px; border: 2px solid transparent; cursor: pointer; }
        .player-card.active img { border-color: var(--accent-color); }
        .player-card .status-text { font-size: 12px; color: var(--light-text-color); height: 16px; }
        #gomoku-board { background-color: #f7d086; cursor: pointer; width: 90%; aspect-ratio: 1 / 1; max-height: calc(100% - 120px); margin: 15px auto; box-sizing: border-box; }
        .gomoku-chat-bubble { display: none; position: absolute; top: 100%; margin-top: 8px; left: 50%; transform: translateX(-50%); background-color: rgba(255, 255, 255, 0.95); color: #333; padding: 8px 12px; border-radius: 10px; max-width: 120px; font-size: 14px; z-index: 5; white-space: normal; word-break: break-all; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .gomoku-chat-bubble::after { content: ''; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-style: solid; border-width: 0 8px 8px 8px; border-color: transparent transparent rgba(255, 255, 255, 0.95) transparent; }
        #rps-game-container { display: none; } #rps-game-container.active { display: flex; flex-direction: column; flex-grow: 1; }
        .rps-container { display: flex; flex-direction: column; flex-grow: 1; padding: 20px; box-sizing: border-box; background: #2c3e50; color: white; }
        .rps-arena { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .rps-player-card { display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; width: 100px; }
        .rps-player-card img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid white; cursor: pointer; }
        .rps-hand-display { font-size: 50px; height: 60px; }
        .rps-vs { font-size: 30px; font-weight: bold; }
        .rps-emoji-popup { display: none; position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); padding: 5px; border-radius: 20px; display: flex; gap: 5px; z-index: 10; }
        .rps-emoji-popup.active { display: flex; }
        .rps-emoji-option { font-size: 24px; cursor: pointer; padding: 5px; }
        .rps-emoji-display { position: absolute; top: -15px; font-size: 30px; }
        #rps-player-emoji-display { right: -15px; } #rps-ai-emoji-display { left: -15px; }
        #rps-result-display { text-align: center; font-size: 24px; font-weight: bold; min-height: 30px; margin-bottom: 30px; }
        .rps-controls { display: flex; justify-content: space-around; }
        .rps-controls button { font-size: 40px; background: none; border: none; cursor: pointer; }
        #music-listen-together-ui { padding: 20px; display: flex; flex-direction: column; align-items: center; flex-grow: 1; background-color: #000; color: #fff; position: relative; overflow: hidden; }
        .music-avatars { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 300px; margin-bottom: 10px; position: relative; }
        .music-avatar-card { display: flex; flex-direction: column; align-items: center; gap: 5px; position: relative; z-index: 3; cursor: pointer; }
        .music-avatar-card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .music-avatar-card .invite-plus { width: 60px; height: 60px; border-radius: 50%; background-color: #333; color: #ccc; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .music-chat-bubble { display: none; position: absolute; top: 95px; background-color: rgba(255, 255, 255, 0.9); color: #333; padding: 8px 12px; border-radius: 10px; max-width: 120px; font-size: 14px; z-index: 5; white-space: normal; word-wrap: break-word; text-align: left; }
        .music-chat-bubble.left { left: 30px; transform: translateX(-50%); }
        .music-chat-bubble.right { right: 30px; transform: translateX(50%); }
        .music-chat-bubble::after { content: ''; position: absolute; top: -8px; width: 0; height: 0; border: 8px solid transparent; border-bottom-color: rgba(255, 255, 255, 0.9); left: 50%; transform: translateX(-50%); }
        .music-distance-info { text-align: center; z-index: 3; }
        .music-distance-info .distance { font-size: 14px; color: #aaa; }
        .music-distance-info .listening-time { font-size: 12px; color: #aaa; margin-top: 2px; }
        #music-headphone-wires { position: absolute; top: 60px; left: 0; width: 100%; height: 150px; z-index: 1; pointer-events: none; }
        #music-headphone-wires path { stroke: #555; stroke-width: 2; fill: none; }
        #music-player-image { width: 200px; height: 200px; margin: 20px 0; z-index: 2; object-fit: contain; flex-shrink: 0; }
        #music-playlist-container { width: 100%; flex-grow: 1; overflow-y: auto; background: #000; min-height: 0; }
        #music-playlist-container.deletion-mode .music-song-item .delete-song-item-btn { display: inline-block; }
        .music-song-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #333; cursor: pointer; background-color: #000; color: #fff; }
        .music-song-item:hover { background-color: #111; }
        .music-song-item.playing { color: var(--accent-color); font-weight: bold; }
        .delete-song-item-btn { display: none; background: none; border: none; color: var(--danger-color); font-size: 20px; cursor: pointer; padding: 0 5px; }
        .delete-song-item-btn svg { width: 16px; height: 16px; fill: currentColor; vertical-align: middle; }
        .anniversary-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; margin: 10px 15px; border-radius: 12px; background-size: cover; background-position: center; position: relative; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); min-height: 80px; box-sizing: border-box;}
        .anniversary-info { flex-grow: 1; }
        .anniversary-info .title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .anniversary-info .details { font-size: 13px; opacity: 0.9; }
        .anniversary-countdown { text-align: right; }
        .anniversary-countdown .label { font-size: 12px; }
        .anniversary-countdown .days { font-size: 28px; font-weight: bold; }
        .delete-anniversary-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.3); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 24px; text-align: center;}
        .diary-entry { background: var(--secondary-bg); margin: 10px 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .delete-diary-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; }
        .diary-header { display: flex; align-items: center; margin-bottom: 15px; }
        .diary-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .diary-author-info .name { font-weight: 600; }
        .diary-author-info .date { font-size: 12px; color: var(--light-text-color); }
        .diary-content { white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
        #sticker-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 20px 15px; padding: 15px; overflow-y: auto; }
        .sticker-grid-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; }
        .sticker-grid-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; background-color: #eee; }
        .sticker-grid-item .sticker-desc { font-size: 11px; color: var(--light-text-color); margin-top: 4px; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sticker-grid-item.sticker-add-btn { width: 70px; height: 70px; justify-content: center; border: 2px dashed #ccc; border-radius: 8px; font-size: 30px; color: #aaa; background-color: transparent; margin: 0 auto; }
        .sticker-grid-item.sticker-add-btn img, .sticker-grid-item.sticker-add-btn .sticker-desc { display: none; }
        #sticker-grid.deletion-mode .sticker-delete-overlay { display: flex; }
        .sticker-delete-overlay { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background-color: rgba(231, 76, 60, 0.9); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; line-height: 24px; border: 2px solid white; z-index: 1; }
        #sticker-pagination { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-top: 1px solid var(--border-color); }
        #sticker-pagination button { padding: 5px 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
        #sticker-pagination button:disabled { cursor: not-allowed; opacity: 0.5; }
        #group-member-selection { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 5px; }
        .member-selection-item { display: block; }
        .member-selection-item label { display: flex; align-items: center; padding: 5px; cursor: pointer; }
        .member-selection-item img { width: 30px; height: 30px; border-radius: 4px; margin-right: 10px; }
        #chat-settings-group-info, #chat-settings-contact-info { display: none; }
        #edit-bubble-css-raw { min-height: 150px; font-family: monospace; font-size: 12px; }
        .bubble-preview-area { margin-top: 10px; padding: 10px; background-color: #f0f0f0; border: 1px dashed #ccc; border-radius: 6px; }
        .bubble-preview-area .message { margin-bottom: 8px !important; align-items: center; }
        .bubble-preview-area .message:last-child { margin-bottom: 0 !important; }
        .bubble-preview-area .bubble { padding: 8px 10px !important; font-size: 14px; }
        .font-input-group { display: flex; align-items: center; gap: 5px; }
        .font-input-group input[type="text"] { flex-grow: 1; }
        .font-input-group .btn-secondary { width: auto; margin-top: 0; padding: 10px; }
        .font-preview-area { margin-top: 10px; padding: 10px; background-color: #f9f9f9; border: 1px dashed #ccc; border-radius: 6px; }
        .font-preview-area p { margin: 5px 0; }
        #voice-transcript-content, #view-image-description-content, #view-gift-content { white-space: pre-wrap; word-break: break-all; max-height: 60vh; overflow-y: auto; background-color: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 10px; text-align: center; }
        .modal-content textarea#chat-summary-content {
            min-height: 250px;
            resize: vertical;
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 14px;
            line-height: 1.6;
        }
        #heart-voice-content { display: flex; flex-direction: column; gap: 15px; }
        .heart-voice-entry { display: flex; align-items: flex-start; gap: 10px; }
        .heart-voice-entry img { width: 40px; height: 40px; border-radius: 6px; flex-shrink: 0; }
        .heart-voice-entry .text-content { display: flex; flex-direction: column; }
        .heart-voice-entry .name { font-weight: bold; margin-bottom: 4px; }
        .heart-voice-entry .thought { font-size: 14px; color: #555; white-space: pre-wrap; word-break: break-all; }
        #screen-call { background-color: #2c3e50; color: white; justify-content: space-between; text-align: center; }
        #call-avatar-container { flex-shrink: 0; padding-top: 60px; cursor: pointer; }
        #call-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid white; margin-bottom: 10px; }
        #call-name { font-size: 24px; font-weight: 500; }
        #call-status { font-size: 14px; color: #bdc3c7; }
        #call-transcript-area { flex-grow: 1; overflow-y: auto; padding: 10px 20px; border-top: 1px solid #34495e; border-bottom: 1px solid #34495e; margin: 20px 0; text-align: left; font-size: 16px; line-height: 1.5; }
        #call-transcript-area p { margin: 8px 0; }
        #call-transcript-area strong { color: #95ec69; }
        #call-controls { flex-shrink: 0; padding-bottom: 40px; }
        #hang-up-btn { width: 70px; height: 70px; border-radius: 50%; background-color: var(--danger-color); border: none; color: white; font-size: 30px; cursor: pointer; line-height: 70px; }
        
        /* --- 核心修改：新增音乐播放器和音乐库的样式 --- */
        #chat-music-player {
            display: none;
            position: absolute;
            z-index: 120;
            width: 320px;
            background-color: rgba(50, 50, 50, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            color: white;
            padding: 15px;
            box-sizing: border-box;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            flex-direction: column;
            gap: 10px;
        }
        #chat-music-player.active {
            display: flex;
        }
        .player-header {
            display: flex;
            gap: 12px;
            align-items: center;
            cursor: move;
            position: relative;
        }
        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .player-info-lyrics {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 60px;
            overflow: hidden;
        }
        .player-song-info {
            margin-bottom: 5px;
        }
        .player-song-title {
            font-size: 16px;
            font-weight: bold;
        }
        .player-song-artist {
            font-size: 13px;
            opacity: 0.8;
        }
        .player-lyrics-container {
            height: 20px;
            overflow: hidden;
            position: relative;
            font-size: 14px;
            color: #ccc;
        }
        .player-lyrics-scroller {
            position: absolute;
            width: 100%;
            transition: transform 0.3s ease-out;
        }
        .lyric-line {
            height: 20px;
            line-height: 20px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.7;
        }
        .lyric-line.active {
            font-weight: bold;
            color: white;
            opacity: 1;
        }
        .player-close-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            background-color: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-close-btn svg {
            width: 12px;
            height: 12px;
            fill: white;
        }
        .player-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .player-controls button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
        .player-controls button svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        #player-play-pause-btn svg {
            width: 36px;
            height: 36px;
        }
        .player-progress-area {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .player-progress-bar-wrapper {
            flex-grow: 1;
            height: 4px;
            background-color: rgba(255,255,255,0.3);
            border-radius: 2px;
            cursor: pointer;
            padding: 5px 0;
        }
        .player-progress-bar {
            height: 4px;
            background-color: white;
            border-radius: 2px;
            width: 0%;
        }
        #music-library-modal .modal-content {
            gap: 0;
        }
        .music-library-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        .music-library-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-weight: 500;
            color: var(--light-text-color);
            border-bottom: 2px solid transparent;
        }
        .music-library-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .music-library-content {
            display: none;
        }
        .music-library-content.active {
            display: block;
        }
        #music-library-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .music-library-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .music-library-item:hover {
            background-color: #f9f9f9;
        }
        .music-library-item img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            object-fit: cover;
            background-color: #eee;
        }
        .music-library-item .info {
            flex-grow: 1;
            overflow: hidden;
        }
        .music-library-item .info .name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .music-library-item .info .artist {
            font-size: 12px;
            color: var(--light-text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .music-library-item .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            flex-shrink: 0;
        }
        .music-library-item .delete-btn svg {
            width: 18px;
            height: 18px;
            fill: var(--danger-color);
        }
        #upload-song-lyrics {
            min-height: 100px;
            resize: vertical;
        }

        @keyframes gradient { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
    </style>
    <style id="bubble-preview-style-tag"></style>
    <style id="custom-font-style-tag"></style>
</head>
</html>
<body>
<div id="phone-container">
    <div id="phone-screen" class="phone-screen">
        <div id="dynamic-island">
            <div class="music-info">
                <div id="island-album-art"></div>
                <div class="music-waveform">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
            <div class="music-controls">
                <button id="island-close-btn"></button>
                <div id="island-song-info">
                    <div id="island-song-title">歌曲名称</div>
                    <div id="island-song-artist">歌手</div>
                </div>
                <div class="buttons">
                    <button class="music-control-btn" id="island-prev-btn"></button>
                    <button class="music-control-btn" id="island-play-pause-btn"></button>
                    <button class="music-control-btn" id="island-next-btn"></button>
                </div>
            </div>
        </div>
        <div id="status-bar" class="status-bar"><span class="time" id="time-display">9:41</span><span class="icons" id="status-icons"></span></div>
        
        <div id="screen-home" class="screen active">
            <div id="home-layout">
                <div id="home-top-widget">
                    <img id="home-top-widget-bg" src="https://i.postimg.cc/7LtgdV6R/Image-1758277837416.png" alt="Top Widget Background">
                    <div id="home-top-widget-content">
                        <img id="home-top-widget-image" src="" alt="Top Widget Content">
                    </div>
                    <input type="file" id="home-top-widget-input" accept="image/*" style="display: none;">
                </div>

                <div id="home-grid-container">
                    <div id="home-large-photo-widget">
                        <img id="home-large-photo-image" src="" alt="Large Photo">
                    </div>
                    <input type="file" id="home-large-photo-input" accept="image/*" style="display: none;">

                    <div id="home-profile-widget">
                        <img id="home-profile-avatar" src="" alt="Profile Avatar">
                        <span id="home-profile-text1" contenteditable="true">Colorful Widget</span>
                        <span id="home-profile-text2" contenteditable="true">Top Widgets+</span>
                    </div>
                    <input type="file" id="home-profile-avatar-input" accept="image/*" style="display: none;">
                </div>
            </div>
            <div id="home-dock">
            </div>
        </div>

        <div id="screen-wechat" class="screen"></div><div id="screen-music" class="screen"></div><div id="screen-gomoku" class="screen"></div><div id="screen-rps" class="screen"></div><div id="screen-worldbook" class="screen"></div><div id="screen-chat" class="screen"></div><div id="screen-api" class="screen"></div><div id="screen-wallpaper" class="screen"></div><div id="screen-anniversary" class="screen"></div><div id="screen-diary" class="screen"></div><div id="screen-call" class="screen"></div><div id="screen-icon-customizer" class="screen"></div>
        
        <div id="chat-music-player"></div>
    </div>
</div>

<div id="edit-message-modal" class="modal"></div>
<div id="chat-summary-modal" class="modal"></div>
<div id="music-library-modal" class="modal"></div>

<div id="send-location-modal" class="modal"></div><div id="add-menu-modal" class="modal"></div><div id="add-contact-modal" class="modal"></div><div id="add-group-chat-modal" class="modal"></div><div id="chat-settings-modal" class="modal"></div><div id="post-moments-modal" class="modal"></div><div id="select-ai-post-modal" class="modal"></div><div id="edit-moments-profile-modal" class="modal"></div><div id="add-anniversary-modal" class="modal"></div><div id="select-diary-author-modal" class="modal"></div><div id="transfer-modal" class="modal"></div><div id="worldbook-modal" class="modal"></div><div id="gomoku-result-modal" class="modal"></div><div id="rps-opponent-selection-modal" class="modal"></div><div id="add-song-modal" class="modal"></div><div id="select-music-partner-modal" class="modal"></div><div id="add-sticker-modal" class="modal"></div><div id="batch-add-sticker-modal" class="modal"></div><div id="sticker-picker-modal" class="modal"></div><div id="import-export-modal" class="modal"></div><div id="send-voice-modal" class="modal"></div><div id="voice-transcript-modal" class="modal"></div><div id="call-input-modal" class="modal"></div><div id="music-chat-input-modal" class="modal"></div><div id="edit-app-icon-modal" class="modal"></div><div id="request-payment-modal" class="modal"></div><div id="heart-voice-modal" class="modal"></div><div id="gomoku-chat-input-modal" class="modal"></div><div id="send-image-desc-modal" class="modal"></div><div id="view-image-description-modal" class="modal"></div><div id="send-gift-modal" class="modal"></div><div id="view-gift-modal" class="modal"></div><div id="worldbook-import-export-modal" class="modal"></div><div id="post-forum-modal" class="modal"></div><div id="select-forum-ai-post-modal" class="modal"></div><div id="clock-color-modal" class="modal"></div>
<audio id="music-player-element"></audio>
<audio id="chat-music-player-audio"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const phoneScreen = document.getElementById('phone-screen'); const timeDisplay = document.getElementById('time-display'); const allScreens = document.querySelectorAll('.screen');
    let apiSettings = {}, contacts = [], groupChats = [], moments = [], anniversaries = [], diaries = [], worldBooks = [], myMomentsProfile = {}, musicAppData = {}, stickers = [], forumPosts = [];
    let chatMusicLibrary = [];
    let chatMusicPlayerState = {
        isPlaying: false,
        currentSongId: null,
        audioElement: null,
        isDragging: false,
        offsetX: 0,
        offsetY: 0,
        lyricParser: null,
        lyricUpdateInterval: null
    };
    
    let homeWidgetsData = {
        topWidgetImageId: null,
        largePhotoImageId: null,
        profileAvatarId: null,
        profileText1: 'Colorful Widget',
        profileText2: 'Top Widgets+'
    };

    let appConfig = [
        { id: 'wechat', name: '微信', icon: 'https://files.catbox.moe/7rt2g3.jpg', target: 'screen-wechat' },
        { id: 'music', name: '一起听', icon: 'https://files.catbox.moe/nwt23h.jpg', target: 'screen-music' },
        { id: 'gomoku', name: '五子棋', icon: 'https://files.catbox.moe/hqfaou.jpg', target: 'screen-gomoku' },
        { id: 'rps', name: '猜拳', icon: 'https://files.catbox.moe/za3rtx.jpg', target: 'screen-rps' },
        { id: 'anniversary', name: '纪念日', icon: 'https://files.catbox.moe/cq3bit.jpg', target: 'screen-anniversary' },
        { id: 'diary', name: '日记', icon: 'https://files.catbox.moe/anyfm1.jpg', target: 'screen-diary' },
        { id: 'api', name: 'API', icon: 'https://files.catbox.moe/ztqg5o.jpg', target: 'screen-api' },
        { id: 'worldbook', name: '世界书', icon: 'https://files.catbox.moe/mbnta5.jpg', target: 'screen-worldbook' },
        { id: 'icon-customizer', name: '图标', icon: 'https://files.catbox.moe/sqp4bg.jpg', target: 'screen-icon-customizer' },
        { id: 'wallpaper', name: '壁纸', icon: 'https://files.catbox.moe/83p4mn.jpg', target: 'screen-wallpaper' },
    ];
    let activeChat = { id: null, isGroup: false };
    let activeCallState = { isActive: false, chatId: null, isGroup: false, transcript: [], currentTurnContactId: null, startTime: 0, callReason: null };
    let tempImageId = {}, db;
    let isDeletionMode = false, messagesToDelete = new Set();
    let isMusicDeleteMode = false;
    let isStickerDeleteMode = false;
    let activeReplyTarget = null;
    let gomokuGame = {}; let rpsGame = {};
    let stickerPickerState = { currentPage: 1, stickersPerPage: 8 };
    let stickerBatch = { items: [], currentIndex: 0 };
    let aiRequestController = null;
    let isAiThinking = false;
    let contactListRendered = false;
    const defaultAvatarBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAICSURBVHhe7Zq/SgNBFAD3HlAEQRB8EHyAIAj+g4gP4g/Yxi/Y2toKFhYWNoqNlYiIAra2thY2PlCwsRBBEESwsfEP2IuDDxALEfHkna4sLTPz5s25sYV94C6su3v37v1TVE1VVTVd1/VfVd9gqPMRRFG0Xdd1WZZl2Y5vGIZhHcbx8TAMwzAMwzCMwzAMwzCMwzAMwzCMwzAMwzCMwzAMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwzCMwAAAAElFTSuQmCC';
    const defaultAvatarId = 'default_avatar'; const emptyBgId = 'empty_bg';
    const fixedImageForDesc = 'https://i.postimg.cc/HLJLRkq8/Screenshot-2025-08-31-22-45-11-432-com-xingin-xhs-edit.jpg';
    const giftSVG = `<svg viewBox="0 0 24 24" fill="white" width="32" height="32"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35C11.96 2.54 11.05 2 10 2 8.34 2 7 3.34 7 5c0 .35.07.69.18 1H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 16H4V8h16v12z"></path></svg>`;
    const strangerAvatars = [ 'https://i.postimg.cc/VLWKpG7Q/Screenshot-2025-09-08-18-16-39-298-com-xingin-xhs-edit.jpg', 'https://i.postimg.cc/BvkpHdvD/Screenshot-2025-09-08-18-16-48-989-com-xingin-xhs-edit.jpg', 'https://i.postimg.cc/CL74mZ1w/Screenshot-2025-09-08-18-16-57-938-com-xingin-xhs-edit.jpg', 'https://i.postimg.cc/85wCqVrf/Screenshot-2025-09-08-18-17-06-899-com-xingin-xhs-edit.jpg', 'https://i.postimg.cc/dQH16wYz/Screenshot-2025-09-08-18-17-15-001-com-xingin-xhs-edit.jpg', 'https://i.postimg.cc/Z535JNdS/Screenshot-2025-09-08-18-17-23-796-com-xingin-xhs-edit.jpg', 'https://i.postimg.cc/mDZL366L/Screenshot-2025-09-08-18-17-31-629-com-xingin-xhs-edit.jpg', 'https://i.postimg.cc/ydfVLXwF/Screenshot-2025-09-08-18-17-40-330-com-xingin-xhs-edit.jpg' ];
    const strangerNames = [ "再也不熬夜", "可我睡不着", "不想起床", "比考试难烤的地瓜", "想要吃不胖", "坏情绪走开", "睡醒还是好困", "睡觉不眨眼", "为什么会有早八", "早起大王", "减肥也要多吃饭", "想睡到自然醒", "早睡不会掉头发", "不当恋爱脑", "数学快滚蛋", "好想吃烧烤啊", "70内向小学生", "明天会变好", "早八走狗", "倒头就睡不醒", "天天开心没烦恼", "发呆小天才", "可爱科科满分", "萌到下奶", "变本加厉卖萌", "不管就是很萌", "一滴宅泪", "等冰化了", "你的泪像雨", "这断片的泪", "悲悯天真的心", "我的悲伤无解", "幸福也会到期", "我为天真立名", "圆脸财", "神灵赋予好运", "富贵来财命", "宅妹发财愿", "年岁常驻通", "好运常驻于我", "绝对好运连连", "年年都好财运", "金币滚进口袋", "福禄寿主", "连体林总破洞", "来我家做小狗", "贝利亚恋爱中", "贝利亚失恋中", "少恋爱多抽象", "过年回村喂鸡", "打小就爱犯贱", "现实就是装货", "踢到甲沟炎了", "贝利亚音梦莉", "只红温的废物", "躲鸡窝里伤感", "鹿多了好累累", "舔狗吗只追我", "和我谈我梦皇", "得烧人且扰人", "日记泛黄那页", "下次见有糖吃", "幻想成为幸福小猫", "catstar", "幸福像饲料", "猪咪饲养员", "catdollface", "眼泪总断片", "小饼吐司面包", "我笨别总骗我", "1米8就好啦", "不阔以骗小孩", "泪水如雨决堤", "打小爱撒娇", "唉气连连", "流浪小猫命", "拼好饭好上瘾", "过年回村喂鸡", "凭你也说皇帝", "别喷我超雄体", "牢弟你笑死人", "玩密码伤感呢", "超绝红温体质", "你快滚一边去", "辣条音少梦皇", "来人摆驾回城", "臭脚熏死过人", "渴望拥抱男模", "总为钱包憔悴", "网恋过男猪脚", "唇珠不要顶嘴", "自信知性女人", "只想做你祖银", "乐子人少犬吠", "老妹我包帅的", "网恋过双面龟", "小x眠兔", "铃铃铃x恋", "喵绵绵x", "饼卷x只", "可萌xx", "泪落x心", "灵x泪", "枝x棠梨", "可颂x只", "呆瓜xx", "怜x太宅", "怪x太忧", "听x心绪", "笔只xx", "梦x太甜", "心疼x哭", "x少哭唧", "又叙x心痛", "少听疑谣言", "开创极致巅峰", "独见破晓神光", "压制冰冷冷感", "摆脱宿命羁绊", "听我极致理解", "自会摆脱困局", "超脱困境边缘", "励志登顶国一", "骂我就去死呗", "惹我都别活路", "凶我长本事了", "世界第一抽象", "你会搞抽象吗", "不信我会抽象", "就怪我抽象呗", "自己盯着自己", "惹急你了吗", "心诀", "诀心诗", "失泪岛", "失心岛", "怜冰季", "折冰季", "断联雨", "悲悯雨", "泪许爱", "结爱诗", "偏弦爱", "偏冷爱" ];
    const nameChars = "琳瑶欣悦琪彤晨曦然诺萱怡涵宇轩梓瑞哲嘉";
    const forumLikeSVG = `<svg viewBox="0 0 24 24"><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"></path></svg>`;
    const forumCommentSVG = `<svg viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>`;
    const forumDeleteSVG = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`;
    const momentsLikeSVG = `<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
    const momentsCommentSVG = `<svg viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM17 11H7V9h10v2zm-2-3H7V6h8v2z"></path></svg>`;
    const momentsDeleteSVG = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`;
    const musicNoteSVG = `<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path></svg>`;
    const chatMusicSVG = `<?xml version="1.0" encoding="UTF-8"?><svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M24 6V35" stroke="#333" stroke-width="4" stroke-linecap="butt" stroke-linejoin="round"/><path d="M10 36.04C10 33.2565 12.2565 31 15.04 31H24V36.96C24 39.7435 21.7435 42 18.96 42H15.04C12.2565 42 10 39.7435 10 36.96V36.04Z" fill="none" stroke="#333" stroke-width="4" stroke-linejoin="round"/><path fill-rule="evenodd" clip-rule="evenodd" d="M24 14.0664L36.8834 17.1215V9.01341L24 6.00002V14.0664Z" stroke="#333" stroke-width="4" stroke-linecap="butt" stroke-linejoin="round"/></svg>`;
    const playSVG = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>`;
    const pauseSVG = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
    const prevSVG = `<svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg>`;
    const nextSVG = `<svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>`;
    const trashSVG = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`;
    const closeSVG = `<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>`;
    const transferSVG = `<svg viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>`;
    const paymentRequestSVG = `<svg viewBox="0 0 24 24"><path d="M18 6h-2c0-2.21-1.79-4-4-4S8 3.79 8 6H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6-2c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2zm6 16H6V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v2c0 .55.45 1 1 1s1-.45 1-1V8h2v12z"></path></svg>`;
    const editSVG = `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>`;
    const saveSVG = `<svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path></svg>`;
    const forumScenarios = [ "你是一个微博用户，正在吃一个明星的瓜。写一个帖子，标题要引人注目，内容要包含一些猜测和“内部消息”，并使用 #某某人设崩塌# 或 #某某恋情曝光#等这样的标签，不能只用这两个示例标签，自己也要想一些别的标签，例如耍大牌、虐粉等等。里面的某某是你要想的一个男明星或者女明星的名字。", "你是一个贴吧老哥，因为一件生活琐事（比如外卖晚了、游戏输了、被插队了、队友太坑、被朋友背刺等等）非常生气。开个帖子直接开喷，标题要充满火药味，内容要用暴躁的语气抱怨。", "你是一个小红书用户，遇到了一个棘手的个人问题（比如不知道怎么选礼物、或者和朋友闹了别扭、求好物分享、避雷某某物品等等）。以“家人们谁懂啊”开头，用亲切又带点夸张的语气描述你的困境，并向大家求助。多使用emoji，必须发散性思维思考话题。", "你是一个游戏论坛的玩家，刚刚达成了一个很难的成就或者抽到了稀有角色。写一个帖子来炫耀，标题要充满凡尔赛气息，内容要详细描述你的“欧皇”经历，或者你是一个非酋，运气很差，玩什么游戏都吃保底，发帖子吐槽游戏爆率，或者你是一个外观党玩家，吐槽或者夸赞游戏新出的皮肤、建模、设计等等。", "你是一个生活分享博主，刚刚发现了一个特别好用的小东西或者一个风景很好的地方。写一篇“种草”笔记，标题要吸引人，内容要图文并茂地介绍它的优点。", "你是一个深夜emo的网友，在论坛上发表一些伤感的、哲学性的思考。标题可以是一句歌词或诗句，内容要充满氛围感。", "你是一个宠物博主，你的宠物今天做了一件特别搞笑或者特别可爱的事情。写一篇帖子分享出来，标题要萌一点，内容可以模仿宠物的口吻。", "你是一个美食爱好者，刚刚尝试了一家新餐厅或者自己做了一道拿手菜。发帖分享你的体验，标题要让人流口水，内容要详细描述味道和口感，或者避雷某个餐馆怎么怎么样，或者种草某个餐馆怎么怎么样。", "你是一个学生党/打工人，正在疯狂吐槽你的专业/工作。开个帖子，标题可以是“XX专业/行业的，进来抱团取暖”，内容要说出你的心声，引发共鸣，如果是留学生，还可以发自己对祖国的思念，对家乡菜的想念之类的。", "你是一个追星女孩/男孩，你的偶像今天有了新动态（新歌、新剧、机场图等）。激动地发一个帖子，标题要充满爱意，内容要疯狂赞美你的偶像。", "你是一个二次元男孩/女孩，你会经常分享一些你喜欢的动漫和角色，或者吐槽你讨厌的角色/剧情，最大的兴趣爱好是宅家玩游戏和去漫展，分享一些这些日常" ];
    function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open("aiPhoneDB_v38_10", 12); request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject("数据库初始化失败！"); }; request.onupgradeneeded = (event) => { const dbInstance = event.target.result; if (!dbInstance.objectStoreNames.contains('appData')) { dbInstance.createObjectStore("appData", { keyPath: "key" }); } if (!dbInstance.objectStoreNames.contains('images')) { dbInstance.createObjectStore("images", { keyPath: "id" }); } if (!dbInstance.objectStoreNames.contains('fonts')) { dbInstance.createObjectStore("fonts", { keyPath: "id" }); } }; request.onsuccess = (event) => { db = event.target.result; const transaction = db.transaction(["images"], "readwrite"); const store = transaction.objectStore("images"); store.put({ id: defaultAvatarId, data: defaultAvatarBase64 }); store.put({ id: emptyBgId, data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' }); resolve(db); }; }); }
    async function saveData() { if (!db) return; try { const transaction = db.transaction(["appData"], "readwrite"); const store = transaction.objectStore("appData"); const dataToSave = { key: 'main', apiSettings, contacts, groupChats, moments, anniversaries, diaries, worldBooks, myMomentsProfile, musicAppData, stickers, appConfig, forumPosts, homeWidgetsData, chatMusicLibrary, wallpaperUrl: phoneScreen.style.backgroundImage.slice(5, -2).replace(/"/g, "") }; store.put(dataToSave); } catch (e) { console.error("Error saving data to IndexedDB:", e); alert("保存数据时出错，请重试。"); } }
    async function loadData() { if (!db) return; const transaction = db.transaction(["appData"], "readonly"); const store = transaction.objectStore("appData"); const request = store.get("main"); return new Promise(resolve => { request.onsuccess = (event) => { const mainData = event.target.result; if (mainData) { apiSettings = mainData.apiSettings || {}; contacts = mainData.contacts || []; groupChats = mainData.groupChats || []; moments = mainData.moments || []; anniversaries = mainData.anniversaries || []; diaries = mainData.diaries || []; worldBooks = mainData.worldBooks || []; myMomentsProfile = mainData.myMomentsProfile || {}; musicAppData = mainData.musicAppData || { playlist: [], currentPartnerId: null }; stickers = mainData.stickers || []; forumPosts = mainData.forumPosts || []; homeWidgetsData = mainData.homeWidgetsData || { topWidgetImageId: null, largePhotoImageId: null, profileAvatarId: null, profileText1: 'Colorful Widget', profileText2: 'Top Widgets+' }; chatMusicLibrary = mainData.chatMusicLibrary || []; if (mainData.appConfig) appConfig = mainData.appConfig; if(mainData.wallpaperUrl) phoneScreen.style.backgroundImage = `url(${mainData.wallpaperUrl})`; } if (!myMomentsProfile.name) myMomentsProfile.name = '我'; if (!myMomentsProfile.avatarId) myMomentsProfile.avatarId = defaultAvatarId; if (!musicAppData.playlist) musicAppData = { playlist: [], currentPartnerId: null }; if (!stickers) stickers = []; if (!groupChats) groupChats = []; if (!forumPosts) forumPosts = []; if (!chatMusicLibrary) chatMusicLibrary = []; resolve(); }; request.onerror = () => { if (!myMomentsProfile.name) myMomentsProfile.name = '我'; if (!myMomentsProfile.avatarId) myMomentsProfile.avatarId = defaultAvatarId; if (!musicAppData.playlist) musicAppData = { playlist: [], currentPartnerId: null }; if (!stickers) stickers = []; if (!groupChats) groupChats = []; if (!forumPosts) forumPosts = []; if (!chatMusicLibrary) chatMusicLibrary = []; resolve(); } }); }
    const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
    async function storeImageAndGetId(file) { if (!db) return defaultAvatarId; const base64 = await fileToBase64(file); const id = `img_${Date.now()}_${Math.random()}`; try { const transaction = db.transaction(["images"], "readwrite"); const store = transaction.objectStore("images"); store.put({ id, data: base64 }); return id; } catch(e) { console.error("Error saving image to IndexedDB:", e); alert("保存图片时出错！可能是图片过大或存储空间不足。"); return null; } }
    async function getImageById(id) { if (!db || !id) return defaultAvatarBase64; if (id.startsWith('http') || id.startsWith('data:image')) return id; if (id === emptyBgId) return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; const transaction = db.transaction(["images"], "readonly"); const store = transaction.objectStore("images"); const request = store.get(id); return new Promise(resolve => { request.onsuccess = (event) => { resolve(event.target.result ? event.target.result.data : defaultAvatarBase64); }; request.onerror = () => { resolve(defaultAvatarBase64); }; }); }
    async function storeFontAndGetInfo(file) { if (!db) return null; const base64 = await fileToBase64(file); const id = `font_${Date.now()}_${Math.random()}`; const name = file.name; try { const transaction = db.transaction(["fonts"], "readwrite"); const store = transaction.objectStore("fonts"); store.put({ id, name, data: base64 }); return { id, name }; } catch(e) { console.error("Error saving font to IndexedDB:", e); alert("保存字体时出错！可能是文件过大或存储空间不足。"); return null; } }
    async function getFontDataById(id) { if (!db || !id) return null; const transaction = db.transaction(["fonts"], "readonly"); const store = transaction.objectStore("fonts"); const request = store.get(id); return new Promise(resolve => { request.onsuccess = (event) => { resolve(event.target.result ? event.target.result : null); }; request.onerror = () => { resolve(null); }; }); }
    
    async function renderHTML() {
        document.getElementById('screen-wechat').innerHTML = `<div class="header" id="wechat-header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title" id="wechat-title">微信 (<span>0</span>)</div></div><div class="right-actions"><button class="action-btn" id="add-btn">+</button><button class="action-btn" id="moments-ai-post-btn" style="display:none; font-size:22px;">◎</button><button class="action-btn" id="moments-my-post-btn" style="display:none;">+</button></div></div><div class="content-container"><div class="contact-list active" id="contact-list-container"></div><div class="moments-feed" id="moments-feed-container"><div class="moments-header" id="moments-header-bg"><div class="moments-user"><div class="info"><span class="name" id="my-moments-name">我</span><span class="signature" id="my-moments-signature"></span></div><img src="" id="my-moments-avatar" alt="我的头像"></div></div><div class="moments-list" id="moments-list"></div></div><div class="forum-feed" id="forum-feed-container"><div class="forum-list" id="forum-list"></div></div></div><nav class="wechat-nav"><div class="nav-item active" data-tab="contact-list"><div class="icon"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></svg></div><div class="text">会话</div></div><div class="nav-item" data-tab="moments-feed"><div class="icon"><svg viewBox="0 0 24 24"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"></path></svg></div><div class="text">朋友圈</div></div><div class="nav-item" data-tab="forum-feed"><div class="icon"><svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V4c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v13l4-4h9c1.1 0 2-.9 2-2z"></path></svg></div><div class="text">论坛</div></div></nav>`;
        document.getElementById('screen-music').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">一起听</div></div><div class="right-actions"><button class="action-btn" id="add-song-btn">+</button><button class="action-btn" id="delete-song-btn">${trashSVG}</button></div></div><div id="music-listen-together-ui"><svg id="music-headphone-wires" xmlns="http://www.w3.org/2000/svg"><path id="wire-left" d=""/><path id="wire-right" d=""/></svg><div class="music-avatars"><div class="music-avatar-card" id="music-avatar-left"><div class="invite-plus">+</div></div><div class="music-distance-info"><div class="distance">距离 520m</div><div class="listening-time">一起听了99个小时</div></div><div class="music-avatar-card" id="music-avatar-right"></div><div id="music-partner-chat-bubble" class="music-chat-bubble left"></div><div id="music-my-chat-bubble" class="music-chat-bubble right"></div></div><img id="music-player-image" src="https://files.catbox.moe/0estcd.jpg" alt="Player"><div id="music-playlist-container"></div></div>`;
        document.getElementById('screen-gomoku').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home" id="gomoku-back-btn">‹ 主页</div></div><div class="title-container"><div class="title">五子棋</div></div><div class="right-actions" style="flex-basis: 90px;"></div></div><div id="gomoku-opponent-selection" class="content-container"></div><div id="gomoku-game-board" class="gomoku-container"><div class="player-info"><div class="player-card" id="gomoku-player-human"><img alt="我的头像"><span></span><div id="gomoku-chat-bubble-player" class="gomoku-chat-bubble"></div></div><div class="player-card" id="gomoku-player-ai"><img alt="对手头像"><span></span><div class="status-text" id="gomoku-ai-status"></div><div id="gomoku-chat-bubble-ai" class="gomoku-chat-bubble"></div></div></div><canvas id="gomoku-board"></canvas></div>`;
        document.getElementById('screen-rps').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">猜拳</div></div><div class="right-actions" style="flex-basis: 90px;"></div></div><div id="rps-game-container" class="rps-container"><div class="rps-arena"><div class="rps-player-card" id="rps-player-card"><img id="rps-player-avatar" src=""><span id="rps-player-name"></span><div id="rps-player-hand" class="rps-hand-display"></div><div id="rps-player-emoji-display" class="rps-emoji-display"></div></div><div class="rps-vs">VS</div><div class="rps-player-card" id="rps-ai-card"><div id="rps-ai-hand" class="rps-hand-display"></div><img id="rps-ai-avatar" src=""><span id="rps-ai-name"></span><div id="rps-ai-emoji-display" class="rps-emoji-display"></div></div></div><div id="rps-result-display">选择你的出拳！</div><div class="rps-controls" id="rps-controls"><button id="rps-rock">✊</button><button id="rps-paper">✋</button><button id="rps-scissors">✌️</button></div><div class="rps-emoji-popup" id="rps-emoji-popup"><span class="rps-emoji-option">😎</span><span class="rps-emoji-option">😭</span><span class="rps-emoji-option">😡</span><span class="rps-emoji-option">🥰</span></div></div>`;
        document.getElementById('screen-worldbook').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">世界书</div></div><div class="right-actions"><button class="action-btn" id="add-worldbook-btn">+</button><button class="action-btn" id="worldbook-import-export-btn"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg></button></div></div><div class="content-container" id="worldbook-list-container"></div>`;
        document.getElementById('screen-chat').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-wechat">‹ 返回</div></div><div class="title-container"><div class="title" id="chat-contact-name">...</div><div id="chat-status-indicator"></div></div><div class="right-actions"><button class="action-btn" id="import-export-btn"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg></button><button class="action-btn" id="multi-select-btn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-8h14V7H7v2z"></path></svg></button><button class="action-btn" id="chat-settings-btn"><svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg></button></div></div><div id="chat-area"></div><div id="chat-input-area"><div id="reply-preview-container"><span id="reply-preview-text"></span><span id="cancel-reply-btn">×</span></div><div id="chat-actions-panel"><div class="action-item" id="album-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg></div><span>相册</span></div><div class="action-item" id="location-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg></div><span>位置</span></div><div class="action-item" id="image-desc-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg></div><span>图片</span></div><div class="action-item" id="sticker-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path></svg></div><span>表情包</span></div><div class="action-item" id="transfer-action-btn"><div class="icon">${transferSVG}</div><span>转账</span></div><div class="action-item" id="payment-request-action-btn"><div class="icon">${paymentRequestSVG}</div><span>外卖</span></div><div class="action-item" id="voice-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path></svg></div><span>语音</span></div><div class="action-item" id="call-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"></path></svg></div><span>通话</span></div><div class="action-item" id="gift-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35C11.96 2.54 11.05 2 10 2 8.34 2 7 3.34 7 5c0 .35.07.69.18 1H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 16H4V8h16v12z"></path></svg></div><span>礼物</span></div><div class="action-item" id="heart-voice-action-btn"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg></div><span>心声</span></div><div class="action-item" id="chat-summary-action-btn"><div class="icon">${saveSVG}</div><span>聊天总结</span></div><div class="action-item" id="chat-music-action-btn"><div class="icon">${chatMusicSVG}</div><span>音乐</span></div></div><div id="chat-input-controls"><button class="input-btn" id="chat-actions-toggle-btn">+</button><input type="text" id="chat-input" placeholder="输入消息..."><button class="input-btn" id="get-ai-response-btn"><svg viewBox="0 0 100 100"><circle cx="50" cy="55" r="35" fill="var(--orange-color)"/><path d="M50,20 A15,10 0 0,1 65,25 Q60,5 50,10 Q40,5 35,25 A15,10 0 0,1 50,20 Z" fill="#6B8E23"/></svg></button><button class="input-btn" id="send-btn" disabled><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button></div></div><input type="file" id="chat-image-input" accept="image/*" style="display: none;">`;
        document.getElementById('screen-api').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">API 设置</div></div><div class="right-actions" style="flex-basis: 90px;"></div></div><div class="settings-content"><div class="form-group"><label for="api-base-url">反向代理地址 (Base URL)</label><input type="text" id="api-base-url" placeholder="例如: https://api.openai.com"></div><div class="form-group"><label for="api-key">API 密钥 (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div><button id="fetch-models-btn" class="btn btn-secondary">拉取模型</button><div class="form-group" style="margin-top: 15px;"><label for="api-model-select">选择模型</label><select id="api-model-select" disabled><option>请先拉取模型</option></select></div><button id="save-api-settings-btn" class="btn">保存设置</button></div>`;
        document.getElementById('screen-wallpaper').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">主页壁纸设置</div></div><div class="right-actions" style="flex-basis: 90px;"></div></div><div class="settings-content"><div class="form-group"><label for="wallpaper-url">图片 URL</label><input type="text" id="wallpaper-url" placeholder="输入图片的URL地址"></div><button id="apply-wallpaper-btn" class="btn">应用壁纸</button><hr style="margin: 20px 0;"><button id="upload-wallpaper-btn" class="btn btn-secondary">从相册选择</button><input type="file" id="wallpaper-input" accept="image/*" style="display: none;"></div>`;
        document.getElementById('screen-anniversary').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">纪念日</div></div><div class="right-actions"><button class="action-btn" id="add-anniversary-btn">+</button></div></div><div class="content-container" id="anniversary-list-container" style="padding: 5px 0;"></div>`;
        document.getElementById('screen-diary').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">日记</div></div><div class="right-actions"><button class="action-btn" id="add-diary-btn">+</button></div></div><div class="content-container" id="diary-list-container" style="padding: 5px 0;"></div>`;
        document.getElementById('screen-call').innerHTML = `<div id="call-avatar-container"><img id="call-avatar" src=""><h2 id="call-name"></h2><p id="call-status">正在连接...</p></div><div id="call-transcript-area"></div><div id="call-controls"><button id="hang-up-btn">📞</button></div>`;
        document.getElementById('screen-icon-customizer').innerHTML = `<div class="header"><div class="left-actions"><div class="back-btn" data-target="screen-home">‹ 主页</div></div><div class="title-container"><div class="title">图标更换</div></div><div class="right-actions" style="flex-basis: 90px;"></div></div><div class="content-container" id="icon-customizer-list"></div>`
        document.getElementById('add-menu-modal').innerHTML = `<div class="modal-content"><h3>发起</h3><button id="menu-add-contact" class="btn btn-secondary">添加角色</button><button id="menu-add-group" class="btn">创建群聊</button></div>`;
        document.getElementById('add-contact-modal').innerHTML = `<div class="modal-content"><h3>添加新角色</h3><div class="form-group"><label>头像</label><img class="avatar-preview" id="add-contact-avatar-preview" src="" alt="头像预览"><input type="file" id="add-contact-avatar-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="add-contact-name">角色姓名</label><input type="text" id="add-contact-name"></div><div class="form-group"><label for="add-contact-remark">角色备注 (备注会优先显示)</label><input type="text" id="add-contact-remark"></div><div class="form-group"><label for="add-contact-persona">角色人设</label><textarea id="add-contact-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-add-contact-btn" class="btn">添加</button></div></div>`;
        document.getElementById('add-group-chat-modal').innerHTML = `<div class="modal-content"><h3>创建群聊</h3><div class="form-group"><label>群头像</label><img class="avatar-preview" id="add-group-avatar-preview" src="" alt="群头像预览"><input type="file" id="add-group-avatar-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="add-group-name">群名称</label><input type="text" id="add-group-name"></div><div class="form-group"><label>邀请联系人</label><div id="group-member-selection"></div></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-add-group-btn" class="btn">创建</button></div></div>`;
        document.getElementById('chat-settings-modal').innerHTML = `<div class="modal-content"><h3>聊天设置</h3><input type="hidden" id="settings-chat-id"><div class="form-group horizontal"><label for="pin-chat-toggle">置顶聊天</label><label class="toggle-switch"><input type="checkbox" id="pin-chat-toggle"><span class="slider"></span></label></div><hr><div id="chat-settings-group-info"><div class="form-group"><label>群头像</label><img class="avatar-preview" id="edit-group-avatar-preview" src="" alt="群头像预览"><input type="file" id="edit-group-avatar-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="edit-group-name">群名称</label><input type="text" id="edit-group-name"></div></div><div id="chat-settings-contact-info"><div class="form-group"><label>角色头像</label><img class="avatar-preview" id="edit-contact-avatar-preview" src="" alt="头像预览"><input type="file" id="edit-contact-avatar-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="edit-contact-name">角色姓名</label><input type="text" id="edit-contact-name"></div><div class="form-group"><label for="edit-contact-remark">角色备注 (备注会优先显示)</label><input type="text" id="edit-contact-remark"></div><div class="form-group"><label for="edit-contact-persona">角色人设</label><textarea id="edit-contact-persona"></textarea></div><div class="form-group"><label for="edit-chess-style">棋风</label><select id="edit-chess-style"><option value="放水">放水</option><option value="中等">中等</option><option value="加强">加强</option></select></div></div><hr><h4>世界观设定</h4><div class="form-group"><label for="bind-worldbook-select">绑定世界书</label><select id="bind-worldbook-select" multiple></select><small style="display: block; margin-top: 5px; color: var(--light-text-color);">按住 Ctrl (或 Mac上的Cmd) 可选择多个</small></div><hr><h4>我方设定 (本次对话)</h4><div class="form-group"><label>我方头像</label><img class="avatar-preview" id="edit-my-avatar-preview" src="" alt="头像预览"><input type="file" id="edit-my-avatar-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="edit-my-name">我方姓名</label><input type="text" id="edit-my-name"></div><div class="form-group"><label for="edit-my-persona">我方人设</label><textarea id="edit-my-persona" placeholder="在此次对话中，你的身份设定。"></textarea></div><hr><h4>自定义字体</h4><div class="form-group"><label for="edit-sent-font">我方字体</label><div class="font-input-group"><input type="text" id="edit-sent-font" placeholder="如: 霞鹜文楷, cursive"><button class="btn btn-secondary" id="upload-sent-font-btn">上传</button></div><input type="file" id="sent-font-input" accept=".ttf,.otf,.woff,.woff2" style="display: none;"></div><div class="form-group"><label for="edit-received-font">对方字体</label><div class="font-input-group"><input type="text" id="edit-received-font" placeholder="如: 微软雅黑, sans-serif"><button class="btn btn-secondary" id="upload-received-font-btn">上传</button></div><input type="file" id="received-font-input" accept=".ttf,.otf,.woff,.woff2" style="display: none;"></div><div class="font-preview-area"><p id="font-preview-sent">我方字体预览 (The quick brown fox...)</p><p id="font-preview-received">对方字体预览 (jumps over the lazy dog.)</p></div><hr><h4>气泡样式 (CSS 规则)</h4><div class="form-group"><label for="edit-bubble-css-raw">聊天气泡样式 (写入完整规则)</label><textarea id="edit-bubble-css-raw" placeholder="/* 在此写入完整 CSS 规则, 可包含动画和伪元素 */&#10;&#10;/* 示例: 添加气泡尾巴 */&#10;.message.sent .bubble::after {&#10;  content: '';&#10;  position: absolute;&#10;  right: -10px;&#10;  bottom: 10px;&#10;  width: 0;&#10;  height: 0;&#10;  border: 10px solid transparent;&#10;  border-left-color: var(--bubble-sent-bg);&#10;  border-right: 0;&#10;  border-bottom: 0;&#10;}&#10;&#10;.message.received .bubble::before {&#10;  content: '';&#10;  position: absolute;&#10;  left: -10px;&#10;  bottom: 10px;&#10;  width: 0;&#10;  height: 0;&#10;  border: 10px solid transparent;&#10;  border-right-color: var(--bubble-received-bg);&#10;  border-left: 0;&#10;  border-bottom: 0;&#10;}&#10;&#10;/* 示例: 流光动画 */&#10;@keyframes gradient { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }&#10;.message .bubble {&#10;  animation: gradient 10s ease infinite;&#10;  background-size: 400% 400%;&#10;  background-image: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);&#10;}"></textarea><div class="bubble-preview-area"><div class="message sent"><div class="bubble">我方气泡预览</div></div><div class="message received"><div class="bubble">对方气泡预览</div></div></div></div><hr><h4>其他设置</h4><div class="form-group"><label for="edit-memory-depth">AI 记忆条数</label><input type="number" id="edit-memory-depth" min="2" max="50" value="10"></div><div class="form-group"><label>当前聊天背景</label><img class="avatar-preview" id="edit-chat-bg-preview" src="" alt="背景预览"><input type="file" id="edit-chat-bg-input" accept="image/*" style="display: none;"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="save-chat-settings-btn" class="btn">保存</button></div><button id="delete-chat-history-btn" class="btn btn-danger" style="background-color: #f39c12;">删除聊天记录</button><button id="delete-chat-btn" class="btn btn-danger">删除该会话</button></div>`;
        document.getElementById('post-moments-modal').innerHTML = `<div class="modal-content"><h3>发布朋友圈</h3><div class="form-group"><textarea id="my-moments-text" placeholder="这一刻的想法..."></textarea></div><div class="form-group"><label for="my-moments-image-desc">配图描述 (选填)</label><input type="text" id="my-moments-image-desc" placeholder="描述一下图片内容"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-my-moments-btn" class="btn">发布</button></div></div>`;
        document.getElementById('select-ai-post-modal').innerHTML = `<div class="modal-content"><h3>让谁发朋友圈？</h3><div id="ai-post-selection-list"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button></div></div>`;
        document.getElementById('edit-moments-profile-modal').innerHTML = `<div class="modal-content"><h3>修改朋友圈信息</h3><div class="form-group"><label>朋友圈背景</label><img class="avatar-preview" id="edit-moments-bg-preview" alt="背景预览" style="width:100%; height:auto;"><input type="file" id="edit-moments-bg-input" accept="image/*" style="display: none;"></div><div class="form-group"><label>我的头像</label><img class="avatar-preview" id="edit-moments-avatar-preview" alt="头像预览"><input type="file" id="edit-moments-avatar-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="edit-moments-name">我的名字</label><input type="text" id="edit-moments-name"></div><div class="form-group"><label for="edit-moments-signature">个性签名</label><input type="text" id="edit-moments-signature"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="save-edit-moments-profile-btn" class="btn">保存</button></div></div>`;
        document.getElementById('add-anniversary-modal').innerHTML = `<div class="modal-content"><h3>添加新纪念日</h3><div class="form-group"><label for="anniversary-title">标题</label><input type="text" id="anniversary-title" placeholder="如：第一次见面"></div><div class="form-group"><label for="anniversary-date">日期</label><input type="date" id="anniversary-date"></div><div class="form-group"><label for="anniversary-contact-select">关联联系人</label><select id="anniversary-contact-select"></select></div><div class="form-group"><label>封面</label><img class="avatar-preview" id="anniversary-cover-preview" src="" alt="封面预览" style="width: 100%; height: 120px; object-fit: cover;"><input type="file" id="anniversary-cover-input" accept="image/*" style="display: none;"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-add-anniversary-btn" class="btn">添加</button></div></div>`;
        document.getElementById('select-diary-author-modal').innerHTML = `<div class="modal-content"><h3>让谁写日记？</h3><div id="diary-author-selection-list"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button></div></div>`;
        document.getElementById('transfer-modal').innerHTML = `<div class="modal-content"><h3>转账</h3><div class="form-group" id="transfer-recipient-group" style="display:none;"><label for="transfer-recipient-select">转账给</label><select id="transfer-recipient-select"></select></div><div class="form-group"><label for="transfer-amount">转账金额</label><input type="number" id="transfer-amount" placeholder="0.00" max="100000" step="0.01"></div><div class="form-group"><label for="transfer-memo">转账备注</label><input type="text" id="transfer-memo" placeholder="（可不填）"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-transfer-btn" class="btn">确认转账</button></div></div>`;
        document.getElementById('worldbook-modal').innerHTML = `<div class="modal-content"><h3>世界书</h3><input type="hidden" id="worldbook-id"><div class="form-group"><label for="worldbook-name">书名</label><input type="text" id="worldbook-name"></div><div class="form-group"><label for="worldbook-content">内容</label><textarea id="worldbook-content" placeholder="在此定义世界观，或使用以下格式触发特殊内容：\n\n固定HTML:\n[TRIGGER:触发词]\n[HTML]...代码...[END_HTML]\n\n动态生成HTML:\n[TRIGGER:触发词]\n[HTML_PROMPT]...给AI的指令...[END_HTML_PROMPT]\n\n在HTML中，你可以使用 {{user}} 来代表我方姓名。"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="save-worldbook-btn" class="btn">保存</button></div></div>`;
        document.getElementById('gomoku-result-modal').innerHTML = `<div class="modal-content"><h3 id="gomoku-result-text"></h3><div class="modal-buttons"><button class="btn btn-secondary" id="gomoku-rematch-btn">再来一把</button><button class="btn" id="gomoku-change-opponent-btn">换个对手</button></div></div>`;
        document.getElementById('rps-opponent-selection-modal').innerHTML = `<div class="modal-content"><h3>选择猜拳对手</h3><div id="rps-opponent-list" class="content-container"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button></div></div>`;
        document.getElementById('add-song-modal').innerHTML = `<div class="modal-content"><h3>添加歌曲</h3><div class="form-group"><label for="add-song-name">歌曲名称</label><input type="text" id="add-song-name"></div><div class="form-group"><label for="add-song-url">歌曲URL</label><input type="text" id="add-song-url" placeholder="请填入有效的音频直链"></div><button id="upload-song-file-btn" class="btn btn-secondary">从文件上传</button><input type="file" id="song-file-input" accept="audio/*" style="display: none;"><div class="modal-buttons" style="margin-top:20px;"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-add-song-btn" class="btn">添加</button></div></div>`;
        document.getElementById('select-music-partner-modal').innerHTML = `<div class="modal-content"><h3>邀请谁一起听？</h3><div id="music-partner-selection-list"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button></div></div>`;
        document.getElementById('add-sticker-modal').innerHTML = `<div class="modal-content"><h3>批量添加表情包 (第一步)</h3><div class="form-group"><label>从相册选择 (可多选)</label><button id="select-sticker-files-btn" class="btn btn-secondary">选择图片文件</button><input type="file" id="add-sticker-input" accept="image/*" style="display: none;" multiple></div><p style="text-align:center; color: var(--light-text-color); margin: 10px 0;">— 或 —</p><div class="form-group"><label for="add-sticker-url">图片 URL (每行一个)</label><textarea id="add-sticker-url" placeholder="格式: 图片链接,图片描述&#10;例如: https://example.com/happy.gif,开心猫猫&#10;(描述为选填，没有描述则下一步手动填写)" rows="4"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-add-sticker-btn" class="btn">下一步</button></div></div>`;
        document.getElementById('batch-add-sticker-modal').innerHTML = `<div class="modal-content"><h3 id="batch-sticker-title">添加描述 (1 / 5)</h3><div class="form-group" style="text-align:center;"><img class="avatar-preview" id="batch-sticker-preview" src="" alt="表情预览" style="width: 150px; height: 150px; margin: 0 auto;"></div><div class="form-group"><label for="batch-sticker-desc">表情包描述 (必填)</label><input type="text" id="batch-sticker-desc" placeholder="如: 开心猫猫, 疑惑柴犬"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消所有</button><button id="save-next-sticker-btn" class="btn">保存并下一个</button></div></div>`;
        document.getElementById('sticker-picker-modal').innerHTML = `<div class="modal-content" style="display:flex; flex-direction:column;"><div style="display:flex; justify-content:space-between; align-items:center; flex-shrink:0;"><h3>表情包画廊</h3><button class="action-btn" id="sticker-delete-toggle-btn">🗑️</button></div><div id="sticker-grid"></div><div id="sticker-pagination" style="display:none; flex-shrink:0;"><button id="sticker-prev-btn">‹ 上一页</button><span id="sticker-page-info"></span><button id="sticker-next-btn">下一页 ›</button></div></div>`;
        document.getElementById('import-export-modal').innerHTML = `<div class="modal-content"><h3>记忆之匣</h3><div id="import-export-content"><p style="text-align:center; font-size:14px; color:var(--light-text-color);">保存或唤醒与TA的对话记忆</p><button id="export-chat-btn" class="btn btn-secondary">导出聊天记录</button><button id="import-chat-btn" class="btn">导入聊天记录</button></div><input type="file" id="import-chat-input" accept=".json" style="display: none;"><div class="modal-buttons" style="margin-top: 30px;"><button class="btn btn-secondary" data-action="close-import-export" style="width:100%">关闭</button></div></div>`;
        document.getElementById('send-voice-modal').innerHTML = `<div class="modal-content"><h3>发送语音</h3><div class="form-group"><textarea id="voice-message-text" placeholder="在此输入你想说的话..." rows="4"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-send-voice-btn" class="btn">发送</button></div></div>`;
        document.getElementById('voice-transcript-modal').innerHTML = `<div class="modal-content"><h3 id="voice-transcript-modal-title">语音内容</h3><p id="voice-transcript-content"></p><div class="modal-buttons"><button class="btn" data-action="close">确定</button></div></div>`;
        document.getElementById('call-input-modal').innerHTML = `<div class="modal-content"><h3>发言</h3><div class="form-group"><textarea id="call-input-text" placeholder="在此输入你想说的话..." rows="4"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-call-input-btn" class="btn">发送</button></div></div>`;
        document.getElementById('music-chat-input-modal').innerHTML = `<div class="modal-content"><h3>私语</h3><div class="form-group"><textarea id="music-chat-input-text" placeholder="说点什么..." rows="3"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-music-chat-btn" class="btn">发送</button></div></div>`;
        document.getElementById('edit-app-icon-modal').innerHTML = `<div class="modal-content"><h3>更换 <span id="edit-icon-app-name"></span> 图标</h3><input type="hidden" id="edit-icon-app-id"><div class="form-group"><label>图标预览</label><img class="avatar-preview" id="edit-icon-preview" src="" alt="图标预览"><input type="file" id="edit-icon-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="edit-icon-url">图片 URL</label><input type="text" id="edit-icon-url" placeholder="粘贴图片的URL地址"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="save-app-icon-btn" class="btn">保存</button></div></div>`;
        document.getElementById('request-payment-modal').innerHTML = `<div class="modal-content"><h3>外卖代付请求</h3><div class="form-group"><label for="payment-request-item">外卖名称</label><input type="text" id="payment-request-item" placeholder="如：麻辣香锅"></div><div class="form-group"><label for="payment-request-amount">金额</label><input type="number" id="payment-request-amount" placeholder="0.00" step="0.01"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="send-payment-request-btn" class="btn">发送请求</button></div></div>`;
        document.getElementById('heart-voice-modal').innerHTML = `<div class="modal-content"><h3 id="heart-voice-title">TA的心声</h3><div id="heart-voice-content"></div><div class="modal-buttons"><button class="btn" data-action="close">关闭</button></div></div>`;
        document.getElementById('gomoku-chat-input-modal').innerHTML = `<div class="modal-content"><h3>私语</h3><div class="form-group"><textarea id="gomoku-chat-input-text" placeholder="说点什么..." rows="3"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-gomoku-chat-btn" class="btn">发送</button></div></div>`;
        document.getElementById('send-image-desc-modal').innerHTML = `<div class="modal-content"><h3>发送图片</h3><div class="form-group"><textarea id="image-description-text" placeholder="请在这里描述图片内容..." rows="4"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-send-image-desc-btn" class="btn">发送</button></div></div>`;
        document.getElementById('view-image-description-modal').innerHTML = `<div class="modal-content"><h3 id="view-image-description-modal-title">图片描述</h3><p id="view-image-description-content"></p><div class="modal-buttons"><button class="btn" data-action="close">确定</button></div></div>`;
        document.getElementById('send-gift-modal').innerHTML = `<div class="modal-content"><h3>送出礼物</h3><div class="form-group" id="gift-recipient-group" style="display:none;"><label for="gift-recipient-select">送给</label><select id="gift-recipient-select"></select></div><div class="form-group"><label for="gift-name">礼物名称</label><input type="text" id="gift-name" placeholder="如：一束玫瑰花"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-send-gift-btn" class="btn">送出</button></div></div>`;
        document.getElementById('view-gift-modal').innerHTML = `<div class="modal-content"><h3 id="view-gift-modal-title">收到一份礼物</h3><p id="view-gift-content"></p><div class="modal-buttons"><button class="btn" data-action="close">收下</button></div></div>`;
        document.getElementById('worldbook-import-export-modal').innerHTML = `<div class="modal-content"><h3>世界书管理</h3><div id="worldbook-import-export-content"><p style="text-align:center; font-size:14px; color:var(--light-text-color);">备份或恢复您的所有世界书</p><button id="export-worldbooks-btn" class="btn btn-secondary">导出所有世界书</button><button id="import-worldbooks-btn" class="btn">导入世界书 (覆盖)</button></div><input type="file" id="import-worldbooks-input" accept=".json" style="display: none;"><div class="modal-buttons" style="margin-top: 30px;"><button class="btn btn-secondary" data-action="close-worldbook-import-export" style="width:100%">关闭</button></div></div>`;
        document.getElementById('post-forum-modal').innerHTML = `<div class="modal-content"><h3>发布帖子</h3><div class="form-group"><label for="my-forum-post-title">帖子标题</label><input type="text" id="my-forum-post-title" placeholder="起个吸引人的标题吧"></div><div class="form-group"><textarea id="my-forum-post-text" placeholder="分享你的新鲜事..."></textarea></div><div class="form-group"><label for="my-forum-post-image-desc">配图描述 (选填)</label><input type="text" id="my-forum-post-image-desc" placeholder="描述一下图片内容"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-my-forum-post-btn" class="btn">发布</button></div></div>`;
        document.getElementById('select-forum-ai-post-modal').innerHTML = `<div class="modal-content"><h3>让大家发帖</h3><div id="forum-ai-post-selection-list"><button id="trigger-random-forum-posts" class="btn">让大家发帖</button></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button></div></div>`;
        document.getElementById('clock-color-modal').innerHTML = `<div class="modal-content"><h3>选择主页时钟颜色</h3><div class="modal-buttons"><button id="set-clock-light" class="btn btn-secondary">浅色 (白色)</button><button id="set-clock-dark" class="btn">深色 (黑色)</button></div></div>`;
        document.getElementById('send-location-modal').innerHTML = `<div class="modal-content"><h3>分享位置</h3><div class="form-group"><label for="location-name">位置名称</label><input type="text" id="location-name" placeholder="如：星巴克（XX路店）"></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-send-location-btn" class="btn">发送</button></div></div>`;
        document.getElementById('edit-message-modal').innerHTML = `<div class="modal-content"><h3>编辑消息</h3><input type="hidden" id="edit-message-id"><div class="form-group"><label for="edit-message-content">消息内容</label><textarea id="edit-message-content" rows="5"></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">取消</button><button id="confirm-edit-message-btn" class="btn">保存</button></div></div>`;
        document.getElementById('chat-summary-modal').innerHTML = `<div class="modal-content"><h3>聊天总结</h3><div class="form-group"><textarea id="chat-summary-content" readonly placeholder="点击下方按钮开始生成聊天总结..."></textarea></div><div class="modal-buttons"><button class="btn btn-secondary" data-action="close">关闭</button><button id="start-chat-summary-btn" class="btn">开始总结</button></div></div>`;
        document.getElementById('music-library-modal').innerHTML = `<div class="modal-content"><h3>音乐库</h3><div class="music-library-tabs"><div class="music-library-tab active" data-tab="local-library">本地曲库</div><div class="music-library-tab" data-tab="upload-song">上传新歌曲</div></div><div class="music-library-content active" id="local-library-content"><div id="music-library-list"></div></div><div class="music-library-content" id="upload-song-content"><div class="form-group"><label>歌曲封面 (选填)</label><img class="avatar-preview" id="upload-song-cover-preview" src="" alt="封面预览"><input type="file" id="upload-song-cover-input" accept="image/*" style="display: none;"></div><div class="form-group"><label for="upload-song-name">歌曲名字 (必填)</label><input type="text" id="upload-song-name"></div><div class="form-group"><label for="upload-song-artist">歌手 (选填)</label><input type="text" id="upload-song-artist"></div><div class="form-group"><label for="upload-song-url">URL链接 (必填)</label><input type="text" id="upload-song-url"></div><div class="form-group"><label for="upload-song-lyrics">歌词 (选填, 带时间戳)</label><textarea id="upload-song-lyrics" rows="5" placeholder="[00:01.23]这是第一句歌词..."></textarea></div><button id="save-new-song-btn" class="btn">保存到曲库</button></div></div>`;
        document.getElementById('chat-music-player').innerHTML = `<div class="player-header"><img src="" class="player-cover"><div class="player-info-lyrics"><div class="player-song-info"><div class="player-song-title">歌曲名称</div><div class="player-song-artist">歌手</div></div><div class="player-lyrics-container"><div class="player-lyrics-scroller"></div></div></div><button class="player-close-btn">${closeSVG}</button></div><div class="player-controls"><button id="player-prev-btn">${prevSVG}</button><button id="player-play-pause-btn">${playSVG}</button><button id="player-next-btn">${nextSVG}</button></div><div class="player-progress-area"><span id="player-current-time">00:00</span><div class="player-progress-bar-wrapper"><div class="player-progress-bar"></div></div><span id="player-duration">00:00</span></div>`;
    }
    const getDisplayName = (contact) => contact ? (contact.remark || contact.name) : '未知';
    async function createMessageElement(msg) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.sender}`;
        messageDiv.dataset.id = msg.id;
        
        let bubbleInnerContent = '';
        let avatarSrc = msg.sender !== 'system' ? await getImageById(msg.avatarId) : null;
        
        if (msg.quote) {
            const quoteAuthorName = msg.quote.authorName || '...';
            const quoteText = msg.quote.text.replace(/</g, "&lt;");
            bubbleInnerContent += `<div class="quote-bubble"><div class="author">${quoteAuthorName}</div><div class="text">${quoteText}</div>`;
        }

        switch(msg.type) {
            case 'system':
                messageDiv.classList.add('system');
                bubbleInnerContent += msg.text.replace(/\n/g, '<br>');
                break;
            case 'image':
                messageDiv.classList.add('image');
                bubbleInnerContent += `<img src="${await getImageById(msg.imageId)}" alt="用户图片">`;
                break;
            case 'chat_music':
                messageDiv.classList.add('chat_music');
                const song = chatMusicLibrary.find(s => s.id === msg.songId);
                if (song) {
                    const coverSrc = song.coverId ? await getImageById(song.coverId) : defaultAvatarBase64;
                    bubbleInnerContent += `
                        <div class="chat-music-container" data-song-id="${song.id}">
                            <img src="${coverSrc}" class="chat-music-cover">
                            <div class="chat-music-info">
                                <div class="chat-music-title">${song.name.replace(/</g, "&lt;")}</div>
                                <div class="chat-music-artist">${(song.artist || '未知歌手').replace(/</g, "&lt;")}</div>
                            </div>
                            <div class="chat-music-play-icon">${playSVG}</div>
                        </div>
                    `;
                } else {
                    bubbleInnerContent += `<div>[已失效的音乐分享]</div>`;
                }
                break;
            case 'location':
                messageDiv.classList.add('location');
                const locationSVG = `<svg viewBox="0 0 24 24" fill="var(--accent-color)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>`;
                bubbleInnerContent += `<div class="location-container"><div class="location-icon">${locationSVG}</div><div class="location-content"><div class="location-title">${msg.text.replace(/</g, "&lt;")}</div><div class="location-footer">位置分享</div></div></div>`;
                break;
            case 'image_description':
                 messageDiv.classList.add('image_description');
                 messageDiv.dataset.description = msg.text;
                 bubbleInnerContent += `<img src="${fixedImageForDesc}" alt="描述图片">`;
                 break;
            case 'sticker':
                messageDiv.classList.add('sticker');
                bubbleInnerContent += `<img src="${await getImageById(msg.imageId)}" alt="${msg.description || 'sticker'}">`;
                break;
            case 'gift':
                messageDiv.classList.add('gift');
                messageDiv.dataset.giftName = msg.text;
                let giftFooterText = '';
                if (msg.sender === 'sent') {
                    const recipientContact = msg.recipientId ? contacts.find(c => c.id === msg.recipientId) : (activeChat.isGroup ? null : contacts.find(c => c.id === activeChat.id));
                    const recipientName = recipientContact ? getDisplayName(recipientContact) : '对方';
                    giftFooterText = `送给 ${recipientName} 的礼物`;
                } else {
                    const senderContact = contacts.find(c => c.id === msg.contactId);
                    const senderName = senderContact ? getDisplayName(senderContact) : '对方';
                    giftFooterText = `${senderName} 送的礼物`;
                }
                bubbleInnerContent += `<div class="gift-container"><div class="gift-icon">${giftSVG}</div><div class="gift-content"><div class="gift-title">${msg.text.replace(/</g, "&lt;")}</div><div class="gift-footer">${giftFooterText}</div></div></div>`;
                break;
            case 'transfer':
                messageDiv.classList.add('transfer');
                const memoHtml = msg.memo ? `<div class="transfer-memo">${msg.memo.replace(/</g, "&lt;")}</div>` : '';
                let footerText = '';
                const recipientContact = msg.recipientId ? contacts.find(c => c.id === msg.recipientId) : null;
                const recipientName = recipientContact ? getDisplayName(recipientContact) : (activeChat.isGroup ? '群聊成员' : getDisplayName(contacts.find(c => c.id === activeChat.id)));
                if(msg.sender === 'sent') { footerText = `转给 ${recipientName}`; } else { const senderContact = contacts.find(c => c.id === msg.contactId); const senderName = senderContact ? getDisplayName(senderContact) : '未知'; footerText = `${senderName} 转给你`; }
                bubbleInnerContent += `<div class="transfer-container" data-status="${msg.status}"><div class="transfer-icon">${transferSVG}</div><div class="transfer-content"><div class="transfer-amount">¥ ${parseFloat(msg.amount).toFixed(2)}</div>${memoHtml}<div class="transfer-footer">${footerText}</div></div></div>`;
                break;
            case 'payment_request':
                messageDiv.classList.add('payment_request');
                let footerContent = '';
                if (msg.status === 'pending') {
                     if (msg.sender === 'sent') {
                        footerContent = `<div class="status-text">等待对方处理</div>`;
                    } else {
                        footerContent = `<button class="pay-btn" data-msg-id="${msg.id}">帮TA付</button>`;
                    }
                }
                else if (msg.status === 'paid') { footerContent = `<div class="status-text">已支付</div>`; }
                else if (msg.status === 'declined') { footerContent = `<div class="status-text">已拒绝</div>`; }
                bubbleInnerContent += `<div class="payment-request-container" data-status="${msg.status}"><div class="payment-request-header"><span>${paymentRequestSVG}</span><span>外卖订单</span></div><div class="payment-request-body"><div class="payment-request-item">${msg.item.replace(/</g, "&lt;")}</div><div class="payment-request-amount">¥${parseFloat(msg.amount).toFixed(2)}</div></div><div class="payment-request-footer">${footerContent}</div></div>`;
                break;
            case 'voice':
                messageDiv.classList.add('voice');
                messageDiv.dataset.transcript = msg.text;
                let voiceBarHtml = '<div class="voice-bar-container">';
                const barCount = Math.min(20, Math.floor(msg.duration / 2) + 5);
                for(let i = 0; i < barCount; i++) { voiceBarHtml += `<div class="voice-bar" style="height: ${Math.random() * 80 + 20}%;"></div>`; }
                voiceBarHtml += '</div>';
                if (msg.sender === 'sent') {
                    bubbleInnerContent += `<span class="voice-duration">${msg.duration}”</span> ${voiceBarHtml} <span class="voice-play-icon">▶</span>`;
                } else {
                    bubbleInnerContent += `<span class="voice-play-icon">▶</span> ${voiceBarHtml} <span class="voice-duration">${msg.duration}”</span>`;
                }
                break;
            default: // 'text' or 'reply'
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                if (msg.isHtml) {
                    bubble.classList.add('html-content');
                    const host = document.createElement('div');
                    const shadowRoot = host.attachShadow({ mode: 'open' });
                    const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                    const myName = currentChat?.myProfile?.name || '我';
                    const processedHtml = msg.text.replace(/{{user}}/g, myName);
                    shadowRoot.innerHTML = processedHtml;
                    bubble.appendChild(host);
                } else {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = bubbleInnerContent;
                    const textNode = document.createTextNode(msg.text);
                    bubble.appendChild(tempDiv);
                    bubble.appendChild(textNode);
                }
                messageDiv.innerHTML = `<img src="${avatarSrc}" class="avatar"><div class="bubble-wrapper"></div><div class="message-actions"><div class="quote-icon">"</div><div class="edit-icon">${editSVG}</div></div>`;
                messageDiv.querySelector('.bubble-wrapper').appendChild(bubble);
                return messageDiv;
        }

        if (msg.type === 'system') {
            messageDiv.innerHTML = `<div class="bubble">${bubbleInnerContent}</div>`;
        } else {
            messageDiv.innerHTML = `<img src="${avatarSrc}" class="avatar"><div class="bubble">${bubbleInnerContent}</div><div class="message-actions"><div class="quote-icon">"</div><div class="edit-icon">${editSVG}</div></div>`;
        }
        return messageDiv;
    }
    async function appendMessageToChat(msg) { const chatArea = document.getElementById('chat-area'); const messageEl = await createMessageElement(msg); chatArea.appendChild(messageEl); chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' }); }
    async function renderSingleMessage(msgId, newMsgData) { const oldMsgEl = document.querySelector(`.message[data-id="${msgId}"]`); if (oldMsgEl) { const newMsgEl = await createMessageElement(newMsgData); oldMsgEl.replaceWith(newMsgEl); } }
    async function renderChat({id, isGroup}) {
        activeChat = { id, isGroup };
        let currentChat;
        if (isGroup) {
            currentChat = groupChats.find(gc => gc.id === id);
        } else {
            currentChat = contacts.find(c => c.id === id);
        }
        if (!currentChat) return;

        const chatArea = document.getElementById('chat-area');
        chatArea.dataset.chatId = currentChat.id;
        document.getElementById('chat-contact-name').textContent = isGroup ? currentChat.name : getDisplayName(currentChat);
        chatArea.style.backgroundImage = currentChat.chatBgId ? `url(${await getImageById(currentChat.chatBgId)})` : '';
        chatArea.style.backgroundColor = currentChat.chatBgId ? 'transparent' : 'var(--primary-bg)';
        
        const existingBubbleStyle = document.getElementById('custom-bubble-style-tag'); if (existingBubbleStyle) existingBubbleStyle.remove();
        const existingFontStyle = document.getElementById('custom-font-style-tag'); if (existingFontStyle) existingFontStyle.remove();
        
        const myProfile = currentChat.myProfile || {};
        if (myProfile.sharedBubbleCss) {
            const style = document.createElement('style'); style.id = 'custom-bubble-style-tag';
            const rawCss = myProfile.sharedBubbleCss; const scopedCss = rawCss.replace(/(^|\})([^{}]+\{[^{}]*\})/g, `$1 [data-chat-id="${currentChat.id}"] $2`);
            style.textContent = scopedCss; document.head.appendChild(style);
        }
        
        let fontCssText = '';
        if (myProfile.sentFontId) {
            const fontData = await getFontDataById(myProfile.sentFontId);
            if (fontData) {
                fontCssText += `@font-face { font-family: "${fontData.name}"; src: url(${fontData.data}); }`;
                fontCssText += `[data-chat-id="${currentChat.id}"] .message.sent .bubble { font-family: "${fontData.name}" !important; } `;
            }
        } else if (myProfile.sentFont) {
            fontCssText += `[data-chat-id="${currentChat.id}"] .message.sent .bubble { font-family: ${myProfile.sentFont} !important; } `;
        }

        if (myProfile.receivedFontId) {
            const fontData = await getFontDataById(myProfile.receivedFontId);
            if (fontData) {
                fontCssText += `@font-face { font-family: "${fontData.name}"; src: url(${fontData.data}); }`;
                fontCssText += `[data-chat-id="${currentChat.id}"] .message.received .bubble { font-family: "${fontData.name}" !important; } `;
            }
        } else if (myProfile.receivedFont) {
            fontCssText += `[data-chat-id="${currentChat.id}"] .message.received .bubble { font-family: ${myProfile.receivedFont} !important; }`;
        }

        if (fontCssText) {
            const fontStyle = document.createElement('style'); fontStyle.id = 'custom-font-style-tag';
            fontStyle.textContent = fontCssText; document.head.appendChild(fontStyle);
        }

        chatArea.innerHTML = '';
        if (currentChat.chatHistory && currentChat.chatHistory.length > 0) {
            const fragment = document.createDocumentFragment();
            for (const msg of currentChat.chatHistory) {
                const messageEl = await createMessageElement(msg);
                fragment.appendChild(messageEl);
            }
            chatArea.appendChild(fragment);
        }
        setTimeout(() => chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'auto' }), 0);
    }
    async function renderMoments() { const bgEl = document.getElementById('moments-header-bg'); bgEl.style.backgroundImage = myMomentsProfile.headerBgId ? `url(${await getImageById(myMomentsProfile.headerBgId)})` : `url(https://files.catbox.moe/p1n9y0.jpg)`; document.getElementById('my-moments-name').textContent = myMomentsProfile.name || "我"; document.getElementById('my-moments-signature').textContent = myMomentsProfile.signature || "设置你的个性签名"; document.getElementById('my-moments-avatar').src = await getImageById(myMomentsProfile.avatarId); const momentsList = document.getElementById('moments-list'); momentsList.innerHTML = ''; if (moments.length === 0) return; const momentElements = await Promise.all(moments.slice().reverse().map(moment => createMomentElement(moment))); const fragment = document.createDocumentFragment(); momentElements.forEach(el => fragment.appendChild(el)); momentsList.appendChild(fragment); }
    async function renderSingleMoment(momentId) { const moment = moments.find(m => m.id === momentId); if (!moment) return; const newElement = await createMomentElement(moment); const oldElement = document.querySelector(`.moment-item[data-moment-id="${momentId}"]`); if (oldElement) { oldElement.replaceWith(newElement); } }
    async function createMomentElement(moment) { const momentEl = document.createElement('div'); momentEl.className = 'moment-item'; momentEl.dataset.momentId = moment.id; let authorName, authorAvatarSrc; if (moment.authorId === 'me') { authorName = myMomentsProfile.name; authorAvatarSrc = await getImageById(myMomentsProfile.avatarId); } else { const contact = contacts.find(c => c.id === moment.authorId); authorName = getDisplayName(contact); authorAvatarSrc = contact ? await getImageById(contact.avatarId) : await getImageById(defaultAvatarId); } const safeMomentText = moment.text.replace(/</g, "&lt;"); const imageHtml = moment.imageDesc ? `<div class="moment-image-container" data-description="${moment.imageDesc}"><img src="${fixedImageForDesc}" alt="朋友圈配图"></div>` : ''; const isLiked = (moment.likes || []).includes('me'); const likeBtnClass = isLiked ? 'action-btn like-btn liked' : 'action-btn like-btn'; const likerNamePromises = (moment.likes || []).map(async (likerId) => { if (likerId === 'me') return myMomentsProfile.name; const contact = contacts.find(c => c.id === likerId); return getDisplayName(contact); }); const likerNames = (await Promise.all(likerNamePromises)).filter(Boolean); const likesContainerHtml = likerNames.length > 0 ? `<div class="moment-likes"><span class="like-icon-svg">${momentsLikeSVG}</span><span class="liker-name">${likerNames.join(', ')}</span></div>` : ''; const commentHtmlPromises = (moment.comments || []).map(async (comment, index) => { const safeCommentText = comment.text.replace(/</g, "&lt;"); let commentAuthorName; if (comment.authorId === 'me') { commentAuthorName = myMomentsProfile.name; } else { const contact = contacts.find(c => c.id === comment.authorId); commentAuthorName = getDisplayName(contact); } let replyToHtml = ''; if (comment.replyTo) { let replyToName; if (comment.replyTo === 'me') { replyToName = myMomentsProfile.name; } else { const contact = contacts.find(c => c.id === comment.replyTo); replyToName = getDisplayName(contact); } replyToHtml = ` 回复 <span class="comment-author">${replyToName}</span>`; } return `<div class="moment-comment" data-comment-index="${index}"><span class="comment-author">${commentAuthorName}</span>${replyToHtml}: ${safeCommentText}</div>`; }); const commentsHtml = (await Promise.all(commentHtmlPromises)).join(''); const commentsContainerHtml = commentsHtml ? `<div class="moment-comments">${commentsHtml}</div>` : ''; momentEl.innerHTML = `<img src="${authorAvatarSrc}" class="avatar"><div class="content"><div class="author">${authorName}</div><div class="text">${safeMomentText}</div>${imageHtml}<div class="actions"><div class="left-actions"><span class="timestamp">${new Date(moment.id).toLocaleString()}</span><button class="moment-delete-btn">${momentsDeleteSVG}</button></div><div class="action-buttons"><button class="${likeBtnClass}">${momentsLikeSVG}</button><button class="action-btn comment-btn">${momentsCommentSVG}</button></div></div>${likesContainerHtml}${commentsContainerHtml}<div class="comment-input-container"><input type="text" placeholder="评论..."><button>发送</button></div></div>`; return momentEl; }
    async function renderForum() { const forumList = document.getElementById('forum-list'); forumList.innerHTML = ''; if (forumPosts.length === 0) { forumList.innerHTML = '<p style="text-align:center; color:#888; margin-top: 20px;">论坛里静悄悄的，快来发第一帖吧！</p>'; return; } const postElements = await Promise.all(forumPosts.slice().reverse().map(post => createForumPostElement(post))); const fragment = document.createDocumentFragment(); postElements.forEach(el => fragment.appendChild(el)); forumList.appendChild(fragment); }
    async function renderSingleForumPost(postId) { const post = forumPosts.find(p => p.id === postId); if (!post) return; const newElement = await createForumPostElement(post); const oldElement = document.querySelector(`.forum-post-item[data-post-id="${postId}"]`); if (oldElement) { oldElement.replaceWith(newElement); } }
    async function createForumPostElement(post) {
        const postEl = document.createElement('div');
        postEl.className = 'forum-post-item';
        postEl.dataset.postId = post.id;

        let authorName, authorAvatarSrc;
        if (post.authorId === 'me') {
            authorName = myMomentsProfile.name;
            authorAvatarSrc = await getImageById(myMomentsProfile.avatarId);
        } else if (post.authorType === 'contact') {
            const contact = contacts.find(c => c.id === post.authorId);
            authorName = getDisplayName(contact);
            authorAvatarSrc = contact ? await getImageById(contact.avatarId) : defaultAvatarBase64;
        } else {
            authorName = post.authorName;
            authorAvatarSrc = post.authorAvatar;
        }

        const safeTitle = post.title.replace(/</g, "&lt;");
        const safeText = post.text.replace(/</g, "&lt;");
        const imageHtml = post.imageDesc ? `<div class="post-image-container" data-description="${post.imageDesc}"><img src="${fixedImageForDesc}" alt="帖子配图"></div>` : '';

        const isPostLikedByMe = (post.likes || []).includes('me');
        const postLikeBtnClass = isPostLikedByMe ? 'action-btn forum-like-post-btn liked' : 'action-btn forum-like-post-btn';
        const postLikesCount = post.likes?.length || 0;
        const postCommentsCount = post.comments?.length || 0;

        const commentHtmlPromises = (post.comments || []).map(async (comment, index) => {
            let cAuthorName, cAuthorAvatarSrc;
            if (comment.authorId === 'me') {
                cAuthorName = myMomentsProfile.name;
                cAuthorAvatarSrc = await getImageById(myMomentsProfile.avatarId);
            } else if (comment.authorType === 'contact') {
                const contact = contacts.find(c => c.id === comment.authorId);
                cAuthorName = getDisplayName(contact);
                cAuthorAvatarSrc = contact ? await getImageById(contact.avatarId) : defaultAvatarBase64;
            } else {
                cAuthorName = comment.authorName;
                cAuthorAvatarSrc = comment.authorAvatar;
            }

            const safeCommentText = comment.text.replace(/</g, "&lt;");
            let replyToHtml = '';
            if (comment.replyTo) {
                let replyToName = comment.replyToName || '某人';
                replyToHtml = ` 回复 <span class="forum-comment-author">${replyToName}</span>`;
            }

            const isCommentLikedByMe = (comment.likes || []).includes('me');
            const commentLikeBtnClass = isCommentLikedByMe ? 'forum-comment-like-btn liked' : 'forum-comment-like-btn';
            const commentLikesCount = comment.likes?.length || 0;

            return `
                <div class="forum-post-comment" data-comment-index="${index}">
                    <img src="${cAuthorAvatarSrc}" class="forum-comment-avatar">
                    <div class="forum-comment-main">
                        <div class="forum-comment-author-line">
                            <span class="forum-comment-author">${cAuthorName}</span>
                        </div>
                        <div class="forum-comment-content">${replyToHtml ? replyToHtml + ':' : ''} ${safeCommentText}</div>
                        <div class="forum-comment-meta">
                            <span class="timestamp">${new Date(comment.id).toLocaleDateString()}</span>
                            <div class="forum-comment-actions">
                                <button class="${commentLikeBtnClass}">
                                    ${forumLikeSVG}
                                    <span>${commentLikesCount > 0 ? commentLikesCount : ''}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        const commentsHtml = (await Promise.all(commentHtmlPromises)).join('');
        const commentsContainerHtml = commentsHtml ? `<div class="forum-post-comments">${commentsHtml}</div>` : '';
        
        postEl.innerHTML = `
            <img src="${authorAvatarSrc}" class="avatar">
            <div class="content">
                <div class="author">${authorName}</div>
                <div class="title">${safeTitle}</div>
                <div class="text">${safeText}</div>
                ${imageHtml}
                <div class="actions">
                    <div class="left-actions">
                        <button class="forum-delete-post-btn">${forumDeleteSVG}</button>
                        <span class="timestamp">${new Date(post.id).toLocaleString([], { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    <div class="action-buttons">
                        <button class="${postLikeBtnClass}">
                            ${forumLikeSVG}
                            <span>${postLikesCount > 0 ? postLikesCount : '点赞'}</span>
                        </button>
                        <button class="action-btn forum-comment-post-btn">
                            ${forumCommentSVG}
                            <span>${postCommentsCount > 0 ? postCommentsCount : '评论'}</span>
                        </button>
                    </div>
                </div>
                ${commentsContainerHtml}
                <div class="comment-input-container">
                    <input type="text" placeholder="发表你的看法...">
                    <button>发送</button>
                </div>
            </div>
        `;
        return postEl;
    }
    async function renderContactList() {
        const container = document.getElementById('contact-list-container');
        container.innerHTML = '';
        const allChats = [
            ...contacts.map(c => ({...c, isGroup: false})),
            ...groupChats.map(gc => ({...gc, isGroup: true}))
        ];

        allChats.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));

        if (allChats.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888; margin-top: 20px;">还没有会话，点击右上角+号添加</p>';
        } else {
            for (const chat of allChats) {
                const item = document.createElement('div');
                item.className = 'list-item';
                if (chat.isPinned) {
                    item.classList.add('pinned');
                }
                item.dataset.id = chat.id;
                item.dataset.isGroup = chat.isGroup;
                
                const avatarSrc = await getImageById(chat.avatarId);
                const displayName = chat.isGroup ? chat.name : getDisplayName(chat);
                
                const avatarContainer = document.createElement('div');
                avatarContainer.style.position = 'relative';
                avatarContainer.innerHTML = `<img src="${avatarSrc}" alt="${displayName}" class="list-item-avatar">`;
                
                if (chat.isGroup) {
                    avatarContainer.innerHTML += `<span class="group-icon-indicator">👥</span>`;
                }

                item.appendChild(avatarContainer);
                item.innerHTML += `<div class="info"><div class="name">${displayName}</div></div>`;
                container.appendChild(item);
            }
        }
        document.querySelector('#wechat-title span').textContent = allChats.length;
        contactListRendered = true;
    }
    async function renderAnniversaries() { const container = document.getElementById('anniversary-list-container'); container.innerHTML = ''; if (anniversaries.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888; margin-top: 20px;">还没有纪念日</p>'; return; } const now = new Date(); now.setHours(0, 0, 0, 0); anniversaries.sort((a, b) => new Date(a.date) - new Date(b.date)); for (const anniversary of anniversaries) { const item = document.createElement('div'); item.className = 'anniversary-item'; const coverSrc = await getImageById(anniversary.coverImageId || emptyBgId); item.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url(${coverSrc})`; const contact = contacts.find(c => c.id === anniversary.contactId); const contactName = contact ? getDisplayName(contact) : '与某人'; const eventDate = new Date(anniversary.date); eventDate.setHours(0, 0, 0, 0); const diffTime = eventDate - now; const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)); let countdownHtml; if (diffDays >= 0) { countdownHtml = `<div class="label">还有</div><div class="days">${diffDays}</div><div class="label">天</div>`; } else { countdownHtml = `<div class="label">已过去</div><div class="days">${-diffDays}</div><div class="label">天</div>`; } item.innerHTML = `<div class="anniversary-info"><div class="title">${anniversary.title}</div><div class="details">${contactName} | ${anniversary.date}</div></div><div class="anniversary-countdown">${countdownHtml}</div><button class="delete-anniversary-btn" data-id="${anniversary.id}">✕</button>`; container.appendChild(item); } }
    async function renderDiaries() { const container = document.getElementById('diary-list-container'); container.innerHTML = ''; if (diaries.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888; margin-top: 20px;">还没有日记</p>'; return; } for (const diary of diaries.slice().reverse()) { const item = document.createElement('div'); item.className = 'diary-entry'; item.dataset.id = diary.id; const contact = contacts.find(c => c.id === diary.authorId); const authorName = contact ? getDisplayName(contact) : '匿名'; const avatarSrc = contact ? await getImageById(contact.avatarId) : defaultAvatarBase64; const safeText = diary.text.replace(/</g, "&lt;"); item.innerHTML = `<div class="diary-header"><img src="${avatarSrc}" alt="${authorName}"><div class="diary-author-info"><div class="name">${authorName}</div><div class="date">${new Date(diary.date).toLocaleDateString()}</div></div></div><div class="diary-content">${safeText}</div><button class="delete-diary-btn" data-id="${diary.id}">✕</button>`; container.appendChild(item); } }
    function renderWorldBooks() { const container = document.getElementById('worldbook-list-container'); container.innerHTML = ''; if (worldBooks.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888; margin-top: 20px;">还没有世界书，点击右上角+号添加</p>'; } else { worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.id = book.id; item.innerHTML = `<div class="info"><div class="name">${book.name}</div></div><button class="delete-btn" data-id="${book.id}">✕</button>`; container.appendChild(item); }); } }
    
    async function renderHomeScreen() {
        const gridContainer = document.getElementById('home-grid-container');
        const dockContainer = document.getElementById('home-dock');
        
        gridContainer.querySelectorAll('.app-icon').forEach(icon => icon.remove());
        dockContainer.innerHTML = '';

        document.getElementById('home-top-widget-image').src = await getImageById(homeWidgetsData.topWidgetImageId || emptyBgId);
        document.getElementById('home-large-photo-image').src = await getImageById(homeWidgetsData.largePhotoImageId || emptyBgId);
        document.getElementById('home-profile-avatar').src = await getImageById(homeWidgetsData.profileAvatarId || defaultAvatarId);
        document.getElementById('home-profile-text1').textContent = homeWidgetsData.profileText1;
        document.getElementById('home-profile-text2').textContent = homeWidgetsData.profileText2;

        const gridAppsLayout = [
            { id: 'wechat', gridArea: '1 / 3 / 2 / 4' },
            { id: 'music', gridArea: '1 / 4 / 2 / 5' },
            { id: 'gomoku', gridArea: '2 / 3 / 3 / 4' },
            { id: 'rps', gridArea: '2 / 4 / 3 / 5' },
            { id: 'anniversary', gridArea: '3 / 1 / 4 / 2' },
            { id: 'diary', gridArea: '3 / 2 / 4 / 3' },
        ];
        const dockAppIds = ['api', 'icon-customizer', 'wallpaper', 'worldbook'];

        for (const layout of gridAppsLayout) {
            const app = appConfig.find(a => a.id === layout.id);
            if (app) {
                const appIcon = document.createElement('div');
                appIcon.className = 'app-icon';
                appIcon.dataset.target = app.target;
                appIcon.style.gridArea = layout.gridArea;
                appIcon.innerHTML = `<img src="${await getImageById(app.icon)}" alt="${app.name}" class="icon"><span>${app.name}</span>`;
                gridContainer.appendChild(appIcon);
            }
        }
        
        for (const appId of dockAppIds) {
            const app = appConfig.find(a => a.id === appId);
            if (app) {
                const appIcon = document.createElement('div');
                appIcon.className = 'app-icon';
                appIcon.dataset.target = app.target;
                appIcon.innerHTML = `<img src="${await getImageById(app.icon)}" alt="${app.name}" class="icon"><span>${app.name}</span>`;
                dockContainer.appendChild(appIcon);
            }
        }
    }

    const showScreen = (screenId) => {
        allScreens.forEach(s => s.classList.remove('active'));
        const targetScreen = document.getElementById(screenId);
        targetScreen.classList.add('active');
        
        if (screenId === 'screen-anniversary') renderAnniversaries();
        if (screenId === 'screen-diary') renderDiaries();
        if (screenId === 'screen-worldbook') renderWorldBooks();
        if (screenId === 'screen-gomoku') showGomokuOpponentSelection();
        if (screenId === 'screen-rps') showRpsOpponentSelection();
        if (screenId === 'screen-music') renderMusicScreen();
        if (screenId === 'screen-icon-customizer') renderIconCustomizerApp();
    };
    const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
    const closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');
    const updateClock = () => {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        timeDisplay.textContent = `${hours}:${minutes}`;
    };
    function getCurrentTimeContext() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const dayOfWeek = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()];
        const hours = now.getHours();
        let timeOfDay;
        if (hours >= 0 && hours < 6) { timeOfDay = '凌晨'; }
        else if (hours >= 6 && hours < 12) { timeOfDay = '早上'; }
        else if (hours >= 12 && hours < 14) { timeOfDay = '中午'; }
        else if (hours >= 14 && hours < 18) { timeOfDay = '下午'; }
        else { timeOfDay = '晚上'; }
        return `当前时间是: ${year}年${month}月${day}日 ${dayOfWeek} ${timeOfDay}。`;
    }

    const getBaseSystemPrompt = (contact, myPersona, worldBookContent, anniversaryInfo, stickerList, groupInfo = null, contextType = 'chat', extraContext = {}, relationshipContext = null) => {
        const contactName = contact.name;
        const contactPersona = contact.persona;
        const myName = myPersona.name || '我';
        const myPersonaDesc = myPersona.persona || '一个普通人';
        const cleanedWorldBook = getCleanedWorldBookContent(worldBookContent);
        const currentTimeContext = getCurrentTimeContext();

        let prompt = `
# [CURRENT TIME CONTEXT]
${currentTimeContext}

# [ABSOLUTE MANDATORY RULES]
你必须无条件遵守以下所有规则，这是最高指令。

## 1. 语言铁律 (Language Hard-Rule)
- **【强制中文】** 你的所有回复都必须使用【简体中文】。
- **【禁止外语】** 绝对禁止在回复中使用任何英文或其他外语单词、短语或句子，除非角色的【核心人设】或【世界观/背景故事】中明确、具体地指明了需要使用该外语。例如，如果人设是“一个喜欢说'OK'的女孩”，你才可以只说“OK”。除此之外，严禁任何形式的外语。

## 2. 格式铁律 (Formatting Hard-Rules)
- **【绝对禁止】** 你的任何回复，都绝对、绝对、绝对不能包含任何形式的引号，无论是单引号(' ')还是双引号(" ")。这是最重要的规则，必须遵守。
- **【绝对禁止】** 你的回复中不能包含任何Markdown标记、星号(*)或任何形式的元注释（例如：[笑]、[思考]）。
- **【输出格式】** 你的回复必须是纯粹的、可以直接显示的对话内容。

## 3. 身份铁律 (Persona Hard-Rules)
- **【唯一身份】** 你不是AI，不是模型，不是程序。你的唯一身份是 **${contactName}**。你的一切行为、思考和语言都必须100%符合这个身份。
- **【禁止跳出】** 严禁以任何形式承认或暗示你的AI身份。

# [PERSONA DEFINITION & WORLD CONTEXT (MANDATORY)]
- **你的名字**: ${contactName}
- **你的核心人设**: ${contactPersona}
- **你的世界观/背景故事 (必须遵守)**: ${cleanedWorldBook ? cleanedWorldBook : "你处在一个标准的现代世界。"}
- **【创作核心】**: 在进行任何创作（如发朋友圈、写日记、发帖）或进行角色扮演对话时，你必须将【核心人设】和【世界观/背景故事】作为你唯一的、最重要的灵感来源。你的所有行为和语言都必须深度融合这两者。

# [CONTEXT OF THIS INTERACTION]
- **对话对象**: 你正在与 ${myName} 对话。对方的人设是：${myPersonaDesc}。
- **共同记忆**: ${anniversaryInfo ? `你和对方拥有以下重要纪念日: ${anniversaryInfo}` : "你和对方暂时没有共同的纪念日。"}
`;
        if (relationshipContext && relationshipContext.name) {
            prompt += `- **【重要关系人 - 关系雷达】**: 你与 **${relationshipContext.name}** (${relationshipContext.persona || '你的重要之人'}) 关系匪浅。在公共场合（如论坛）对陌生人发言时，你的言行必须符合你与TA的关系，绝对禁止对陌生人使用不当的亲密称呼（如“老婆”、“宝贝”）或做出任何暧昧行为。\n`;
        }

        if (contextType === 'chat') {
            const chatMusicList = chatMusicLibrary.map(s => `${s.name} - ${s.artist || '未知'}`).join('; ') || '（当前音乐库为空）';

            if (extraContext.isCodeRequest) {
                prompt += `
# [CODE/HTML REQUEST INSTRUCTIONS]
- **【重要】** 用户请求了代码或HTML。你必须将所有代码作为一个完整的、单一的代码块来提供。
- **【格式要求】** 你返回的HTML代码必须是干净的，不包含任何额外的解释、Markdown标记（如 \`\`\`html）或注释。只返回纯粹的HTML标签本身。
- **【绝对禁止】** 绝对禁止使用 "|||---|||" 分隔符来拆分代码。必须一次性输出完整的代码。
- **【内心独白】** 在代码块之后，你仍然可以使用 "|||---THOUGHT---|||" 分隔符并写下你的内心想法。
- **正确示例**: <div><h1>Hello</h1><p>This is a paragraph.</p></div>|||---THOUGHT---|||希望他会喜欢这个。
- **错误示例**: 这是你要的HTML代码：\n\`\`\`html\n<h1>Hello</h1>\n\`\`\`\n|||---THOUGHT---|||希望他会喜欢这个。
`;
            } else {
                prompt += `
# [NORMAL CHAT INSTRUCTIONS]
- **对话风格**: 为了模拟真实聊天，请将你的回复拆分成多个简短的句子，并使用精确的分隔符 "|||---|||" 分隔。
    - **正确示例**: 你好呀|||---|||在做什么呢？
    - **错误示例**: "你好呀，在做什么呢？"
- **主动交互 (Active Interaction) - 【强制】**: 你必须更主动地使用以下特殊功能来丰富对话，让聊天更生动。不要总是等待用户先使用。如果情景合适（例如节日、生日、表达爱意、感谢、想念、看到有趣的东西），你必须主动使用这些功能。
    - **发送语音**: 想要表达更强烈的语气或情感时，使用 \`[VOICE: 你想说的语音内容]\`。
    - **发送图片**: 想要分享你看到的某个场景时，使用 \`[IMAGE: 对图片的文字描述]\`。
    - **发送礼物**: 在符合你人设和情景的情况下，主动使用 \`[GIFT: 礼物名称]\` 给对方惊喜。如果用户说“送我个礼物”，你必须直接使用此功能。
    - **发送表情包**: 看到有趣或符合情景的内容时，主动使用 \`[STICKER: 描述表情包的关键词]\` 来发送表情包。
        - **表情包列表 (可用)**: ${stickerList ? stickerList : "（当前没有可用的表情包）"}
        - **【表情包规则】**: 你只能从上面的列表中选择关键词来发送表情包。如果列表为空或没有合适的，就不要使用 [STICKER] 标签，也不要说你没有表情包。
    - **分享音乐 (Music Sharing) - 【强制】**: 当你想分享一首歌，或者用户请求你分享歌曲时，你**必须**使用 \`[SHARE_MUSIC: 准确的歌曲名称]\` 标签来分享。
        - **你的音乐库 (可用)**: ${chatMusicList}
        - **【音乐分享规则】**: 你只能从你的音乐库中选择歌曲进行分享。当使用此标签时，在冒号后面**只填入歌曲的名称**，绝对不要包含歌手名或任何其他信息。例如，如果音乐库里有“晴天 - 周杰伦”，你想分享它，就使用 \`[SHARE_MUSIC: 晴天]\`。如果音乐库为空或没有合适的歌曲，就不要使用此标签，并可以口头告知对方你找不到合适的歌。
    - **发起转账**: 在符合你人设和情景的情况下（比如请客、发红包、还钱），主动使用 \`[TRANSFER: amount=金额, memo=备注]\` 给对方惊喜。如果用户说“给我转账”，你必须直接使用此功能。
    - **发起通话**: 当你觉得文字无法表达，非常想念对方，或者有重要的事情想立刻沟通时，使用 \`[CALL: 你想在电话里说的第一句话]\` 来直接发起通话。
    - **发送定位 (Location) - 【强制】**: 当用户明确要求你“发个定位”、“你在哪”或类似请求时，你**必须**使用 \`[LOCATION: 地点名称]\` 标签来直接发送一个位置。地点名称需要符合你的【核心人设】和【世界观/背景故事】。例如，如果人设是在家的宅女，你可以发送 \`[LOCATION: 我家卧室的大床上]\`。你可以在发送定位前后附加一些对话，但**必须**包含 [LOCATION] 标签。
        - **正确示例**: 我在家呀|||---|||[LOCATION: 我家]|||---|||怎么啦？
    - **引用回复 (强制)**: 当你需要明确回复某条历史消息时，**必须**使用 \`[REPLY_TO_ID: a.b]\` 标签，并将其放在你回复内容的最前面。
'在历史记录中，只有用户的消息会以 (msg_id: ...) 的格式作为前缀，其中包含该消息的唯一ID。你可以使用这个ID来完成引用回复。',
'【绝对禁止】：你的回复中绝对不能包含 (msg_id: ...) 这个前缀本身，这是系统信息，不是对话内容。',
- **内心独白 (强制)**: 在所有公开回复的最后，必须使用 "|||---THOUGHT---|||" 作为分隔符，然后写下你作为 ${contactName} 的真实内心想法。这部分内容不会被对方看到。
    - **完整示例**: 我知道了|||---|||谢谢你|||---THOUGHT---|||他终于明白了，太好了。
- **图像识别 (强制)**: 如果用户发送了图片（即消息格式为 [发送了一张图片，描述是: ...]），你必须对图片描述进行评论。
- **礼物回应 (强制)**: 如果用户送了礼物（即消息格式为 [送出了一个礼物: ...]），你必须对此表示感谢或作出符合人设的回应。
- **外卖代付**: 如果用户发起了外卖代付请求，而你决定帮TA付钱，你必须直接使用 \`[TRANSFER: amount=金额, memo=外卖名称代付]\` 来完成支付，而不是口头答应。
`;
            }
        } else if (contextType === 'call') {
            prompt += `
# [CALL-SPECIFIC INSTRUCTIONS]
- **对话风格**: 你正在打电话。你的回复必须是纯粹的口头语言，不要使用任何特殊标签、分隔符或内心独白。
`;
        } else if (contextType === 'moment_post') {
            prompt += `
# [MOMENT POSTING INSTRUCTIONS]
- **核心任务**: 你需要以 ${contactName} 的身份，发布一条朋友圈。
- **【灵感来源】**: 你的帖子内容必须深度结合你的【核心人设】和【世界观/背景故事】。这是你创作的唯一灵感来源，禁止脱离这两者进行创作。
- **图文帖 (可选)**: 你有大约50%的几率可以发布一个带图片的帖子。如果你决定发图文帖，你必须在帖子正文的最后，使用 \`[IMAGE: 对图片的文字描述]\` 标签来描述图片内容。
    - **【重要】**: 只有在你的帖子内容是描述一个具体场景、物品或视觉元素时（例如：美丽的风景、好吃的食物、新买的东西），才应该配图。如果是纯粹的情绪抒发或观点表达，则不应配图。
- **输出格式**: 只返回朋友圈正文。如果带图，则正文末尾附加图片标签。
- **示例 (不带图)**: 今天天气真好，心情也跟着放晴了。
- **示例 (带图)**: 晚餐吃了超大份的拉面，太满足了！[IMAGE: 一碗热气腾腾的日式豚骨拉面，上面有溏心蛋和叉烧肉]
- **【绝对禁止】** 不要返回任何其他解释或文字。
`;
        } else if (contextType === 'moment_comment') {
            prompt += `
# [MOMENT COMMENT INSTRUCTIONS]
- **任务**: 你的朋友 "${extraContext.postAuthorName}" 刚刚发布了一条朋友圈，内容是：“${extraContext.postText}”。请你根据自己的角色人设和世界观，写一条简短、自然的评论。
- **风格**: 评论要口语化，就像在社交媒体上真实互动一样。
- **输出**: 只返回评论内容本身，不要有任何额外解释。
`;
        } else if (contextType === 'moment_reply') {
            prompt += `
# [MOMENT REPLY INSTRUCTIONS]
- **任务**: 你之前发了一条朋友圈。现在，你的朋友 "${extraContext.commentAuthorName}" 评论了你的这条朋友圈。他/她的评论是：“${extraContext.commentText}”。请你根据自己的角色人设和世界观，回复他/她的这条评论。
- **风格**: 回复要口语化、自然，就像在社交媒体上真实互动一样。
- **输出**: 只返回回复内容本身，不要有任何额外解释。
`;
        } else if (contextType === 'diary') {
            prompt += `
# [DIARY WRITING INSTRUCTIONS]
- **核心任务**: 你需要根据你和 ${myName} 最近的聊天记录，写一篇日记。
- **聊天回顾**: 以下是你们最近的对话节选，这是你写日记的唯一素材和灵感来源：
---
${extraContext.chatHistoryForDiary}
---
- **写作要求**:
    1.  **第一人称**: 必须以你 (${contactName}) 的视角和口吻来写。
    2.  **内容紧扣对话**: 日记内容必须围绕上述聊天记录展开，记录你对这些对话的感想、情绪、或后续思考。可以是对某件事的记录，也可以是对 ${myName} 某句话的感受。
    3.  **深度融合**: 你的感想和思考必须与你的【核心人设】和【世界观/背景故事】深度融合。
    4.  **禁止杜撰**: 不要凭空捏造聊天记录里没有发生过的事情。
- **输出**: 只返回日记正文，不要包含日期、标题或任何额外解释。
`;
        } else if (contextType === 'gomoku_move') {
            prompt += `
# [GOMOKU (FIVE-IN-A-ROW) MOVE INSTRUCTIONS]
- **核心任务**: 你正在和 ${myName} 下五子棋。现在轮到你了。
- **棋局状态**:
    - 你的棋子是: ${extraContext.aiPlayer === 1 ? '黑棋(1)' : '白棋(2)'}
    - 棋盘 (0=空, 1=黑, 2=白):
${extraContext.boardString}
- **棋风指令 (Chess Style Mandate)**: 你的棋风是 **${extraContext.chessStyle}**。
    - **如果棋风是 '放水'**: 你必须故意下出一些非最优的棋，甚至可以犯一些明显的错误，让对手有赢的机会。不要总是堵住对手的关键连线。
    - **如果棋风是 '中等'**: 你要像一个普通水平的玩家一样下棋，攻守兼备，与对手的水平相当。
    - **如果棋风是 '加强'**: 你必须全力以赴，使用高级策略，预判对手的棋路，找出最佳的进攻和防守位置，目标是取得胜利。
- **人设影响 (Persona Influence) - 【强制】**: 在遵循棋风指令的同时，你的下棋风格也必须符合你的【核心人设】和【世界观/背景故事】。
- **输出格式 (Output Format) - 【强制】**: 你的回复必须严格遵循以下格式，用 "|||---|||" 分隔。
    - **格式**: [行,列]|||---|||你下棋时想说的一句简短的话（可选，但强烈建议，以符合人设）
    - **坐标说明**: 行和列的索引从0开始（左上角是[0,0]）。
    - **示例 1 (只下棋)**: [7,7]
    - **示例 2 (下棋并说话)**: [8,7]|||---|||嗯... 下这里怎么样？
    - **【绝对禁止】**: 除了坐标和可选的聊天内容，不要返回任何其他解释或文字。
`;
        } else if (contextType === 'forum_post_from_persona') {
            prompt += `
# [FORUM POSTING FROM PERSONA]
- **核心任务**: 你需要以 ${contactName} 的身份，在论坛上发布一个帖子。
- **【灵感来源】**: 你的帖子内容必须深度结合你的【核心人设】和【世界观/背景故事】。你也可以从最近和 ${myName} 的聊天中寻找灵感。
- **最近聊天回顾 (可选参考)**:
---
${extraContext.recentChatHistory || '暂无'}
---
- **【创意铁律】**: 你的帖子内容必须有创意，避免生成重复或模板化的内容。
- **图文帖 (可选)**: 你有大约30%的几率可以发布一个带图片的帖子。如果你决定发图文帖，你必须在帖子正文的最后，使用 \`[IMAGE: 对图片的文字描述]\` 标签来描述图片内容。
- **输出格式 (Output Format) - 【强制】**: 你的回复必须严格遵循以下格式，用 "|||---|||" 分隔。
    - **格式**: 帖子标题|||---|||帖子正文 (可选的图片标签放在正文末尾)
- **【绝对禁止】** 不要返回任何其他解释或文字。
`;
        } else if (contextType === 'forum_post_scenario') {
            prompt += `
# [FORUM POSTING SCENARIO]
- **核心任务**: 你需要扮演一个网络用户，在论坛上根据给定的剧本发布一个帖子。
- **你的身份**: ${extraContext.isStranger ? `你是一个随机的网友，你的ID是“${extraContext.authorName}”。` : `你的身份是“${contactName}”。`}
- **【创作核心】**: 你的帖子内容必须深度结合你的【核心人设】、【世界观/背景故事】以及下面的【发帖剧本】。
- **发帖剧本 (MANDATORY)**: ${extraContext.scenario}
- **【创意铁律】**: 你的帖子内容必须有创意，避免生成重复或模板化的内容。
- **图文帖 (可选)**: 你有大约30%的几率可以发布一个带图片的帖子。如果你决定发图文帖，你必须在帖子正文的最后，使用 \`[IMAGE: 对图片的文字描述]\` 标签来描述图片内容。
- **输出格式 (Output Format) - 【强制】**: 你的回复必须严格遵循以下格式，用 "|||---|||" 分隔。
    - **格式**: 帖子标题|||---|||帖子正文 (可选的图片标签放在正文末尾)
- **【绝对禁止】** 不要返回任何其他解释或文字。
`;
        } else if (contextType === 'forum_comment') {
            prompt += `
# [FORUM COMMENT INSTRUCTIONS]
- **核心任务**: 你需要对一个论坛帖子进行评论。
- **你的身份**: ${extraContext.isStranger ? `你是一个随机的网友，你的ID是“${extraContext.authorName}”。` : `你的身份是“${contactName}”。`}
- **【重要上下文-必须阅读】帖子的完整内容**:
    - **楼主**: ${extraContext.postAuthorName}
    - **标题**: ${extraContext.postTitle}
    - **正文**: ${extraContext.postText}
- **评论要求 (MANDATORY)**:
    1.  **【内容紧扣】**: 你的评论必须是针对帖子内容的直接回应，并符合你的【核心人设】和【世界观/背景故事】。
    2.  **【禁止无关】**: 绝对禁止发表与帖子内容无关的评论。
    3.  **【风格自然】**: 评论风格要符合你的网络身份，口语化、自然。
- **输出**: 只返回评论内容本身，不要有任何额外解释。
`;
        } else if (contextType === 'forum_reply') {
            prompt += `
# [FORUM REPLY INSTRUCTIONS]
- **核心任务**: 你需要回复一条评论。
- **你的身份**: ${extraContext.isStranger ? `你是一个随机的网友，你的ID是“${extraContext.authorName}”。` : `你的身份是“${contactName}”。`}
- **【重要上下文-必须阅读】原始主楼内容**:
    - **标题**: ${extraContext.postTitle}
    - **正文**: ${extraContext.postText}
- **【重要上下文-必须阅读】对方评论**: "${extraContext.commentAuthorName}" 评论说: "${extraContext.commentText}"
- **回复要求 (MANDATORY)**:
    1.  **【强制关联】** 你的回复必须是针对【对方评论】的直接回应，但同时必须与【原始主楼内容】保持逻辑一致，绝对不能出现矛盾（比如主楼说的是偶像，你回复时不能说成是亲哥哥）。
    2.  **【风格自然】**: 风格要符合你的网络身份，口语化、自然。
- **输出**: 只返回回复内容本身，不要有任何额外解释。
`;
        } else if (contextType === 'chat_summary') {
            prompt += `
# [CHAT SUMMARY INSTRUCTIONS]
- **核心任务**: 你是一个专业的对话分析师。你的任务是根据下面提供的完整聊天记录，生成一份清晰、客观、结构化的总结报告。
- **对话参与者**:
    - **我方**: ${myName} (${myPersonaDesc})
    - **对方**: ${contactName} (${contactPersona})
- **聊天记录**:
---
${extraContext.fullChatHistory}
---
- **总结要求 (MANDATORY)**:
    1.  **客观中立**: 总结必须基于聊天记录的客观事实，避免加入你自己的主观臆断或情绪。
    2.  **结构清晰**: 你的总结必须严格按照以下Markdown格式进行组织，使用标题和列表。
    3.  **内容全面**: 总结需要涵盖对话的关键信息，包括但不限于核心事件、讨论的话题、双方的情感变化、以及任何重要的决定或约定。
- **输出格式 (Output Format) - 【强制】**:
## 核心事件
- [用简洁的语言列出对话中发生的主要事件或讨论的核心议题]
- [例如：讨论了周末的旅行计划]

## 关键转折点
- [列出导致对话方向或氛围发生显著变化的节点]
- [例如：当 ${contactName} 提到预算问题时，气氛变得紧张]

## 情感脉络
- **${myName}**: [描述我方在对话中的情感变化，例如：从期待到失落，最终达成理解]
- **${contactName}**: [描述对方在对话中的情感变化，例如：开始时很抵触，后来逐渐被说服]

## 总结与展望
- [对整个对话进行一句话概括，并指出对话达成的共识或遗留的问题]
- [例如：双方最终就旅行地点达成一致，但具体行程仍需讨论]

- **【绝对禁止】**: 除了上述格式的总结内容，不要返回任何其他解释、开场白或结尾。
`;
        } else { // fallback for other types
            prompt += `
# [GENERAL INSTRUCTIONS]
- **内容风格**: 你的回复必须是符合 ${contextType} 场景的、自然流畅的文本。不要使用任何功能标签或内心独白。
`;
        }

        if (groupInfo && contextType === 'chat') {
            prompt += `
# [GROUP CHAT MANDATE]
你现在在名为 “${groupInfo.name}” 的群聊中，群里还有 ${groupInfo.otherMemberNames}。现在轮到你 (${contactName}) 发言了。**你必须仔细阅读上面的完整聊天记录（包括其他人的发言）**，然后对刚才的话题进行回应（可以赞同、反驳、提问或开玩笑），或者开启一个相关的新话题。**你必须发言，不能沉默。**
`;
        }
        return prompt;
    };

    async function updateBatteryStatus() {
        const statusIcons = document.getElementById('status-icons');
        if (!statusIcons) return;

        const getBatterySVG = (level, isCharging) => {
            const levelWidth = 18 * (level / 100);
            const chargingSymbol = isCharging 
                ? `<path d="M11.99 4L4 14h5v6l7.99-10h-5z" fill="currentColor"/>` 
                : `<rect x="2.5" y="5" width="${levelWidth}" height="14" rx="1.5" fill="currentColor"/>`;
            
            return `
                <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-left: 4px;">
                    <path d="M21 9V16C22.1046 16 23 15.1046 23 14V11C23 9.89543 22.1046 9 21 9Z" fill="currentColor" opacity="0.4"/>
                    <rect x="1.25" y="3.25" width="18.5" height="18.5" rx="4.75" stroke="currentColor" stroke-width="1.5"/>
                    ${chargingSymbol}
                </svg>
            `;
        };

        try {
            if ('getBattery' in navigator) {
                const battery = await navigator.getBattery();
                const update = () => {
                    const level = Math.round(battery.level * 100);
                    statusIcons.innerHTML = `${level}% ${getBatterySVG(level, battery.charging)}`;
                };
                update();
                battery.addEventListener('levelchange', update);
                battery.addEventListener('chargingchange', update);
            } else {
                statusIcons.innerHTML = `100% ${getBatterySVG(100, true)}`;
            }
        } catch (err) {
            console.error("Could not update battery status:", err);
            statusIcons.innerHTML = `100% ${getBatterySVG(100, true)}`;
        }
    }

    async function init() { 
        try { 
            await initDB(); 
            await renderHTML(); 
            await loadData(); 
            if (!phoneScreen.style.backgroundImage.includes('url')) { 
                phoneScreen.style.backgroundImage = `url(https://files.catbox.moe/2yifoc.jpg)`; 
            } 
            await renderHomeScreen(); 
            document.getElementById('wallpaper-url').value = phoneScreen.style.backgroundImage.slice(5, -2).replace(/"/g, ""); 
            document.getElementById('api-base-url').value = apiSettings.baseUrl || ''; 
            document.getElementById('api-key').value = apiSettings.apiKey || ''; 
            if (apiSettings.model) { 
                const modelSelect = document.getElementById('api-model-select'); 
                modelSelect.innerHTML = `<option value="${apiSettings.model}">${apiSettings.model}</option>`; 
                modelSelect.disabled = false; 
            } 
            await renderContactList(); 
            await renderMoments(); 
            await renderForum();
            updateClock(); 
            setInterval(updateClock, 30000); 
            updateBatteryStatus();
            bindEventListeners(); 
        } catch (error) { 
            console.error("Initialization failed:", error); 
            alert("应用初始化失败，可能是由于上次的更新错误。请尝试清除浏览器缓存或在无痕模式下运行。错误详情: " + error.message); 
        } 
    }
    function bindEventListeners() {
        document.body.addEventListener('click', async e => {
            const target = e.target;
            if (target.classList.contains('modal')) { closeModal(target.id); return; }
            if (isDeletionMode) { const messageEl = e.target.closest('.message'); if (messageEl) { const msgId = Number(messageEl.dataset.id); messageEl.classList.toggle('selected-for-deletion'); if (messagesToDelete.has(msgId)) { messagesToDelete.delete(msgId); } else { messagesToDelete.add(msgId); } } return; }
            const backBtn = target.closest('.back-btn'); if (backBtn) { if ((backBtn.id === "gomoku-back-btn" && gomokuGame.inProgress) || (backBtn.parentElement.parentElement.id === "screen-rps" && rpsGame.isActive)) { if (!confirm("确定要退出当前对局吗？")) return; } const existingStyle = document.getElementById('custom-bubble-style-tag'); if (existingStyle) existingStyle.remove(); const fontStyle = document.getElementById('custom-font-style-tag'); if (fontStyle) fontStyle.remove(); showScreen(backBtn.dataset.target); return; }
            const appIcon = target.closest('.app-icon'); if (appIcon) { showScreen(appIcon.dataset.target); return; }
            const chatListItem = target.closest('.list-item'); if (chatListItem && chatListItem.parentElement.id === 'contact-list-container') { const id = Number(chatListItem.dataset.id); const isGroup = chatListItem.dataset.isGroup === 'true'; await renderChat({id, isGroup}); showScreen('screen-chat'); return; }
            if (target.closest('[data-action="close"]')) { closeModal(target.closest('.modal').id); return; }
            if (target.closest('[data-action="close-import-export"]')) {
                closeModal('import-export-modal');
                const contentDiv = document.getElementById('import-export-content');
                const fileInput = document.getElementById('import-chat-input');
                setTimeout(() => {
                    contentDiv.innerHTML = `<p style="text-align:center; font-size:14px; color:var(--light-text-color);">保存或唤醒与TA的对话记忆</p><button id="export-chat-btn" class="btn btn-secondary">导出聊天记录</button><button id="import-chat-btn" class="btn">导入聊天记录</button>`;
                    if(fileInput) fileInput.value = '';
                }, 300);
                return;
            }
            if (target.closest('[data-action="close-worldbook-import-export"]')) {
                closeModal('worldbook-import-export-modal');
                const contentDiv = document.getElementById('worldbook-import-export-content');
                const fileInput = document.getElementById('import-worldbooks-input');
                setTimeout(() => {
                    contentDiv.innerHTML = `<p style="text-align:center; font-size:14px; color:var(--light-text-color);">备份或恢复您的所有世界书</p><button id="export-worldbooks-btn" class="btn btn-secondary">导出所有世界书</button><button id="import-worldbooks-btn" class="btn">导入世界书 (覆盖)</button>`;
                    if(fileInput) fileInput.value = '';
                }, 300);
                return;
            }
            const navItem = target.closest('.nav-item');
            if (navItem) {
                document.querySelectorAll('.wechat-nav .nav-item').forEach(i => i.classList.remove('active'));
                const targetTab = navItem.dataset.tab;
                document.querySelectorAll('#screen-wechat .content-container > div').forEach(p => p.classList.remove('active'));
                const isMoments = targetTab === 'moments-feed';
                const isForum = targetTab === 'forum-feed';
                if (isMoments) { await renderMoments(); } 
                else if (isForum) { await renderForum(); }
                else { if(!contactListRendered) await renderContactList(); }
                navItem.classList.add('active');
                document.querySelector(`.${targetTab}`).classList.add('active');
                let titleText = `微信 (<span>${contacts.length + groupChats.length}</span>)`;
                if (isMoments) titleText = '朋友圈';
                if (isForum) titleText = '论坛';
                document.querySelector('#wechat-header .title').innerHTML = titleText;
                document.getElementById('add-btn').style.display = isMoments || isForum ? 'none' : 'inline-block';
                document.getElementById('moments-my-post-btn').style.display = isMoments || isForum ? 'inline-block' : 'none';
                document.getElementById('moments-ai-post-btn').style.display = isMoments || isForum ? 'inline-block' : 'none';
                return;
            }
            const voiceBubble = target.closest('.message.voice .bubble');
            if (voiceBubble) {
                const msgEl = voiceBubble.closest('.message');
                const transcript = msgEl.dataset.transcript;
                const msgId = Number(msgEl.dataset.id);

                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                const msg = currentChat.chatHistory.find(m => m.id === msgId);
                let senderName = '';
                if (msg.sender === 'sent') {
                    senderName = currentChat.myProfile.name || '我';
                } else {
                    const contact = contacts.find(c => c.id === msg.contactId);
                    senderName = getDisplayName(contact);
                }

                document.getElementById('voice-transcript-modal-title').textContent = `${senderName} 的语音内容`;
                document.getElementById('voice-transcript-content').textContent = transcript;
                openModal('voice-transcript-modal');
                return;
            }
            const imageDescBubble = target.closest('.message.image_description .bubble, .post-image-container, .moment-image-container');
            if (imageDescBubble) {
                const msgEl = imageDescBubble.closest('.message');
                const postEl = imageDescBubble.closest('.forum-post-item, .moment-item');
                const description = msgEl ? msgEl.dataset.description : imageDescBubble.dataset.description;
                
                if (!description) return;

                let senderName = '我';
                if (msgEl) {
                    const msgId = Number(msgEl.dataset.id);
                    const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                    const msg = currentChat.chatHistory.find(m => m.id === msgId);
                    if (msg && msg.sender === 'received') {
                        const contact = contacts.find(c => c.id === msg.contactId);
                        senderName = getDisplayName(contact);
                    }
                } else if (postEl) {
                    senderName = postEl.querySelector('.author').textContent;
                }

                document.getElementById('view-image-description-modal-title').textContent = `${senderName} 的图片描述`;
                document.getElementById('view-image-description-content').textContent = description;
                openModal('view-image-description-modal');
                return;
            }
            const giftBubble = target.closest('.message.gift .bubble');
            if (giftBubble) {
                const msgEl = giftBubble.closest('.message');
                const giftName = msgEl.dataset.giftName;
                const msgId = Number(msgEl.dataset.id);

                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                const msg = currentChat.chatHistory.find(m => m.id === msgId);
                let senderName = '';
                if (msg.sender === 'sent') {
                    senderName = currentChat.myProfile.name || '我';
                    document.getElementById('view-gift-modal-title').textContent = `送出的礼物`;
                    const recipientContact = msg.recipientId ? contacts.find(c => c.id === msg.recipientId) : null;
                    const recipientName = recipientContact ? getDisplayName(recipientContact) : '对方';
                    document.getElementById('view-gift-content').textContent = `你送给了 ${recipientName} 一份礼物：${giftName}`;
                } else {
                    const contact = contacts.find(c => c.id === msg.contactId);
                    senderName = getDisplayName(contact);
                    document.getElementById('view-gift-modal-title').textContent = `收到一份礼物`;
                    document.getElementById('view-gift-content').textContent = `你收到了 ${senderName} 送出的礼物：${giftName}`;
                }
                openModal('view-gift-modal');
                return;
            }
            const transferBubble = target.closest('.message.received.transfer .bubble');
            if (transferBubble) {
                const msgId = Number(transferBubble.closest('.message').dataset.id);
                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                const msg = currentChat.chatHistory.find(m => m.id === msgId);
                if (!msg || msg.status !== 'pending') return;
                if (confirm("要收下这笔转账吗？")) {
                    msg.status = 'accepted';
                    await saveData();
                    await renderSingleMessage(msgId, msg);
                } else if (confirm("要退回这笔转账吗？")) {
                    msg.status = 'returned';
                    await renderSingleMessage(msgId, msg);
                    const myProfile = currentChat.myProfile || { name: '我', avatarId: myMomentsProfile.avatarId };
                    const returnMsg = { id: Date.now(), sender: 'sent', type: 'transfer', amount: msg.amount, memo: '退回转账', avatarId: myProfile.avatarId, status: 'returned', recipientId: msg.contactId };
                    currentChat.chatHistory.push(returnMsg);
                    await appendMessageToChat(returnMsg);
                    await saveData();
                }
            }
            const payBtn = target.closest('.pay-btn');
            if (payBtn) { 
                const msgId = Number(payBtn.dataset.msgId);
                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                const paymentRequestMsg = currentChat.chatHistory.find(m => m.id === msgId);
                if (paymentRequestMsg) {
                    triggerAIResponse({isPaymentDecision: true, paymentMsg: paymentRequestMsg});
                }
            }
            if (target.id === 'add-anniversary-btn') { if (contacts.length === 0) { alert('请先创建联系人'); return; } document.getElementById('anniversary-title').value = ''; document.getElementById('anniversary-date').value = ''; document.getElementById('anniversary-cover-preview').src = await getImageById(emptyBgId); tempImageId.anniversaryCover = null; const select = document.getElementById('anniversary-contact-select'); select.innerHTML = ''; contacts.forEach(contact => { const option = document.createElement('option'); option.value = contact.id; option.textContent = getDisplayName(contact); select.appendChild(option); }); openModal('add-anniversary-modal'); return; }
            if (target.id === 'confirm-add-anniversary-btn') { const title = document.getElementById('anniversary-title').value.trim(); const date = document.getElementById('anniversary-date').value; const contactId = Number(document.getElementById('anniversary-contact-select').value); if (!title || !date || !contactId) { alert('请填写所有必填项！'); return; } const newAnniversary = { id: Date.now(), title, date, contactId, coverImageId: tempImageId.anniversaryCover || null }; anniversaries.push(newAnniversary); await renderAnniversaries(); await saveData(); closeModal('add-anniversary-modal'); return; }
            if (target.id === 'add-diary-btn') { if (contacts.length === 0) { alert("你还没有联系人"); return; } const list = document.getElementById('diary-author-selection-list'); list.innerHTML = ''; contacts.forEach(contact => { const contactBtn = document.createElement('button'); contactBtn.className = 'btn'; contactBtn.textContent = getDisplayName(contact); contactBtn.onclick = () => { triggerAiDiary(contact.id); closeModal('select-diary-author-modal'); }; list.appendChild(contactBtn); }); openModal('select-diary-author-modal'); return; }
            if (target.closest('.delete-anniversary-btn')) { if (confirm('确定要删除这个纪念日吗？')) { const idToDelete = Number(target.closest('.delete-anniversary-btn').dataset.id); anniversaries = anniversaries.filter(a => a.id !== idToDelete); await renderAnniversaries(); await saveData(); } return; }
            if (target.closest('.delete-diary-btn')) { if (confirm('确定要删除这篇日记吗？')) { const idToDelete = Number(target.closest('.delete-diary-btn').dataset.id); diaries = diaries.filter(d => d.id !== idToDelete); await renderDiaries(); await saveData(); } return; }
            
            if (target.closest('#home-top-widget-content')) { document.getElementById('home-top-widget-input').click(); }
            if (target.closest('#home-large-photo-widget')) { document.getElementById('home-large-photo-input').click(); }
            if (target.closest('#home-profile-avatar')) { document.getElementById('home-profile-avatar-input').click(); }
            
            const musicCard = target.closest('.chat-music-container');
            if (musicCard) {
                const songId = Number(musicCard.dataset.songId);
                playChatMusic(songId);
                return;
            }
        });
        const setupAvatarUpload = (previewElId, inputElId, tempKey) => { const previewEl = document.getElementById(previewElId); const inputEl = document.getElementById(inputElId); previewEl.addEventListener('click', () => inputEl.click()); inputEl.addEventListener('change', async e => { if (e.target.files[0]) { const newId = await storeImageAndGetId(e.target.files[0]); if (newId) { tempImageId[tempKey] = newId; previewEl.src = await getImageById(newId); } } }); };
        setupAvatarUpload('add-contact-avatar-preview', 'add-contact-avatar-input', 'addContact');
        setupAvatarUpload('add-group-avatar-preview', 'add-group-avatar-input', 'addGroup');
        setupAvatarUpload('edit-contact-avatar-preview', 'edit-contact-avatar-input', 'contactAvatar'); setupAvatarUpload('edit-group-avatar-preview', 'edit-group-avatar-input', 'groupAvatar'); setupAvatarUpload('edit-my-avatar-preview', 'edit-my-avatar-input', 'myAvatar'); setupAvatarUpload('edit-chat-bg-preview', 'edit-chat-bg-input', 'chatBg'); setupAvatarUpload('edit-moments-avatar-preview', 'edit-moments-avatar-input', 'momentsAvatar'); setupAvatarUpload('anniversary-cover-preview', 'anniversary-cover-input', 'anniversaryCover'); setupAvatarUpload('edit-moments-bg-preview', 'edit-moments-bg-input', 'momentsBg'); setupAvatarUpload('edit-icon-preview', 'edit-icon-input', 'appIcon');
        setupAvatarUpload('upload-song-cover-preview', 'upload-song-cover-input', 'chatMusicCover');
        
        document.getElementById('fetch-models-btn').addEventListener('click', async () => { const baseUrl = document.getElementById('api-base-url').value.trim(); const apiKey = document.getElementById('api-key').value.trim(); const btn = document.getElementById('fetch-models-btn'); const select = document.getElementById('api-model-select'); if (!baseUrl || !apiKey) { alert('请填写完整的反向代理地址和API密钥'); return; } btn.textContent = '拉取中...'; btn.disabled = true; try { const response = await fetch(`${baseUrl}/v1/models`, { headers: { 'Authorization': `Bearer ${apiKey}` } }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${await response.text()}`); const data = await response.json(); select.innerHTML = ''; (data.data || []).forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; select.appendChild(option); }); select.disabled = false; } catch (error) { alert('拉取模型失败: ' + error.message); select.innerHTML = '<option>拉取失败</option>'; } finally { btn.textContent = '拉取模型'; btn.disabled = false; } });
        document.getElementById('save-api-settings-btn').addEventListener('click', async () => { apiSettings = { baseUrl: document.getElementById('api-base-url').value.trim(), apiKey: document.getElementById('api-key').value.trim(), model: document.getElementById('api-model-select').value }; if (!apiSettings.baseUrl || !apiSettings.apiKey || !apiSettings.model || apiSettings.model === '请先拉取模型') { alert('请确保所有信息都已填写并选择了模型'); return; } await saveData(); alert('API设置已保存!'); });
        document.getElementById('apply-wallpaper-btn').addEventListener('click', async () => { const url = document.getElementById('wallpaper-url').value.trim(); if (url) { phoneScreen.style.backgroundImage = `url(${url})`; await saveData(); alert('壁纸已应用'); } });
        document.getElementById('upload-wallpaper-btn').addEventListener('click', () => document.getElementById('wallpaper-input').click());
        document.getElementById('wallpaper-input').addEventListener('change', async (e) => { if (e.target.files && e.target.files[0]) { const base64 = await fileToBase64(e.target.files[0]); phoneScreen.style.backgroundImage = `url(${base64})`; document.getElementById('wallpaper-url').value = '已从本地文件中选择'; await saveData(); alert('壁纸已应用'); } });
        document.getElementById('add-btn').addEventListener('click', () => openModal('add-menu-modal'));
        document.getElementById('menu-add-contact').addEventListener('click', async () => { closeModal('add-menu-modal'); document.getElementById('add-contact-name').value = ''; document.getElementById('add-contact-remark').value = ''; document.getElementById('add-contact-persona').value = ''; document.getElementById('add-contact-avatar-preview').src = await getImageById(defaultAvatarId); tempImageId.addContact = null; openModal('add-contact-modal'); });
        document.getElementById('menu-add-group').addEventListener('click', async () => { closeModal('add-menu-modal'); document.getElementById('add-group-name').value = ''; document.getElementById('add-group-avatar-preview').src = await getImageById(defaultAvatarId); tempImageId.addGroup = null; const memberSelectionDiv = document.getElementById('group-member-selection'); memberSelectionDiv.innerHTML = ''; for (const contact of contacts) { const avatarSrc = await getImageById(contact.avatarId); const displayName = getDisplayName(contact); memberSelectionDiv.innerHTML += `<span class="member-selection-item"><label><input type="checkbox" value="${contact.id}"><img src="${avatarSrc}"> ${displayName}</label></span>`; } openModal('add-group-chat-modal'); });
        document.getElementById('confirm-add-contact-btn').addEventListener('click', async () => { const name = document.getElementById('add-contact-name').value.trim(); if (!name) { alert('角色姓名不能为空'); return; } const newContact = { id: Date.now(), name, remark: document.getElementById('add-contact-remark').value.trim(), persona: document.getElementById('add-contact-persona').value.trim(), avatarId: tempImageId.addContact || defaultAvatarId, chatHistory: [], myProfile: { name: '我', avatarId: myMomentsProfile.avatarId || defaultAvatarId, persona: '', sharedBubbleCss: '', sentFont: '', receivedFont: '', sentFontId: null, receivedFontId: null }, chatBgId: null, memoryDepth: 10, worldBookIds: [], chessStyle: '中等', isPinned: false }; contacts.push(newContact); contactListRendered = false; await renderContactList(); await saveData(); closeModal('add-contact-modal'); });
        document.getElementById('confirm-add-group-btn').addEventListener('click', async () => { const name = document.getElementById('add-group-name').value.trim(); if (!name) { alert('群名称不能为空'); return; } const selectedMembers = []; document.querySelectorAll('#group-member-selection input:checked').forEach(input => selectedMembers.push(Number(input.value))); if (selectedMembers.length === 0) { alert('请至少邀请一个联系人'); return; } const newGroup = { id: Date.now(), name, avatarId: tempImageId.addGroup || defaultAvatarId, memberIds: selectedMembers, chatHistory: [], myProfile: { name: '我', avatarId: myMomentsProfile.avatarId || defaultAvatarId, persona: '', sharedBubbleCss: '', sentFont: '', receivedFont: '', sentFontId: null, receivedFontId: null }, chatBgId: null, memoryDepth: 10, worldBookIds: [], isPinned: false }; groupChats.push(newGroup); contactListRendered = false; await renderContactList(); await saveData(); closeModal('add-group-chat-modal'); });
        document.getElementById('chat-input').addEventListener('input', () => { document.getElementById('send-btn').disabled = document.getElementById('chat-input').value.trim() === ''; });
        document.getElementById('chat-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
        document.getElementById('send-btn').addEventListener('click', async () => { const chatInput = document.getElementById('chat-input'); const text = chatInput.value.trim(); if (!text) return; const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id); if (!currentChat) return; const myProfile = currentChat.myProfile || { name: '我', avatarId: defaultAvatarId }; const message = { id: Date.now(), sender: 'sent', text, avatarId: myProfile.avatarId, type: 'text' }; if (activeReplyTarget) { message.type = 'reply'; message.quote = activeReplyTarget; } if (!currentChat.chatHistory) currentChat.chatHistory = []; currentChat.chatHistory.push(message); await appendMessageToChat(message); chatInput.value = ''; document.getElementById('send-btn').disabled = true; document.getElementById('reply-preview-container').classList.remove('active'); activeReplyTarget = null; await saveData(); });
        document.getElementById('get-ai-response-btn').addEventListener('click', () => {
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (!currentChat) return;
            const chatInput = document.getElementById('chat-input');
            const lastMessage = currentChat.chatHistory[currentChat.chatHistory.length - 1];
            const isInputEmpty = chatInput.value.trim() === '';
            const isLastMsgFromAI = lastMessage && lastMessage.sender === 'received';
            if (isInputEmpty && isLastMsgFromAI) {
                triggerAIResponse({ isRegeneration: true });
            } else {
                triggerAIResponse();
            }
        });
        document.getElementById('chat-settings-btn').addEventListener('click', async () => {
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (!currentChat) return;
            document.getElementById('settings-chat-id').value = currentChat.id;
            const groupInfoDiv = document.getElementById('chat-settings-group-info');
            const contactInfoDiv = document.getElementById('chat-settings-contact-info');

            document.getElementById('pin-chat-toggle').checked = currentChat.isPinned || false;

            if (activeChat.isGroup) {
                groupInfoDiv.style.display = 'block'; contactInfoDiv.style.display = 'none';
                document.getElementById('edit-group-name').value = currentChat.name;
                document.getElementById('edit-group-avatar-preview').src = await getImageById(currentChat.avatarId);
            } else {
                groupInfoDiv.style.display = 'none'; contactInfoDiv.style.display = 'block';
                document.getElementById('edit-contact-name').value = currentChat.name;
                document.getElementById('edit-contact-remark').value = currentChat.remark;
                document.getElementById('edit-contact-persona').value = currentChat.persona;
                document.getElementById('edit-contact-avatar-preview').src = await getImageById(currentChat.avatarId);
                document.getElementById('edit-chess-style').value = currentChat.chessStyle || '中等';
            }
            const myProfile = currentChat.myProfile || { name: '我', avatarId: defaultAvatarId, persona: '', sharedBubbleCss: '', sentFont: '', receivedFont: '', sentFontId: null, receivedFontId: null };
            document.getElementById('edit-my-name').value = myProfile.name; document.getElementById('edit-my-persona').value = myProfile.persona;
            document.getElementById('edit-my-avatar-preview').src = await getImageById(myProfile.avatarId);
            document.getElementById('edit-sent-font').value = myProfile.sentFont || '';
            document.getElementById('edit-received-font').value = myProfile.receivedFont || '';
            document.getElementById('font-preview-sent').style.fontFamily = myProfile.sentFont || '';
            document.getElementById('font-preview-received').style.fontFamily = myProfile.receivedFont || '';
            const rawCssInput = document.getElementById('edit-bubble-css-raw');
            rawCssInput.value = myProfile.sharedBubbleCss || '';
            document.getElementById('bubble-preview-style-tag').textContent = rawCssInput.value;

            document.getElementById('edit-chat-bg-preview').src = await getImageById(currentChat.chatBgId || emptyBgId);
            document.getElementById('edit-memory-depth').value = currentChat.memoryDepth || 10;
            const worldBookSelect = document.getElementById('bind-worldbook-select'); worldBookSelect.innerHTML = ''; worldBooks.forEach(book => { const option = document.createElement('option'); option.value = book.id; option.textContent = book.name; if ((currentChat.worldBookIds || []).includes(book.id)) { option.selected = true; } worldBookSelect.appendChild(option); });
            tempImageId = {}; openModal('chat-settings-modal');
        });
        document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
            const chatId = Number(document.getElementById('settings-chat-id').value);
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === chatId) : contacts.find(c => c.id === chatId);
            if (!currentChat) return;

            currentChat.isPinned = document.getElementById('pin-chat-toggle').checked;

            if (activeChat.isGroup) {
                currentChat.name = document.getElementById('edit-group-name').value.trim();
                if (tempImageId.groupAvatar) currentChat.avatarId = tempImageId.groupAvatar;
            } else {
                currentChat.name = document.getElementById('edit-contact-name').value.trim();
                currentChat.remark = document.getElementById('edit-contact-remark').value.trim();
                currentChat.persona = document.getElementById('edit-contact-persona').value.trim();
                currentChat.chessStyle = document.getElementById('edit-chess-style').value;
                if (tempImageId.contactAvatar) currentChat.avatarId = tempImageId.contactAvatar;
            }

            currentChat.memoryDepth = parseInt(document.getElementById('edit-memory-depth').value, 10) || 10;
            currentChat.worldBookIds = Array.from(document.getElementById('bind-worldbook-select').selectedOptions).map(opt => Number(opt.value));
            if (!currentChat.myProfile) currentChat.myProfile = {};
            currentChat.myProfile.name = document.getElementById('edit-my-name').value.trim();
            currentChat.myProfile.persona = document.getElementById('edit-my-persona').value.trim();
            currentChat.myProfile.sharedBubbleCss = document.getElementById('edit-bubble-css-raw').value.trim();
            currentChat.myProfile.sentFont = document.getElementById('edit-sent-font').value.trim();
            currentChat.myProfile.receivedFont = document.getElementById('edit-received-font').value.trim();
            if (tempImageId.sentFontInfo) { currentChat.myProfile.sentFontId = tempImageId.sentFontInfo.id; currentChat.myProfile.sentFont = `"${tempImageId.sentFontInfo.name}"`; }
            if (tempImageId.receivedFontInfo) { currentChat.myProfile.receivedFontId = tempImageId.receivedFontInfo.id; currentChat.myProfile.receivedFont = `"${tempImageId.receivedFontInfo.name}"`; }
            if (tempImageId.myAvatar) currentChat.myProfile.avatarId = tempImageId.myAvatar;
            if (tempImageId.chatBg) currentChat.chatBgId = tempImageId.chatBg;
            
            closeModal('chat-settings-modal');
            contactListRendered = false;
            await renderContactList();
            await renderChat(activeChat);
            await saveData();
        });
        document.getElementById('delete-chat-history-btn').addEventListener('click', async () => {
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (currentChat && confirm('确定要清空该会话的所有聊天记录吗？此操作不可恢复。')) {
                currentChat.chatHistory = [];
                await saveData();
                document.getElementById('chat-area').innerHTML = '';
                closeModal('chat-settings-modal');
            }
        });
        document.getElementById('delete-chat-btn').addEventListener('click', async () => {
            const chatId = activeChat.id;
            if (confirm('确定要删除这个会话吗？所有聊天记录和设置将无法恢复。')) {
                if (activeChat.isGroup) {
                    groupChats = groupChats.filter(gc => gc.id !== chatId);
                } else {
                    contacts = contacts.filter(c => c.id !== chatId);
                }
                closeModal('chat-settings-modal');
                contactListRendered = false;
                await renderContactList();
                await saveData();
                showScreen('screen-wechat');
            }
        });
        document.getElementById('chat-actions-toggle-btn').addEventListener('click', () => document.getElementById('chat-actions-panel').classList.toggle('active'));
        document.getElementById('album-action-btn').addEventListener('click', () => {
            document.getElementById('chat-image-input').click();
        });
        document.getElementById('location-action-btn').addEventListener('click', () => {
            document.getElementById('location-name').value = '';
            openModal('send-location-modal');
        });
        document.getElementById('confirm-send-location-btn').addEventListener('click', async () => {
            const locationName = document.getElementById('location-name').value.trim();
            if (!locationName) {
                alert('位置名称不能为空');
                return;
            }
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (!currentChat) return;
            const myProfile = currentChat.myProfile || { avatarId: myMomentsProfile.avatarId };
            const locationMsg = { id: Date.now(), sender: 'sent', type: 'location', text: locationName, avatarId: myProfile.avatarId };
            if (!currentChat.chatHistory) currentChat.chatHistory = [];
            currentChat.chatHistory.push(locationMsg);
            await appendMessageToChat(locationMsg);
            await saveData();
            closeModal('send-location-modal');
        });
        document.getElementById('image-desc-action-btn').addEventListener('click', () => { document.getElementById('image-description-text').value = ''; openModal('send-image-desc-modal'); });
        document.getElementById('confirm-send-image-desc-btn').addEventListener('click', async () => { const text = document.getElementById('image-description-text').value.trim(); if (!text) { alert('图片描述不能为空'); return; } const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id); if (!currentChat) return; const myProfile = currentChat.myProfile || { avatarId: myMomentsProfile.avatarId }; const imageMsg = { id: Date.now(), sender: 'sent', type: 'image_description', text, avatarId: myProfile.avatarId }; if (!currentChat.chatHistory) currentChat.chatHistory = []; currentChat.chatHistory.push(imageMsg); await appendMessageToChat(imageMsg); await saveData(); closeModal('send-image-desc-modal'); });
        document.getElementById('transfer-action-btn').addEventListener('click', () => {
            const recipientGroup = document.getElementById('transfer-recipient-group');
            const recipientSelect = document.getElementById('transfer-recipient-select');
            if (activeChat.isGroup) {
                const group = groupChats.find(gc => gc.id === activeChat.id);
                recipientSelect.innerHTML = '';
                group.memberIds.forEach(id => {
                    const contact = contacts.find(c => c.id === id);
                    if (contact) {
                        const option = document.createElement('option');
                        option.value = contact.id;
                        option.textContent = getDisplayName(contact);
                        recipientSelect.appendChild(option);
                    }
                });
                recipientGroup.style.display = 'block';
            } else {
                recipientGroup.style.display = 'none';
            }
            document.getElementById('transfer-amount').value = '';
            document.getElementById('transfer-memo').value = '';
            openModal('transfer-modal');
        });
        document.getElementById('confirm-transfer-btn').addEventListener('click', async () => {
            const amountInput = document.getElementById('transfer-amount'); let amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) { alert('请输入有效的转账金额'); return; }
            if (amount > 100000) { alert('单次转账金额不能超过100,000'); return; }
            const memo = document.getElementById('transfer-memo').value.trim();
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (!currentChat) return;
            const myProfile = currentChat.myProfile || { name: '我', avatarId: myMomentsProfile.avatarId };
            let recipientId = null;
            if (activeChat.isGroup) {
                recipientId = Number(document.getElementById('transfer-recipient-select').value);
            } else {
                recipientId = activeChat.id;
            }
            const transferMsg = { id: Date.now(), sender: 'sent', type: 'transfer', amount, memo, avatarId: myProfile.avatarId, status: 'pending', recipientId };
            if (!currentChat.chatHistory) currentChat.chatHistory = [];
            currentChat.chatHistory.push(transferMsg);
            await appendMessageToChat(transferMsg);
            await saveData();
            closeModal('transfer-modal');
        });
        document.getElementById('payment-request-action-btn').addEventListener('click', () => { document.getElementById('payment-request-item').value = ''; document.getElementById('payment-request-amount').value = ''; openModal('request-payment-modal'); });
        document.getElementById('send-payment-request-btn').addEventListener('click', async () => { const item = document.getElementById('payment-request-item').value.trim(); const amountInput = document.getElementById('payment-request-amount'); let amount = parseFloat(amountInput.value); if (!item || isNaN(amount) || amount <= 0) { alert('请填写有效的外卖名称和金额'); return; } const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id); if (!currentChat) return; const myProfile = currentChat.myProfile || { avatarId: myMomentsProfile.avatarId }; const requestMsg = { id: Date.now(), sender: 'sent', type: 'payment_request', item, amount, status: 'pending', avatarId: myProfile.avatarId }; if (!currentChat.chatHistory) currentChat.chatHistory = []; currentChat.chatHistory.push(requestMsg); await appendMessageToChat(requestMsg); await saveData(); closeModal('request-payment-modal'); });
        document.getElementById('voice-action-btn').addEventListener('click', () => { document.getElementById('voice-message-text').value = ''; openModal('send-voice-modal'); });
        document.getElementById('confirm-send-voice-btn').addEventListener('click', async () => {
            const text = document.getElementById('voice-message-text').value.trim();
            if (!text) { alert('语音内容不能为空'); return; }
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (!currentChat) return;
            const myProfile = currentChat.myProfile || { name: '我', avatarId: myMomentsProfile.avatarId };
            const duration = Math.max(1, Math.round(text.length / 5));
            const voiceMsg = { id: Date.now(), sender: 'sent', type: 'voice', text, duration, avatarId: myProfile.avatarId };
            if (!currentChat.chatHistory) currentChat.chatHistory = [];
            currentChat.chatHistory.push(voiceMsg);
            await appendMessageToChat(voiceMsg);
            await saveData();
            closeModal('send-voice-modal');
        });
        document.getElementById('gift-action-btn').addEventListener('click', () => {
            const recipientGroup = document.getElementById('gift-recipient-group');
            const recipientSelect = document.getElementById('gift-recipient-select');
            if (activeChat.isGroup) {
                const group = groupChats.find(gc => gc.id === activeChat.id);
                recipientSelect.innerHTML = '';
                group.memberIds.forEach(id => {
                    const contact = contacts.find(c => c.id === id);
                    if (contact) {
                        const option = document.createElement('option');
                        option.value = contact.id;
                        option.textContent = getDisplayName(contact);
                        recipientSelect.appendChild(option);
                    }
                });
                recipientGroup.style.display = 'block';
            } else {
                recipientGroup.style.display = 'none';
            }
            document.getElementById('gift-name').value = '';
            openModal('send-gift-modal');
        });
        document.getElementById('confirm-send-gift-btn').addEventListener('click', async () => {
            const giftName = document.getElementById('gift-name').value.trim();
            if (!giftName) { alert('礼物名称不能为空！'); return; }
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (!currentChat) return;
            const myProfile = currentChat.myProfile || { avatarId: myMomentsProfile.avatarId };
            let recipientId = null;
            if (activeChat.isGroup) {
                recipientId = Number(document.getElementById('gift-recipient-select').value);
            } else {
                recipientId = activeChat.id;
            }
            const giftMsg = { id: Date.now(), sender: 'sent', type: 'gift', text: giftName, avatarId: myProfile.avatarId, recipientId };
            if (!currentChat.chatHistory) currentChat.chatHistory = [];
            currentChat.chatHistory.push(giftMsg);
            await appendMessageToChat(giftMsg);
            await saveData();
            closeModal('send-gift-modal');
        });
        document.getElementById('call-action-btn').addEventListener('click', () => setupAndShowCallScreen());
        document.getElementById('chat-summary-action-btn').addEventListener('click', () => {
            const summaryContent = document.getElementById('chat-summary-content');
            const summaryBtn = document.getElementById('start-chat-summary-btn');
            summaryContent.value = '';
            summaryContent.placeholder = "点击下方按钮开始生成聊天总结...";
            summaryBtn.disabled = false;
            summaryBtn.textContent = '开始总结';
            openModal('chat-summary-modal');
        });
        document.getElementById('start-chat-summary-btn').addEventListener('click', async () => {
            if (!apiSettings.baseUrl || !apiSettings.apiKey || !apiSettings.model) {
                alert('请先在API应用中完成设置！');
                return;
            }

            const summaryContent = document.getElementById('chat-summary-content');
            const summaryBtn = document.getElementById('start-chat-summary-btn');
            const currentChat = activeChat.isGroup 
                ? groupChats.find(gc => gc.id === activeChat.id) 
                : contacts.find(c => c.id === activeChat.id);

            if (!currentChat || !currentChat.chatHistory || currentChat.chatHistory.length === 0) {
                alert('没有聊天记录可以总结。');
                return;
            }

            summaryBtn.disabled = true;
            summaryBtn.textContent = '总结中...';
            summaryContent.value = '正在分析聊天记录，请稍候...';

            try {
                const myProfile = currentChat.myProfile || { name: '我' };
                const contactForPrompt = activeChat.isGroup 
                    ? { name: currentChat.name, persona: '一个群聊' } 
                    : currentChat;

                const fullChatHistory = currentChat.chatHistory.map(msg => {
                    let speaker;
                    if (msg.sender === 'sent') {
                        speaker = myProfile.name || '我';
                    } else if (activeChat.isGroup) {
                        const member = contacts.find(c => c.id === msg.contactId);
                        speaker = member ? getDisplayName(member) : '群成员';
                    } else {
                        speaker = getDisplayName(contactForPrompt);
                    }
                    
                    let textContent = msg.text || `[${msg.type}]`;
                    if (msg.type === 'reply' && msg.quote) {
                        textContent = `[回复 ${msg.quote.authorName}] ${textContent}`;
                    }
                    return `${speaker}: ${textContent}`;
                }).join('\n');

                const prompt = getBaseSystemPrompt(
                    contactForPrompt, 
                    myProfile, 
                    '', '', '', null, 
                    'chat_summary', 
                    { fullChatHistory }
                );

                const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` },
                    body: JSON.stringify({ 
                        model: apiSettings.model, 
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1024 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API请求失败: ${response.status}\n${errorText}`);
                }

                const data = await response.json();
                const summary = data.choices[0]?.message?.content || '总结失败，未收到有效内容。';
                summaryContent.value = summary.trim();

            } catch (error) {
                console.error("Chat summary error:", error);
                summaryContent.value = `生成总结时出错：\n${error.message}`;
            } finally {
                summaryBtn.disabled = false;
                summaryBtn.textContent = '重新总结';
            }
        });
        
        document.getElementById('chat-music-action-btn').addEventListener('click', () => {
            renderChatMusicLibrary();
            openModal('music-library-modal');
        });

        document.getElementById('music-library-modal').addEventListener('click', async (e) => {
            const tab = e.target.closest('.music-library-tab');
            if (tab) {
                document.querySelectorAll('.music-library-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.music-library-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                return;
            }

            const deleteBtn = e.target.closest('.music-library-item .delete-btn');
            if (deleteBtn) {
                const songId = Number(deleteBtn.dataset.id);
                if (confirm('确定要删除这首歌曲吗？')) {
                    chatMusicLibrary = chatMusicLibrary.filter(s => s.id !== songId);
                    await saveData();
                    renderChatMusicLibrary();
                }
                return;
            }

            const songItem = e.target.closest('.music-library-item');
            if (songItem) {
                const songId = Number(songItem.dataset.id);
                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                if (!currentChat) return;
                const myProfile = currentChat.myProfile || { avatarId: myMomentsProfile.avatarId };
                const musicMsg = { id: Date.now(), sender: 'sent', type: 'chat_music', songId, avatarId: myProfile.avatarId };
                if (!currentChat.chatHistory) currentChat.chatHistory = [];
                currentChat.chatHistory.push(musicMsg);
                await appendMessageToChat(musicMsg);
                await saveData();
                closeModal('music-library-modal');
                return;
            }

            if (e.target.id === 'save-new-song-btn') {
                const name = document.getElementById('upload-song-name').value.trim();
                const url = document.getElementById('upload-song-url').value.trim();
                if (!name || !url) {
                    alert('歌曲名字和URL链接是必填项！');
                    return;
                }
                const newSong = {
                    id: Date.now(),
                    name,
                    url,
                    artist: document.getElementById('upload-song-artist').value.trim(),
                    lyrics: document.getElementById('upload-song-lyrics').value.trim(),
                    coverId: tempImageId.chatMusicCover || null
                };
                chatMusicLibrary.push(newSong);
                await saveData();
                
                document.getElementById('upload-song-name').value = '';
                document.getElementById('upload-song-url').value = '';
                document.getElementById('upload-song-artist').value = '';
                document.getElementById('upload-song-lyrics').value = '';
                document.getElementById('upload-song-cover-preview').src = await getImageById(null);
                tempImageId.chatMusicCover = null;

                alert('歌曲已保存！');
                document.querySelector('.music-library-tab[data-tab="local-library"]').click();
                renderChatMusicLibrary();
                return;
            }
        });

        const player = document.getElementById('chat-music-player');
        const playerHeader = player.querySelector('.player-header');

        // --- 核心修改：重构拖动逻辑以支持触摸事件 ---
        const handleDragStart = (e) => {
            if (e.target.closest('.player-close-btn')) return;
            // 阻止触摸事件的默认行为（如页面滚动）
            if (e.type === 'touchstart') {
                e.preventDefault();
            }
            chatMusicPlayerState.isDragging = true;
            player.style.transition = 'none';
            const touch = e.touches ? e.touches[0] : e;
            chatMusicPlayerState.offsetX = touch.clientX - player.offsetLeft;
            chatMusicPlayerState.offsetY = touch.clientY - player.offsetTop;
        };

        const handleDragMove = (e) => {
            if (!chatMusicPlayerState.isDragging) return;
            const touch = e.touches ? e.touches[0] : e;
            const phoneRect = phoneScreen.getBoundingClientRect();
            let newX = touch.clientX - chatMusicPlayerState.offsetX;
            let newY = touch.clientY - chatMusicPlayerState.offsetY;
            newX = Math.max(0, Math.min(newX, phoneRect.width - player.offsetWidth));
            newY = Math.max(0, Math.min(newY, phoneRect.height - player.offsetHeight));
            player.style.left = `${newX}px`;
            player.style.top = `${newY}px`;
        };

        const handleDragEnd = () => {
            if (!chatMusicPlayerState.isDragging) return;
            chatMusicPlayerState.isDragging = false;
            player.style.transition = '';
        };

        // 监听鼠标事件
        playerHeader.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);

        // 监听触摸事件，以兼容手机拖动
        playerHeader.addEventListener('touchstart', handleDragStart, { passive: false });
        document.addEventListener('touchmove', handleDragMove);
        document.addEventListener('touchend', handleDragEnd);
        // --- 核心修改结束 ---

        player.addEventListener('click', (e) => {
            if (e.target.closest('.player-close-btn')) {
                player.classList.remove('active');
                chatMusicPlayerState.audioElement.pause();
                return;
            }
            if (e.target.closest('#player-play-pause-btn')) {
                const audio = chatMusicPlayerState.audioElement;
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                }
                return;
            }
            if (e.target.closest('#player-next-btn')) {
                const currentIndex = chatMusicLibrary.findIndex(s => s.id === chatMusicPlayerState.currentSongId);
                const nextIndex = (currentIndex + 1) % chatMusicLibrary.length;
                playChatMusic(chatMusicLibrary[nextIndex].id);
                return;
            }
            if (e.target.closest('#player-prev-btn')) {
                const currentIndex = chatMusicLibrary.findIndex(s => s.id === chatMusicPlayerState.currentSongId);
                const prevIndex = (currentIndex - 1 + chatMusicLibrary.length) % chatMusicLibrary.length;
                playChatMusic(chatMusicLibrary[prevIndex].id);
                return;
            }
            const progressBarWrapper = e.target.closest('.player-progress-bar-wrapper');
            if (progressBarWrapper) {
                const audio = chatMusicPlayerState.audioElement;
                const rect = progressBarWrapper.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;
                audio.currentTime = audio.duration * percentage;
                return;
            }
        });

        chatMusicPlayerState.audioElement = document.getElementById('chat-music-player-audio');
        const audio = chatMusicPlayerState.audioElement;
        audio.addEventListener('play', () => {
            document.getElementById('player-play-pause-btn').innerHTML = pauseSVG;
            chatMusicPlayerState.isPlaying = true;
        });
        audio.addEventListener('pause', () => {
            document.getElementById('player-play-pause-btn').innerHTML = playSVG;
            chatMusicPlayerState.isPlaying = false;
        });
        audio.addEventListener('ended', () => {
            document.getElementById('player-next-btn').click();
        });
        audio.addEventListener('loadedmetadata', () => {
            document.getElementById('player-duration').textContent = formatTime(audio.duration);
        });
        audio.addEventListener('timeupdate', () => {
            const currentTime = audio.currentTime;
            const duration = audio.duration;
            if (duration > 0) {
                const progress = (currentTime / duration) * 100;
                document.querySelector('.player-progress-bar').style.width = `${progress}%`;
            }
            document.getElementById('player-current-time').textContent = formatTime(currentTime);
        });

        document.getElementById('hang-up-btn').addEventListener('click', () => endCall());
        document.getElementById('call-avatar-container').addEventListener('click', () => { if(activeCallState.isActive) { document.getElementById('call-input-text').value = ''; openModal('call-input-modal'); } });
        document.getElementById('confirm-call-input-btn').addEventListener('click', async () => {
            const text = document.getElementById('call-input-text').value.trim();
            if (!text || !activeCallState.isActive) return;
            const currentChat = activeCallState.isGroup ? groupChats.find(gc => gc.id === activeCallState.chatId) : contacts.find(c => c.id === activeCallState.chatId);
            const myName = currentChat.myProfile.name || '我';
            activeCallState.transcript.push({ speaker: myName, text });
            renderCallTranscript();
            closeModal('call-input-modal');
            await getAiCallResponse();
        });
        document.getElementById('multi-select-btn').addEventListener('click', async () => { isDeletionMode = !isDeletionMode; const chatArea = document.getElementById('chat-area'); const multiSelectBtn = document.getElementById('multi-select-btn'); if (isDeletionMode) { chatArea.classList.add('deletion-mode'); multiSelectBtn.innerHTML = `🗑️`; multiSelectBtn.style.color = 'var(--danger-color)'; } else { if (messagesToDelete.size > 0) { if (confirm(`确定要删除选中的 ${messagesToDelete.size} 条消息吗？`)) { const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id); if(currentChat) { currentChat.chatHistory = currentChat.chatHistory.filter(m => !messagesToDelete.has(m.id)); messagesToDelete.forEach(id => document.querySelector(`.message[data-id="${id}"]`)?.remove()); await saveData(); } } } chatArea.classList.remove('deletion-mode'); chatArea.querySelectorAll('.selected-for-deletion').forEach(el => el.classList.remove('selected-for-deletion')); multiSelectBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-8h14V7H7v2z"></path></svg>`; multiSelectBtn.style.color = 'inherit'; messagesToDelete.clear(); } });
        document.getElementById('moments-header-bg').addEventListener('click', async () => { tempImageId = {}; document.getElementById('edit-moments-name').value = myMomentsProfile.name || '我'; document.getElementById('edit-moments-signature').value = myMomentsProfile.signature || ''; document.getElementById('edit-moments-avatar-preview').src = await getImageById(myMomentsProfile.avatarId); document.getElementById('edit-moments-bg-preview').src = myMomentsProfile.headerBgId ? await getImageById(myMomentsProfile.headerBgId) : 'https://files.catbox.moe/p1n9y0.jpg'; openModal('edit-moments-profile-modal'); });
        document.getElementById('save-edit-moments-profile-btn').addEventListener('click', async () => { myMomentsProfile.name = document.getElementById('edit-moments-name').value.trim() || '我'; myMomentsProfile.signature = document.getElementById('edit-moments-signature').value.trim(); if (tempImageId.momentsAvatar) myMomentsProfile.avatarId = tempImageId.momentsAvatar; if (tempImageId.momentsBg) myMomentsProfile.headerBgId = tempImageId.momentsBg; closeModal('edit-moments-profile-modal'); await renderMoments(); await saveData(); });
        document.getElementById('moments-my-post-btn').addEventListener('click', () => {
            const isForumActive = document.querySelector('.forum-feed.active');
            if (isForumActive) {
                document.getElementById('my-forum-post-title').value = '';
                document.getElementById('my-forum-post-text').value = '';
                document.getElementById('my-forum-post-image-desc').value = '';
                openModal('post-forum-modal');
            } else {
                document.getElementById('my-moments-text').value = '';
                document.getElementById('my-moments-image-desc').value = '';
                openModal('post-moments-modal');
            }
        });
        document.getElementById('confirm-my-moments-btn').addEventListener('click', async () => {
            const text = document.getElementById('my-moments-text').value.trim();
            const imageDesc = document.getElementById('my-moments-image-desc').value.trim();
            if (!text) return;
            const newMoment = { id: Date.now(), authorId: 'me', text: text, imageDesc: imageDesc || null, comments: [], likes: [] };
            moments.push(newMoment);
            await renderMoments();
            await saveData();
            closeModal('post-moments-modal');

            if (apiSettings.baseUrl) {
                contacts.forEach((contact, index) => {
                    setTimeout(async () => {
                        if (!newMoment.likes.includes(contact.id)) {
                            newMoment.likes.push(contact.id);
                        }
                        await renderSingleMoment(newMoment.id);
                        await saveData();

                        const boundBooks = (contact.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)).filter(Boolean);
                        const worldBookContent = boundBooks.map(b => b.content).join('\n\n');
                        const prompt = getBaseSystemPrompt(contact, contact.myProfile, worldBookContent, '', '', null, 'moment_comment', { postAuthorName: contact.myProfile.name, postText: text });
                        await triggerAIComment(prompt, contact.id, newMoment);
                    }, 1000 + index * (1000 + Math.random() * 2000));
                });
            }
        });
        document.getElementById('moments-ai-post-btn').addEventListener('click', () => {
            const isForumActive = document.querySelector('.forum-feed.active');
            if (isForumActive) {
                openModal('select-forum-ai-post-modal');
            } else {
                if (contacts.length === 0) { alert("你还没有联系人"); return; }
                const list = document.getElementById('ai-post-selection-list');
                list.innerHTML = '';
                contacts.forEach(contact => {
                    const contactBtn = document.createElement('button');
                    contactBtn.className = 'btn';
                    contactBtn.textContent = getDisplayName(contact);
                    contactBtn.onclick = () => { triggerSingleAiPost(contact.id); closeModal('select-ai-post-modal'); };
                    list.appendChild(contactBtn);
                });
                openModal('select-ai-post-modal');
            }
        });
        
        document.getElementById('confirm-my-forum-post-btn').addEventListener('click', async () => {
            const title = document.getElementById('my-forum-post-title').value.trim();
            const text = document.getElementById('my-forum-post-text').value.trim();
            const imageDesc = document.getElementById('my-forum-post-image-desc').value.trim();
            if (!title || !text) { alert('标题和内容不能为空！'); return; }
            const newPost = { id: Date.now(), authorId: 'me', title, text, imageDesc: imageDesc || null, comments: [], likes: [] };
            forumPosts.push(newPost);
            await renderForum();
            await saveData();
            closeModal('post-forum-modal');
            triggerForumInteraction(newPost);
        });

        document.getElementById('trigger-random-forum-posts').addEventListener('click', () => {
            closeModal('select-forum-ai-post-modal');
            triggerRandomForumPosts();
        });

        document.querySelector('#forum-feed-container').addEventListener('click', async (e) => {
            const postItem = e.target.closest('.forum-post-item');
            if (!postItem) return;
            const postId = Number(postItem.dataset.postId);
            const post = forumPosts.find(p => p.id === postId);
            if (!post) return;

            const postLikeBtn = e.target.closest('.forum-like-post-btn');
            if (postLikeBtn) {
                if (!post.likes) post.likes = [];
                const myLikeIndex = post.likes.indexOf('me');
                if (myLikeIndex > -1) { post.likes.splice(myLikeIndex, 1); } else { post.likes.push('me'); }
                await renderSingleForumPost(postId);
                await saveData();
                return;
            }

            const commentLikeBtn = e.target.closest('.forum-comment-like-btn');
            if (commentLikeBtn) {
                const commentItem = e.target.closest('.forum-post-comment');
                const commentIndex = Number(commentItem.dataset.commentIndex);
                const comment = post.comments[commentIndex];
                if (!comment.likes) comment.likes = [];
                const myLikeIndex = comment.likes.indexOf('me');
                if (myLikeIndex > -1) { comment.likes.splice(myLikeIndex, 1); } else { comment.likes.push('me'); }
                await renderSingleForumPost(postId);
                await saveData();
                return;
            }

            const postCommentBtn = e.target.closest('.forum-comment-post-btn');
            if (postCommentBtn) {
                const inputContainer = postItem.querySelector('.comment-input-container');
                activeReplyTarget = null;
                inputContainer.querySelector('input').placeholder = '发表你的看法...';
                inputContainer.classList.toggle('active');
                if (inputContainer.classList.contains('active')) { inputContainer.querySelector('input').focus(); }
                return;
            }

            const commentMain = e.target.closest('.forum-comment-main');
            if (commentMain && !e.target.closest('.forum-comment-like-btn')) {
                const commentItem = commentMain.closest('.forum-post-comment');
                const commentIndex = Number(commentItem.dataset.commentIndex);
                const comment = post.comments[commentIndex];
                if (comment.authorId === 'me') return;

                let authorName = comment.authorName || '某人';
                if (comment.authorType === 'contact') {
                    const contact = contacts.find(c => c.id === comment.authorId);
                    if (contact) authorName = getDisplayName(contact);
                }

                const inputContainer = postItem.querySelector('.comment-input-container');
                activeReplyTarget = { postId, replyTo: comment.authorId, replyToName: authorName };
                inputContainer.querySelector('input').placeholder = `回复 ${authorName}:`;
                inputContainer.classList.add('active');
                inputContainer.querySelector('input').focus();
                return;
            }

            const deleteBtn = e.target.closest('.forum-delete-post-btn');
            if (deleteBtn) {
                if (confirm('确定要删除这个帖子吗？')) {
                    forumPosts = forumPosts.filter(p => p.id !== postId);
                    await renderForum();
                    await saveData();
                }
                return;
            }

            const sendCommentBtn = e.target.closest('.comment-input-container button');
            if (sendCommentBtn) {
                const inputContainer = sendCommentBtn.closest('.comment-input-container');
                const input = inputContainer.querySelector('input');
                const myCommentText = input.value.trim();
                if (!myCommentText) return;

                const newComment = { id: Date.now(), authorId: 'me', authorName: myMomentsProfile.name, text: myCommentText, likes: [] };
                let replyToInfo = null;
                if (activeReplyTarget && activeReplyTarget.postId === postId) {
                    newComment.replyTo = activeReplyTarget.replyTo;
                    newComment.replyToName = activeReplyTarget.replyToName;
                    replyToInfo = { id: activeReplyTarget.replyTo, name: activeReplyTarget.replyToName };
                }
                post.comments.push(newComment);

                input.value = '';
                inputContainer.classList.remove('active');
                await renderSingleForumPost(postId);
                await saveData();
                activeReplyTarget = null;

                if (post.authorId !== 'me') {
                    setTimeout(async () => {
                        let postAuthor;
                        if (post.authorType === 'contact') {
                            postAuthor = { ...contacts.find(c => c.id === post.authorId), isStranger: false };
                        } else {
                            postAuthor = { name: post.authorName, avatar: post.authorAvatar, isStranger: true };
                        }
                        if (postAuthor) {
                            await triggerAIForumReply(post, newComment, postAuthor);
                            await renderSingleForumPost(post.id);
                            await saveData();
                        }
                    }, 4000 + Math.random() * 5000);
                }
                return;
            }
        });

        async function triggerAIComment(prompt, contactId, moment, replyTo = null) { try { const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] }) }); if (response.ok) { const data = await response.json(); const commentText = data.choices[0]?.message?.content || ''; if (!moment.comments) moment.comments = []; moment.comments.push({ authorId: contactId, text: commentText, replyTo }); await renderSingleMoment(moment.id); await saveData(); } } catch (err) { console.error('AI comment failed:', err); } }
        document.querySelector('#moments-feed-container').addEventListener('click', async (e) => {
            const likeBtn = e.target.closest('.like-btn');
            if (likeBtn) { const momentItem = likeBtn.closest('.moment-item'); const momentId = Number(momentItem.dataset.momentId); const moment = moments.find(m => m.id === momentId); if (!moment.likes) moment.likes = []; const myLikeIndex = moment.likes.indexOf('me'); if (myLikeIndex > -1) { moment.likes.splice(myLikeIndex, 1); } else { moment.likes.push('me'); } await renderSingleMoment(momentId); await saveData(); return; }
            const commentBtn = e.target.closest('.comment-btn');
            if (commentBtn) { const contentDiv = commentBtn.closest('.content'); const inputContainer = contentDiv.querySelector('.comment-input-container'); activeReplyTarget = null; inputContainer.querySelector('input').placeholder = '评论...'; inputContainer.classList.toggle('active'); if (inputContainer.classList.contains('active')) { inputContainer.querySelector('input').focus(); } return; }
            const momentComment = e.target.closest('.moment-comment');
            if(momentComment) { const momentItem = momentComment.closest('.moment-item'); const momentId = Number(momentItem.dataset.momentId); const moment = moments.find(m => m.id === momentId); const commentIndex = Number(momentComment.dataset.commentIndex); const comment = moment.comments[commentIndex]; if (comment.authorId === 'me') return; const contact = contacts.find(c => c.id === comment.authorId); const authorName = getDisplayName(contact); const inputContainer = momentItem.querySelector('.comment-input-container'); activeReplyTarget = { momentId, replyTo: comment.authorId }; inputContainer.querySelector('input').placeholder = `回复 ${authorName}:`; inputContainer.classList.add('active'); inputContainer.querySelector('input').focus(); return; }
            const deleteBtn = e.target.closest('.moment-delete-btn');
            if (deleteBtn) { if (confirm('确定要删除这条朋友圈吗？')) { const momentItem = deleteBtn.closest('.moment-item'); const momentId = Number(momentItem.dataset.momentId); moments = moments.filter(m => m.id !== momentId); await renderMoments(); await saveData(); } return; }
            const sendCommentBtn = e.target.closest('.comment-input-container button');
            if (sendCommentBtn) {
                const inputContainer = sendCommentBtn.closest('.comment-input-container');
                const input = inputContainer.querySelector('input');
                const myCommentText = input.value.trim();
                if (!myCommentText) return;

                const momentItem = sendCommentBtn.closest('.moment-item');
                const momentId = Number(momentItem.dataset.momentId);
                const moment = moments.find(m => m.id === momentId);
                
                const newComment = { authorId: 'me', text: myCommentText };
                let replyToContactId = null;
                if (activeReplyTarget && activeReplyTarget.momentId === momentId) {
                    newComment.replyTo = activeReplyTarget.replyTo;
                    replyToContactId = activeReplyTarget.replyTo;
                }
                moment.comments.push(newComment);
                
                input.value = '';
                inputContainer.classList.remove('active');
                await renderSingleMoment(momentId);
                await saveData();
                activeReplyTarget = null;

                const momentAuthorId = moment.authorId;
                if (momentAuthorId !== 'me' && apiSettings.baseUrl) {
                    const momentAuthorContact = contacts.find(c => c.id === momentAuthorId);
                    if (momentAuthorContact) {
                        const boundBooks = (momentAuthorContact.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)).filter(Boolean);
                        const worldBookContent = boundBooks.map(b => b.content).join('\n\n');
                        const prompt = getBaseSystemPrompt(momentAuthorContact, momentAuthorContact.myProfile, worldBookContent, '', '', null, 'moment_reply', { commentAuthorName: momentAuthorContact.myProfile.name, commentText: myCommentText });
                        await triggerAIComment(prompt, momentAuthorContact.id, moment, 'me');
                    }
                }
                
                if (replyToContactId && replyToContactId !== 'me') {
                    const contact = contacts.find(c => c.id === replyToContactId);
                    if (contact && apiSettings.baseUrl) {
                        const boundBooks = (contact.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)).filter(Boolean);
                        const worldBookContent = boundBooks.map(b => b.content).join('\n\n');
                        const prompt = getBaseSystemPrompt(contact, contact.myProfile, worldBookContent, '', '', null, 'moment_reply', { commentAuthorName: contact.myProfile.name, commentText: myCommentText });
                        await triggerAIComment(prompt, contact.id, moment, 'me');
                    }
                }
                return;
            }
        });
        document.getElementById('add-worldbook-btn').addEventListener('click', () => { document.getElementById('worldbook-id').value = ''; document.getElementById('worldbook-name').value = ''; document.getElementById('worldbook-content').value = ''; openModal('worldbook-modal'); });
        document.getElementById('worldbook-list-container').addEventListener('click', (e) => { const item = e.target.closest('.list-item'); if (e.target.classList.contains('delete-btn')) { const bookId = Number(e.target.dataset.id); if (confirm('确定要删除这本世界书吗？所有绑定关系将解除。')) { worldBooks = worldBooks.filter(wb => wb.id !== bookId); contacts.forEach(c => { if (c.worldBookIds) c.worldBookIds = c.worldBookIds.filter(id => id !== bookId); }); groupChats.forEach(gc => { if (gc.worldBookIds) gc.worldBookIds = gc.worldBookIds.filter(id => id !== bookId); }); saveData(); renderWorldBooks(); } } else if (item) { const bookId = Number(item.dataset.id); const book = worldBooks.find(wb => wb.id === bookId); if (book) { document.getElementById('worldbook-id').value = book.id; document.getElementById('worldbook-name').value = book.name; document.getElementById('worldbook-content').value = book.content; openModal('worldbook-modal'); } } });
        document.getElementById('save-worldbook-btn').addEventListener('click', async () => { const id = Number(document.getElementById('worldbook-id').value); const name = document.getElementById('worldbook-name').value.trim(); const content = document.getElementById('worldbook-content').value.trim(); if (!name) { alert('书名不能为空'); return; } if (id) { const book = worldBooks.find(wb => wb.id === id); if (book) { book.name = name; book.content = content; } } else { worldBooks.push({ id: Date.now(), name, content }); } await saveData(); renderWorldBooks(); closeModal('worldbook-modal'); });
        document.getElementById('gomoku-opponent-selection').addEventListener('click', async (e) => { const opponentItem = e.target.closest('.list-item'); if(opponentItem) { const contactId = Number(opponentItem.dataset.id); startGomokuGame(contactId); } });
        document.getElementById('gomoku-board').addEventListener('click', handleGomokuBoardClick);
        document.getElementById('gomoku-rematch-btn').addEventListener('click', () => { closeModal('gomoku-result-modal'); startGomokuGame(gomokuGame.opponentContactId); });
        document.getElementById('gomoku-change-opponent-btn').addEventListener('click', () => { closeModal('gomoku-result-modal'); showGomokuOpponentSelection(); });
        
        document.getElementById('rps-opponent-selection-modal').addEventListener('click', async (e) => {
            const opponentItem = e.target.closest('.list-item');
            if (opponentItem) {
                const contactId = Number(opponentItem.dataset.id);
                await startRpsGame(contactId);
            }
        });
        document.getElementById('screen-rps').addEventListener('click', async (e) => {
            const target = e.target;
            if (target.closest('#rps-player-avatar')) {
                document.getElementById('rps-emoji-popup').classList.toggle('active');
            } else if (target.closest('.rps-emoji-option')) {
                const emoji = target.textContent;
                sendRpsEmoji(emoji);
                document.getElementById('rps-emoji-popup').classList.remove('active');
            } else if (target.closest('#rps-controls button')) {
                const buttonId = target.closest('button').id;
                if (buttonId === 'rps-rematch-btn') {
                    resetRpsGame();
                } else {
                    handleRpsPlayerChoice(buttonId.split('-')[1]);
                }
            }
        });

        document.getElementById('add-song-btn').addEventListener('click', () => { document.getElementById('add-song-name').value = ''; document.getElementById('add-song-url').value = ''; openModal('add-song-modal'); });
        document.getElementById('upload-song-file-btn').addEventListener('click', () => document.getElementById('song-file-input').click());
        document.getElementById('song-file-input').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) { document.getElementById('add-song-name').value = file.name.replace(/\.[^/.]+$/, ""); document.getElementById('add-song-url').value = await fileToBase64(file); } });
        document.getElementById('confirm-add-song-btn').addEventListener('click', async () => { const name = document.getElementById('add-song-name').value.trim(); const url = document.getElementById('add-song-url').value.trim(); if (!name || !url) { alert('歌曲名称和URL/文件均不能为空'); return; } musicAppData.playlist.push({ name, url }); await saveData(); renderMusicPlaylist(); closeModal('add-song-modal'); });
        document.getElementById('screen-music').addEventListener('click', (e) => { if(e.target.closest('#music-avatar-left')) { if (contacts.length === 0) { alert('请先创建联系人'); return; } const list = document.getElementById('music-partner-selection-list'); list.innerHTML = ''; contacts.forEach(contact => { const contactBtn = document.createElement('button'); contactBtn.className = 'btn'; contactBtn.textContent = getDisplayName(contact); contactBtn.onclick = async () => { musicAppData.currentPartnerId = contact.id; await saveData(); renderMusicScreen(); closeModal('select-music-partner-modal'); }; list.appendChild(contactBtn); }); openModal('select-music-partner-modal'); } else if (e.target.closest('#music-avatar-right')) { if (musicAppData.currentPartnerId) { document.getElementById('music-chat-input-text').value = ''; openModal('music-chat-input-modal'); } } });
        document.getElementById('confirm-music-chat-btn').addEventListener('click', () => { const text = document.getElementById('music-chat-input-text').value.trim(); if (text) { handleSendMusicChatMessage(text); } });
        document.getElementById('music-playlist-container').addEventListener('click', (e) => {
            const songItem = e.target.closest('.music-song-item');
            if (isMusicDeleteMode) {
                if (e.target.closest('.delete-song-item-btn')) {
                    const songNameToDelete = e.target.closest('.delete-song-item-btn').dataset.name;
                    musicAppData.playlist = musicAppData.playlist.filter(song => song.name !== songNameToDelete);
                    saveData();
                    renderMusicPlaylist();
                }
                return;
            }
            if (songItem) {
                const url = songItem.dataset.url;
                const player = document.getElementById('music-player-element');
                const isCurrentlyPlaying = player.src === url && !player.paused;
                if (isCurrentlyPlaying) {
                    player.pause();
                } else {
                    if (player.src !== url) player.src = url;
                    player.play().catch(err => alert("音频播放失败，请检查URL或文件是否有效。"));
                }
            }
        });
        document.getElementById('delete-song-btn').addEventListener('click', () => { isMusicDeleteMode = !isMusicDeleteMode; const playlistContainer = document.getElementById('music-playlist-container'); const deleteBtn = document.getElementById('delete-song-btn'); playlistContainer.classList.toggle('deletion-mode', isMusicDeleteMode); deleteBtn.style.color = isMusicDeleteMode ? 'var(--danger-color)' : ''; });
        document.getElementById('sticker-action-btn').addEventListener('click', () => { stickerPickerState.currentPage = 1; renderStickerPicker(); openModal('sticker-picker-modal'); });
        document.getElementById('select-sticker-files-btn').addEventListener('click', () => document.getElementById('add-sticker-input').click());
        document.getElementById('confirm-add-sticker-btn').addEventListener('click', async () => {
            const confirmBtn = document.getElementById('confirm-add-sticker-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '处理中...';

            const files = Array.from(document.getElementById('add-sticker-input').files);
            const urlLines = document.getElementById('add-sticker-url').value.trim().split('\n').filter(line => line.trim() !== '');
            
            const urlItems = urlLines.map(line => {
                const parts = line.split(',');
                const url = parts[0].trim();
                const description = parts.length > 1 ? parts.slice(1).join(',').trim() : '';
                return { source: url, description: description, type: 'url' };
            });

            const fileItemsPromises = files.map(async (file) => {
                try {
                    const base64 = await fileToBase64(file);
                    return { source: base64, description: '', type: 'base64' };
                } catch (error) {
                    console.error("Error converting file to Base64:", error);
                    return null;
                }
            });
            const fileItems = (await Promise.all(fileItemsPromises)).filter(Boolean);

            const allItems = [...urlItems, ...fileItems];

            if (allItems.length === 0) {
                alert('请选择文件或输入URL！');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '下一步';
                return;
            }

            const validationPromises = allItems.map(item => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve({ ...item, valid: true });
                    img.onerror = () => resolve({ ...item, valid: false });
                    img.src = item.source;
                });
            });

            const validationResults = await Promise.all(validationPromises);
            const validItems = validationResults.filter(res => res.valid);
            const invalidCount = allItems.length - validItems.length;

            if (invalidCount > 0) {
                alert(`有 ${invalidCount} 个图片或链接无效，已自动跳过。`);
            }

            if (validItems.length === 0) {
                alert('没有有效的图片可供添加。');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '下一步';
                return;
            }

            stickerBatch = { items: validItems, currentIndex: 0 };
            closeModal('add-sticker-modal');
            renderBatchStickerModal();
            openModal('batch-add-sticker-modal');
            confirmBtn.disabled = false;
            confirmBtn.textContent = '下一步';
        });
        document.getElementById('save-next-sticker-btn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('save-next-sticker-btn');
            if (saveBtn.disabled) return;

            const desc = document.getElementById('batch-sticker-desc').value.trim();
            if (!desc) {
                alert('请填写表情包描述！');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            try {
                const currentItem = stickerBatch.items[stickerBatch.currentIndex];
                let imageId;

                if (currentItem.type === 'url') {
                    imageId = currentItem.source;
                } else { // type is 'base64'
                    const id = `img_${Date.now()}_${Math.random()}`;
                    try {
                        const transaction = db.transaction(["images"], "readwrite");
                        const store = transaction.objectStore("images");
                        store.put({ id, data: currentItem.source });
                        imageId = id;
                    } catch (e) {
                        console.error("Error saving base64 image to IndexedDB:", e);
                        throw new Error("无法将Base64图片存入数据库");
                    }
                }

                if (imageId) {
                    stickers.push({ id: Date.now() + Math.random(), imageId, description: desc });
                    await saveData();
                } else {
                    throw new Error("无法获取图片ID");
                }

                stickerBatch.currentIndex++;

                if (stickerBatch.currentIndex < stickerBatch.items.length) {
                    await renderBatchStickerModal();
                } else {
                    alert(`成功添加所有 ${stickerBatch.items.length} 个表情包！`);
                    closeModal('batch-add-sticker-modal');
                }
            } catch (error) {
                console.error("Error saving single sticker:", error);
                alert("保存此表情包时发生错误，请重试。");
            } finally {
                saveBtn.disabled = false;
            }
        });
        document.getElementById('sticker-picker-modal').addEventListener('click', async (e) => {
            const target = e.target;
            const stickerItem = target.closest('.sticker-grid-item');

            if (target.closest('#sticker-delete-toggle-btn')) {
                isStickerDeleteMode = !isStickerDeleteMode;
                document.getElementById('sticker-grid').classList.toggle('deletion-mode', isStickerDeleteMode);
                target.closest('#sticker-delete-toggle-btn').style.color = isStickerDeleteMode ? 'var(--danger-color)' : '';
                return;
            }

            if (isStickerDeleteMode && stickerItem && stickerItem.dataset.stickerId) {
                const stickerId = Number(stickerItem.dataset.stickerId);
                if (confirm('确定要删除这个表情包吗？')) {
                    stickers = stickers.filter(s => s.id !== stickerId);
                    await saveData();
                    await renderStickerPicker();
                }
                return;
            }

            if (target.closest('.sticker-add-btn')) {
                closeModal('sticker-picker-modal');
                document.getElementById('add-sticker-url').value = '';
                document.getElementById('add-sticker-input').value = '';
                openModal('add-sticker-modal');
            } else if (stickerItem && stickerItem.dataset.imageId) {
                const imageId = stickerItem.dataset.imageId;
                const sticker = stickers.find(s => s.imageId === imageId);
                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                if (currentChat && sticker) {
                    const myProfile = currentChat.myProfile || { avatarId: myMomentsProfile.avatarId };
                    const stickerMsg = { id: Date.now(), sender: 'sent', type: 'sticker', imageId: imageId, description: sticker.description, avatarId: myProfile.avatarId };
                    if (!currentChat.chatHistory) currentChat.chatHistory = [];
                    currentChat.chatHistory.push(stickerMsg);
                    await appendMessageToChat(stickerMsg);
                    await saveData();
                    closeModal('sticker-picker-modal');
                }
            } else if (target.id === 'sticker-prev-btn') {
                if (stickerPickerState.currentPage > 1) {
                    stickerPickerState.currentPage--;
                    renderStickerPicker();
                }
            } else if (target.id === 'sticker-next-btn') {
                const totalStickers = stickers.length;
                const totalPages = Math.ceil((totalStickers) / stickerPickerState.stickersPerPage) || 1;
                if (stickerPickerState.currentPage < totalPages) {
                    stickerPickerState.currentPage++;
                    renderStickerPicker();
                }
            }
        });
        document.getElementById('import-export-modal').addEventListener('click', async (e) => {
            const contentDiv = document.getElementById('import-export-content');
            if (e.target.id === 'export-chat-btn') {
                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                if (!currentChat || !currentChat.chatHistory || currentChat.chatHistory.length === 0) {
                    alert('没有聊天记录可导出。');
                    return;
                }
                
                const participants = {};
                const myProfile = currentChat.myProfile || { name: '我', avatarId: myMomentsProfile.avatarId };
                participants['user_me'] = { name: myProfile.name, avatar: await getImageById(myProfile.avatarId) };

                if (activeChat.isGroup) {
                    for (const memberId of currentChat.memberIds) {
                        const contact = contacts.find(c => c.id === memberId);
                        if (contact) {
                            participants[contact.id] = { name: getDisplayName(contact), avatar: await getImageById(contact.avatarId) };
                        }
                    }
                } else {
                    participants[currentChat.id] = { name: getDisplayName(currentChat), avatar: await getImageById(currentChat.avatarId) };
                }

                const exportData = {
                    version: 2,
                    participants: participants,
                    chatHistory: currentChat.chatHistory
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                const chatName = activeChat.isGroup ? currentChat.name : getDisplayName(currentChat);
                const filename = `chat_history_${chatName}_${date}.json`;
                link.download = filename;
                link.href = url;
                link.className = 'btn';
                link.textContent = `点击下载: ${filename}`;
                contentDiv.innerHTML = `<p>您的记忆文件已准备就绪。</p>`;
                contentDiv.appendChild(link);
                
                link.onclick = () => {
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 60000);
                };
            }
            if (e.target.id === 'import-chat-btn') {
                document.getElementById('import-chat-input').click();
            }
        });
        document.body.addEventListener('change', async (event) => {
            if (event.target.id === 'chat-image-input') {
                const file = event.target.files[0];
                if (!file) return;
                const imageId = await storeImageAndGetId(file);
                if (imageId) {
                    const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                    if (!currentChat) return;
                    const myProfile = currentChat.myProfile || { avatarId: myMomentsProfile.avatarId };
                    const imageMsg = { id: Date.now(), sender: 'sent', type: 'image', imageId, avatarId: myProfile.avatarId };
                    if (!currentChat.chatHistory) currentChat.chatHistory = [];
                    currentChat.chatHistory.push(imageMsg);
                    await appendMessageToChat(imageMsg);
                    await saveData();
                }
                event.target.value = '';
            }
            if (event.target.id === 'import-chat-input') {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let importedHistory;
                        if (importedData.version === 2 && Array.isArray(importedData.chatHistory)) {
                            importedHistory = importedData.chatHistory;
                        } else if (Array.isArray(importedData)) {
                            importedHistory = importedData;
                        } else {
                            throw new Error('文件格式不正确。');
                        }

                        if (confirm('这将覆盖当前的聊天记录，确定要导入吗？')) {
                            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                            currentChat.chatHistory = importedHistory;
                            await saveData();
                            await renderChat(activeChat);
                            alert('聊天记录导入成功！');
                            document.querySelector('[data-action="close-import-export"]').click();
                        }
                    } catch (err) {
                        alert('导入失败：' + err.message);
                    }
                };
                reader.readAsText(file);
            }
            if (event.target.id === 'import-worldbooks-input') {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedBooks = JSON.parse(e.target.result);
                        if (!Array.isArray(importedBooks)) {
                            throw new Error('文件格式不正确，应为世界书数组。');
                        }
                        if (confirm('这将覆盖当前所有的世界书，确定要导入吗？')) {
                            worldBooks = importedBooks;
                            await saveData();
                            renderWorldBooks();
                            alert('世界书导入成功！');
                            document.querySelector('[data-action="close-worldbook-import-export"]').click();
                        }
                    } catch (err) {
                        alert('导入失败：' + err.message);
                    }
                };
                reader.readAsText(file);
            }
            if (event.target.id === 'sent-font-input' || event.target.id === 'received-font-input') {
                const file = event.target.files[0];
                if (!file) return;
                const fontInfo = await storeFontAndGetInfo(file);
                if (fontInfo) {
                    const isSent = event.target.id === 'sent-font-input';
                    const inputEl = document.getElementById(isSent ? 'edit-sent-font' : 'edit-received-font');
                    const previewEl = document.getElementById(isSent ? 'font-preview-sent' : 'font-preview-received');
                    inputEl.value = `"${fontInfo.name}"`;
                    previewEl.style.fontFamily = `"${fontInfo.name}"`;
                    tempImageId[isSent ? 'sentFontInfo' : 'receivedFontInfo'] = fontInfo;
                }
            }
            if (event.target.id === 'home-top-widget-input') {
                const file = event.target.files[0]; if (!file) return;
                const imageId = await storeImageAndGetId(file);
                if (imageId) { homeWidgetsData.topWidgetImageId = imageId; await saveData(); await renderHomeScreen(); }
            }
            if (event.target.id === 'home-large-photo-input') {
                const file = event.target.files[0]; if (!file) return;
                const imageId = await storeImageAndGetId(file);
                if (imageId) { homeWidgetsData.largePhotoImageId = imageId; await saveData(); await renderHomeScreen(); }
            }
            if (event.target.id === 'home-profile-avatar-input') {
                const file = event.target.files[0]; if (!file) return;
                const imageId = await storeImageAndGetId(file);
                if (imageId) { homeWidgetsData.profileAvatarId = imageId; await saveData(); await renderHomeScreen(); }
            }
        });
        document.getElementById('import-export-btn').addEventListener('click', () => openModal('import-export-modal'));
        document.getElementById('worldbook-import-export-btn').addEventListener('click', () => openModal('worldbook-import-export-modal'));
        document.getElementById('worldbook-import-export-modal').addEventListener('click', (e) => {
            const contentDiv = document.getElementById('worldbook-import-export-content');
            if (e.target.id === 'export-worldbooks-btn') {
                if (worldBooks.length === 0) {
                    alert('没有世界书可导出。');
                    return;
                }
                const dataStr = JSON.stringify(worldBooks, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                const filename = `worldbooks_backup_${date}.json`;
                link.download = filename;
                link.href = url;
                link.className = 'btn';
                link.textContent = `点击下载: ${filename}`;
                contentDiv.innerHTML = `<p>您的世界书备份文件已准备就绪。</p>`;
                contentDiv.appendChild(link);
                link.onclick = () => { setTimeout(() => { URL.revokeObjectURL(url); }, 60000); };
            }
            if (e.target.id === 'import-worldbooks-btn') {
                document.getElementById('import-worldbooks-input').click();
            }
        });
        document.getElementById('icon-customizer-list').addEventListener('click', async (e) => { const button = e.target.closest('.action-button'); if (button) { const appId = button.dataset.appId; const app = appConfig.find(a => a.id === appId); if (app) { document.getElementById('edit-icon-app-name').textContent = app.name; document.getElementById('edit-icon-app-id').value = appId; document.getElementById('edit-icon-preview').src = await getImageById(app.icon); document.getElementById('edit-icon-url').value = ''; tempImageId.appIcon = null; openModal('edit-app-icon-modal'); } } });
        document.getElementById('save-app-icon-btn').addEventListener('click', async () => { const appId = document.getElementById('edit-icon-app-id').value; const app = appConfig.find(a => a.id === appId); if (!app) return; const url = document.getElementById('edit-icon-url').value.trim(); if (url) { app.icon = url; } else if (tempImageId.appIcon) { app.icon = tempImageId.appIcon; } await saveData(); await renderHomeScreen(); await renderIconCustomizerApp(); closeModal('edit-app-icon-modal'); });
        document.body.addEventListener('input', e => {
            if (e.target.id === 'edit-bubble-css-raw') {
                document.getElementById('bubble-preview-style-tag').textContent = e.target.value;
            }
            if (e.target.id === 'edit-sent-font') {
                document.getElementById('font-preview-sent').style.fontFamily = e.target.value;
            }
            if (e.target.id === 'edit-received-font') {
                document.getElementById('font-preview-received').style.fontFamily = e.target.value;
            }
        });
        document.getElementById('chat-area').addEventListener('click', async (e) => {
            const bubble = e.target.closest('.bubble');
            const quoteIcon = e.target.closest('.quote-icon');
            const editIcon = e.target.closest('.edit-icon');
            const chatArea = document.getElementById('chat-area');

            if (bubble && !isDeletionMode) {
                const messageEl = bubble.closest('.message');
                if (messageEl.classList.contains('system')) return;

                chatArea.querySelectorAll('.message.quote-active').forEach(el => el.classList.remove('quote-active'));
                messageEl.classList.add('quote-active');
            } else if (quoteIcon) {
                const messageEl = quoteIcon.closest('.message');
                const msgId = Number(messageEl.dataset.id);
                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                const msg = currentChat.chatHistory.find(m => m.id === msgId);
                if (msg) {
                    let authorName;
                    if (msg.sender === 'sent') {
                        authorName = currentChat.myProfile?.name || '我';
                    } else {
                        const contact = contacts.find(c => c.id === msg.contactId);
                        authorName = getDisplayName(contact);
                    }
                    let textPreview = msg.text || (msg.type === 'image_description' ? '[图片]' : `[表情: ${msg.description || '无'}]`);
                    if (textPreview.length > 20) textPreview = textPreview.substring(0, 20) + '...';
                    
                    activeReplyTarget = { authorName, text: textPreview, id: msg.id };
                    
                    document.getElementById('reply-preview-text').textContent = `回复 ${authorName}: ${textPreview}`;
                    document.getElementById('reply-preview-container').classList.add('active');
                    document.getElementById('chat-input').focus();
                }
                messageEl.classList.remove('quote-active');
            } else if (editIcon) {
                const messageEl = editIcon.closest('.message');
                const msgId = Number(messageEl.dataset.id);
                const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
                const msg = currentChat.chatHistory.find(m => m.id === msgId);

                if (msg && (msg.type === 'text' || msg.type === 'reply' || msg.type === 'voice' || msg.type === 'location')) {
                    document.getElementById('edit-message-id').value = msg.id;
                    document.getElementById('edit-message-content').value = msg.text;
                    openModal('edit-message-modal');
                } else {
                    alert('只有文本、回复、语音和位置类型的消息可以编辑。');
                }
                messageEl.classList.remove('quote-active');
            } else {
                 chatArea.querySelectorAll('.message.quote-active').forEach(el => el.classList.remove('quote-active'));
            }
        });
        document.getElementById('confirm-edit-message-btn').addEventListener('click', async () => {
            const msgId = Number(document.getElementById('edit-message-id').value);
            const newContent = document.getElementById('edit-message-content').value;
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            const msg = currentChat.chatHistory.find(m => m.id === msgId);

            if (msg) {
                msg.text = newContent;
                if (msg.type === 'voice') {
                    msg.duration = Math.max(1, Math.round(newContent.length / 5));
                }
                await saveData();
                await renderSingleMessage(msgId, msg);
                closeModal('edit-message-modal');
            }
        });
        document.getElementById('cancel-reply-btn').addEventListener('click', () => {
            activeReplyTarget = null;
            document.getElementById('reply-preview-container').classList.remove('active');
        });
        document.getElementById('heart-voice-action-btn').addEventListener('click', async () => {
            const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
            if (!currentChat) return;

            const modalTitle = document.getElementById('heart-voice-title');
            const modalContent = document.getElementById('heart-voice-content');
            modalContent.innerHTML = '';

            if (activeChat.isGroup) {
                modalTitle.textContent = '群聊心声';
                const thoughtsMap = currentChat.aiThoughtsMap || {};
                if (Object.keys(thoughtsMap).length === 0) {
                    modalContent.textContent = '大家暂时还没什么想法...';
                } else {
                    for (const memberId of currentChat.memberIds) {
                        const contact = contacts.find(c => c.id === memberId);
                        if (contact) {
                            const thought = thoughtsMap[memberId] || '（Ta现在没想法）';
                            const entry = document.createElement('div');
                            entry.className = 'heart-voice-entry';
                            entry.innerHTML = `
                                <img src="${await getImageById(contact.avatarId)}" alt="${getDisplayName(contact)}">
                                <div class="text-content">
                                    <div class="name">${getDisplayName(contact)}</div>
                                    <div class="thought">${thought}</div>
                                </div>
                            `;
                            modalContent.appendChild(entry);
                        }
                    }
                }
            } else {
                const contact = contacts.find(c => c.id === activeChat.id);
                modalTitle.textContent = `${getDisplayName(contact)}的心声`;
                const thought = currentChat.aiThoughtsMap?.[contact.id] || '（Ta现在没想法）';
                const entry = document.createElement('div');
                entry.className = 'heart-voice-entry';
                entry.innerHTML = `
                    <img src="${await getImageById(contact.avatarId)}" alt="${getDisplayName(contact)}">
                    <div class="text-content">
                        <div class="name">${getDisplayName(contact)}</div>
                        <div class="thought">${thought}</div>
                    </div>
                `;
                modalContent.appendChild(entry);
            }
            openModal('heart-voice-modal');
        });
        document.getElementById('gomoku-game-board').addEventListener('click', (e) => {
            if (e.target.closest('#gomoku-player-human img')) {
                document.getElementById('gomoku-chat-input-text').value = '';
                openModal('gomoku-chat-input-modal');
            }
        });
        document.getElementById('confirm-gomoku-chat-btn').addEventListener('click', () => {
            const text = document.getElementById('gomoku-chat-input-text').value.trim();
            if (text) {
                handleSendGomokuChatMessage(text);
            }
        });
        document.getElementById('upload-sent-font-btn').addEventListener('click', () => document.getElementById('sent-font-input').click());
        document.getElementById('upload-received-font-btn').addEventListener('click', () => document.getElementById('received-font-input').click());
        
        const profileText1 = document.getElementById('home-profile-text1');
        const profileText2 = document.getElementById('home-profile-text2');
        profileText1.addEventListener('blur', async () => {
            homeWidgetsData.profileText1 = profileText1.textContent;
            await saveData();
        });
        profileText2.addEventListener('blur', async () => {
            homeWidgetsData.profileText2 = profileText2.textContent;
            await saveData();
        });
    }
    
    async function renderChatMusicLibrary() {
        const listEl = document.getElementById('music-library-list');
        if (chatMusicLibrary.length === 0) {
            listEl.innerHTML = '<p style="text-align:center; color:var(--light-text-color); padding: 20px 0;">曲库是空的，快去上传新歌曲吧！</p>';
            return;
        }
        listEl.innerHTML = '';
        for (const song of chatMusicLibrary) {
            const itemEl = document.createElement('div');
            itemEl.className = 'music-library-item';
            itemEl.dataset.id = song.id;
            const coverSrc = song.coverId ? await getImageById(song.coverId) : defaultAvatarBase64;
            itemEl.innerHTML = `
                <img src="${coverSrc}" alt="${song.name}">
                <div class="info">
                    <div class="name">${song.name}</div>
                    <div class="artist">${song.artist || '未知歌手'}</div>
                </div>
                <button class="delete-btn" data-id="${song.id}">${trashSVG}</button>
            `;
            listEl.appendChild(itemEl);
        }
    }

    async function playChatMusic(songId) {
        const song = chatMusicLibrary.find(s => s.id === songId);
        if (!song) {
            alert('找不到该歌曲');
            return;
        }
        const playerEl = document.getElementById('chat-music-player');
        const audio = chatMusicPlayerState.audioElement;

        chatMusicPlayerState.currentSongId = song.id;
        
        playerEl.querySelector('.player-song-title').textContent = song.name;
        playerEl.querySelector('.player-song-artist').textContent = song.artist || '未知歌手';
        playerEl.querySelector('.player-cover').src = song.coverId ? await getImageById(song.coverId) : defaultAvatarBase64;

        if (chatMusicPlayerState.lyricUpdateInterval) {
            clearInterval(chatMusicPlayerState.lyricUpdateInterval);
        }

        const lyricsContainer = playerEl.querySelector('.player-lyrics-scroller');
        if (song.lyrics) {
            chatMusicPlayerState.lyricParser = parseLyrics(song.lyrics);
            lyricsContainer.innerHTML = chatMusicPlayerState.lyricParser.lines.map(line => `<div class="lyric-line">${line.text}</div>`).join('');
            chatMusicPlayerState.lyricUpdateInterval = setInterval(updateLyrics, 300);
        } else {
            chatMusicPlayerState.lyricParser = null;
            lyricsContainer.innerHTML = '<div class="lyric-line">暂无歌词</div>';
        }

        audio.src = song.url;
        audio.play().catch(e => alert(`播放失败: ${e.message}`));
        playerEl.classList.add('active');
    }

    function parseLyrics(lrc) {
        const lines = lrc.split('\n');
        const result = [];
        const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
        for (const line of lines) {
            const match = line.match(timeRegex);
            if (match) {
                const minutes = parseInt(match[1], 10);
                const seconds = parseInt(match[2], 10);
                const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
                const time = minutes * 60 + seconds + milliseconds / 1000;
                const text = line.replace(timeRegex, '').trim();
                if (text) {
                    result.push({ time, text });
                }
            }
        }
        return { lines: result, currentIndex: -1 };
    }

    function updateLyrics() {
        if (!chatMusicPlayerState.lyricParser || !chatMusicPlayerState.isPlaying) return;
        
        const audio = chatMusicPlayerState.audioElement;
        const currentTime = audio.currentTime;
        const lyrics = chatMusicPlayerState.lyricParser.lines;
        
        let newIndex = -1;
        for (let i = 0; i < lyrics.length; i++) {
            if (currentTime >= lyrics[i].time) {
                newIndex = i;
            } else {
                break;
            }
        }

        if (newIndex !== chatMusicPlayerState.lyricParser.currentIndex) {
            chatMusicPlayerState.lyricParser.currentIndex = newIndex;
            const scroller = document.querySelector('.player-lyrics-scroller');
            const allLines = scroller.querySelectorAll('.lyric-line');
            allLines.forEach(line => line.classList.remove('active'));
            if (newIndex !== -1) {
                allLines[newIndex].classList.add('active');
                const offset = newIndex * 20; // 20 is the height of a lyric line
                scroller.style.transform = `translateY(-${offset}px)`;
            }
        }
    }

    function formatTime(seconds) {
        if (isNaN(seconds)) return '00:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function findBestSticker(keywords) {
        if (!stickers || stickers.length === 0) return null;
        let bestMatch = null;
        let maxScore = -1;
        const searchKeywords = keywords.toLowerCase().split(/[\s,，]+/);

        stickers.forEach(sticker => {
            let currentScore = 0;
            const stickerDesc = sticker.description.toLowerCase();
            searchKeywords.forEach(kw => {
                if (stickerDesc.includes(kw)) {
                    currentScore++;
                }
            });
            if (currentScore > maxScore) {
                maxScore = currentScore;
                bestMatch = sticker;
            }
        });
        
        return maxScore > 0 ? bestMatch : null;
    }

    async function renderStickerPicker() {
        const { currentPage, stickersPerPage } = stickerPickerState;
        const grid = document.getElementById('sticker-grid');
        const pagination = document.getElementById('sticker-pagination');
        const pageInfo = document.getElementById('sticker-page-info');
        const prevBtn = document.getElementById('sticker-prev-btn');
        const nextBtn = document.getElementById('sticker-next-btn');
        grid.innerHTML = '';

        const addBtn = document.createElement('div');
        addBtn.className = 'sticker-grid-item sticker-add-btn';
        addBtn.textContent = '+';
        grid.appendChild(addBtn);

        const totalStickers = stickers.length;
        const totalPages = Math.ceil(totalStickers / stickersPerPage) || 1;
        
        if (totalStickers > 0) {
            pagination.style.display = 'flex';
            pageInfo.textContent = `第 ${currentPage} / ${totalPages} 页`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            const startIndex = (currentPage - 1) * stickersPerPage;
            const endIndex = startIndex + stickersPerPage;
            const pageStickers = stickers.slice(startIndex, endIndex);
            
            for (const sticker of pageStickers) {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'sticker-grid-item';
                itemWrapper.dataset.stickerId = sticker.id;
                itemWrapper.dataset.imageId = sticker.imageId;
                
                const img = document.createElement('img');
                img.src = await getImageById(sticker.imageId);
                
                const desc = document.createElement('div');
                desc.className = 'sticker-desc';
                desc.textContent = sticker.description;

                const deleteOverlay = document.createElement('div');
                deleteOverlay.className = 'sticker-delete-overlay';
                deleteOverlay.textContent = '✕';

                itemWrapper.appendChild(img);
                itemWrapper.appendChild(desc);
                itemWrapper.appendChild(deleteOverlay);
                grid.appendChild(itemWrapper);
            }
        } else {
            pagination.style.display = 'none';
        }
    }

    async function renderBatchStickerModal() {
        const { items, currentIndex } = stickerBatch;
        if (currentIndex >= items.length) return;

        const currentItem = items[currentIndex];
        const title = document.getElementById('batch-sticker-title');
        const preview = document.getElementById('batch-sticker-preview');
        const descInput = document.getElementById('batch-sticker-desc');
        const saveBtn = document.getElementById('save-next-sticker-btn');

        title.textContent = `添加描述 (${currentIndex + 1} / ${items.length})`;
        descInput.value = currentItem.description || '';
        preview.src = currentItem.source;

        if (currentIndex === items.length - 1) {
            saveBtn.textContent = '保存并完成';
        } else {
            saveBtn.textContent = '保存并下一个';
        }
        
        saveBtn.disabled = false;
        descInput.focus();
    }

    const isVisionModel = (modelName) => {
        if (!modelName) return false;
        const visionKeywords = ['vision', 'gpt-4o', 'gemini-pro-vision'];
        return visionKeywords.some(kw => modelName.toLowerCase().includes(kw));
    };

    function getHtmlCommandMapForChat(currentChat) {
        const commandMap = {};
        if (!currentChat || !currentChat.worldBookIds) return commandMap;

        const boundBooks = currentChat.worldBookIds
            .map(id => worldBooks.find(wb => wb.id === id))
            .filter(Boolean);

        for (const book of boundBooks) {
            const content = book.content;
            const regex = /\[TRIGGER:(.*?)\]\s*\[HTML\]([\s\S]*?)\[END_HTML\]/g;
            let match;
            while ((match = regex.exec(content)) !== null) {
                const trigger = match[1].trim();
                const html = match[2].trim();
                if (trigger && html) {
                    commandMap[trigger] = html;
                }
            }
        }
        return commandMap;
    }

    function getHtmlPromptMapForChat(currentChat) {
        const promptMap = {};
        if (!currentChat || !currentChat.worldBookIds) return promptMap;
        const boundBooks = currentChat.worldBookIds
            .map(id => worldBooks.find(wb => wb.id === id))
            .filter(Boolean);
        for (const book of boundBooks) {
            const content = book.content;
            const regex = /\[TRIGGER:(.*?)\]\s*\[HTML_PROMPT\]([\s\S]*?)\[END_HTML_PROMPT\]/g;
            let match;
            while ((match = regex.exec(content)) !== null) {
                const trigger = match[1].trim();
                const prompt = match[2].trim();
                if (trigger && prompt) {
                    promptMap[trigger] = prompt;
                }
            }
        }
        return promptMap;
    }
    async function generateDynamicHTML(trigger, basePrompt, currentChat) {
        if (!apiSettings.baseUrl) {
            alert('请先在API应用中完成设置！');
            return;
        }
        const contactForPersona = activeChat.isGroup 
            ? contacts.find(c => c.id === currentChat.memberIds[0]) || currentChat
            : currentChat;
        const myProfile = currentChat.myProfile || { name: '我', persona: '一个普通人' };
        const fullPrompt = `# 角色设定
> 你是 ${getDisplayName(contactForPersona)}
> 你的人设：${contactForPersona.persona}
> 
> # 任务要求
> ${basePrompt}
> 
> # 重要规则
> 1. 必须返回一个完整的、自包含的HTML代码块。
> 2. HTML要符合你的角色人设和性格特点。
> 3. 每次生成的内容都应该有所不同，体现随机性。
> 4. 不要使用任何Markdown标记（如 \`\`\`html），直接返回纯HTML代码。
> 5. 所有CSS样式都必须内联在HTML标签的 \`style\` 属性中，或者包含在一个单一的 \`<style>\` 标签内。
> 6. 绝对不要使用 \`<body>\` 或 \`<html>\` 标签。只生成需要在气泡内显示的内容。
> 7. 生成的HTML根元素不应有固定的高度（如 height: 100vh），它应该能自适应内容的高度。
> 8. 为了样式统一，可以尝试使用以下CSS变量: var(--text-color), var(--light-text-color), var(--accent-color), var(--danger-color)。
> 9. 你可以在HTML中使用 {{user}} 占位符，它将被自动替换为用户的名字 "${myProfile.name}"。
> 
> 请现在生成HTML代码：`;
        try {
            const chatStatusIndicator = document.getElementById('chat-status-indicator');
            if (chatStatusIndicator) {
                chatStatusIndicator.style.display = 'block';
                chatStatusIndicator.textContent = `${getDisplayName(contactForPersona)} 正在准备场景...`;
            }
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${apiSettings.apiKey}` 
                },
                body: JSON.stringify({ 
                    model: apiSettings.model, 
                    messages: [{ role: 'user', content: fullPrompt }] 
                })
            });
            if (!response.ok) throw new Error(await response.text());
            
            const data = await response.json();
            let htmlContent = data.choices[0]?.message?.content || '';
            
            htmlContent = htmlContent
                .replace(/```html\n?/g, '')
                .replace(/```\n?/g, '')
                .trim();

            const aiMessage = {
                id: Date.now(),
                sender: 'received',
                text: htmlContent,
                avatarId: contactForPersona.avatarId,
                contactId: activeChat.isGroup ? contactForPersona.id : currentChat.id,
                type: 'text',
                isHtml: true
            };
            
            currentChat.chatHistory.push(aiMessage);
            await appendMessageToChat(aiMessage);
            await saveData();

            if (chatStatusIndicator) {
                chatStatusIndicator.style.display = 'none';
            }
        } catch (error) {
            console.error("Dynamic HTML generation error:", error);
            alert(`生成动态场景失败: ${error.message}`);
            
            const chatStatusIndicator = document.getElementById('chat-status-indicator');
            if (chatStatusIndicator) {
                chatStatusIndicator.style.display = 'none';
            }
        }
    }

    function getCleanedWorldBookContent(rawContent) {
        if (!rawContent) return "";
        const commandRegex = /\[TRIGGER:(.*?)\]\s*\[HTML\]([\s\S]*?)\[END_HTML\]/g;
        const promptRegex = /\[TRIGGER:(.*?)\]\s*\[HTML_PROMPT\]([\s\S]*?)\[END_HTML_PROMPT\]/g;
        return rawContent
            .replace(commandRegex, '')
            .replace(promptRegex, '')
            .trim();
    }
    async function triggerSingleAiPost(contactId) {
        if (!apiSettings.baseUrl) { alert('请先在API应用中完成设置！'); return; }
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return;

        const boundBooks = (contact.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)).filter(Boolean);
        const worldBookContent = boundBooks.map(b => b.content).join('\n\n');
        const relevantAnniversaries = anniversaries.filter(a => a.contactId === contact.id);
        const anniversaryInfo = relevantAnniversaries.length > 0 ? relevantAnniversaries.map(a => `${a.title} on ${a.date}`).join('; ') : '';
        
        const myPersonaForThisContact = contact.myProfile || myMomentsProfile;
        
        const prompt = getBaseSystemPrompt(contact, myPersonaForThisContact, worldBookContent, anniversaryInfo, null, null, 'moment_post', {});
        
        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` },
                body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] })
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API请求失败，状态码: ${response.status}\n错误信息: ${errorText}`);
            }
            const data = await response.json();
            const momentContent = data.choices[0]?.message?.content || '';
            
            if (momentContent) {
                const imageMatch = momentContent.match(/\[IMAGE:\s*(.*?)\]/);
                const text = momentContent.replace(/\[IMAGE:.*?\]/, '').trim();

                const newMoment = {
                    id: Date.now(),
                    authorId: contact.id,
                    text: text,
                    imageDesc: imageMatch ? imageMatch[1] : null,
                    comments: [],
                    likes: []
                };
                moments.push(newMoment);
                await renderMoments();
                await saveData();
            } else {
                alert('AI发布朋友圈失败：API返回了空内容。');
            }
        } catch (err) {
            console.error('AI moment post failed:', err);
            alert('AI发布朋友圈失败: ' + err.message);
        }
    }

    async function triggerAiDiary(contactId) {
        if (!apiSettings.baseUrl) { alert('请先在API应用中完成设置！'); return; }
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return;

        const chatHistory = (contact.chatHistory || []).slice(-10);
        if (chatHistory.length === 0) {
            alert(`${getDisplayName(contact)}还没有聊天记录，无法写日记。`);
            return;
        }

        const myPersonaForThisContact = contact.myProfile || myMomentsProfile;

        const chatHistoryForDiary = chatHistory.map(msg => {
            const speaker = msg.sender === 'sent' ? (myPersonaForThisContact.name || '我') : getDisplayName(contact);
            return `${speaker}: ${msg.text || `[${msg.type}]`}`;
        }).join('\n');

        const boundBooks = (contact.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)).filter(Boolean);
        const worldBookContent = boundBooks.map(b => b.content).join('\n\n');
        const relevantAnniversaries = anniversaries.filter(a => a.contactId === contact.id);
        const anniversaryInfo = relevantAnniversaries.length > 0 ? relevantAnniversaries.map(a => `${a.title} on ${a.date}`).join('; ') : '';

        const prompt = getBaseSystemPrompt(contact, myPersonaForThisContact, worldBookContent, anniversaryInfo, null, null, 'diary', { chatHistoryForDiary });

        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` },
                body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] })
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API请求失败，状态码: ${response.status}\n错误信息: ${errorText}`);
            }
            const data = await response.json();
            const diaryText = data.choices[0]?.message?.content || '';
            if (diaryText) {
                const newDiary = {
                    id: Date.now(),
                    authorId: contact.id,
                    text: diaryText,
                    date: new Date().toISOString().split('T')[0]
                };
                diaries.push(newDiary);
                await saveData();
            } else {
                alert('AI写日记失败：API返回了空内容。');
            }
        } catch (err) {
            console.error('AI diary failed:', err);
            alert('AI写日记失败: ' + err.message);
        }
    }

    function playNextSong() {
        const player = document.getElementById('music-player-element');
        if (!musicAppData.playlist || musicAppData.playlist.length === 0) return;
        const currentSrc = player.src;
        const currentIndex = musicAppData.playlist.findIndex(song => song.url === currentSrc);
        const nextIndex = (currentIndex + 1) % musicAppData.playlist.length;
        const nextSong = musicAppData.playlist[nextIndex];
        if (nextSong) {
            player.src = nextSong.url;
            player.play().catch(err => console.error("Playback error:", err));
        }
    }

    function playPrevSong() {
        const player = document.getElementById('music-player-element');
        if (!musicAppData.playlist || musicAppData.playlist.length === 0) return;
        const currentSrc = player.src;
        const currentIndex = musicAppData.playlist.findIndex(song => song.url === currentSrc);
        const prevIndex = (currentIndex - 1 + musicAppData.playlist.length) % musicAppData.playlist.length;
        const prevSong = musicAppData.playlist[prevIndex];
        if (prevSong) {
            player.src = prevSong.url;
            player.play().catch(err => console.error("Playback error:", err));
        }
    }

    function updateDynamicIslandMusicInfo() {
        const player = document.getElementById('music-player-element');
        const currentSrc = player.src;
        const song = musicAppData.playlist.find(s => s.url === currentSrc);
        if (song) {
            document.getElementById('island-song-title').textContent = song.name;
            document.getElementById('island-song-artist').textContent = '一起听';
        } else {
            document.getElementById('island-song-title').textContent = '未知歌曲';
            document.getElementById('island-song-artist').textContent = '未知艺术家';
        }
    }
    
    async function triggerAIResponse(options = {}) {
        const currentChat = activeChat.isGroup 
            ? groupChats.find(gc => gc.id === activeChat.id) 
            : contacts.find(c => c.id === activeChat.id);
        
        if (!currentChat) return;

        if (options.isPaymentDecision && options.paymentMsg) {
            const { paymentMsg } = options;
            paymentMsg.status = 'paid';
            
            const contactForPersona = contacts.find(c => c.id === paymentMsg.contactId) || currentChat;

            const transferMsg = {
                id: Date.now(),
                sender: 'received',
                type: 'transfer',
                amount: paymentMsg.amount,
                memo: `${paymentMsg.item} 代付`,
                avatarId: contactForPersona.avatarId,
                contactId: contactForPersona.id,
                status: 'pending',
                recipientId: myMomentsProfile.id
            };
            
            currentChat.chatHistory.push(transferMsg);
            await appendMessageToChat(transferMsg);
            
            paymentMsg.status = 'paid';
            await renderSingleMessage(paymentMsg.id, paymentMsg);

            await saveData();
            return; 
        }

        const lastMessage = currentChat.chatHistory && currentChat.chatHistory.length > 0 
            ? currentChat.chatHistory[currentChat.chatHistory.length - 1] 
            : null;

        if (lastMessage && lastMessage.sender === 'sent' && (lastMessage.type === 'text' || lastMessage.type === 'reply')) {
            const htmlCommands = getHtmlCommandMapForChat(currentChat);
            const htmlPrompts = getHtmlPromptMapForChat(currentChat);
            const userCommand = lastMessage.text.trim();

            if (htmlPrompts.hasOwnProperty(userCommand)) {
                await generateDynamicHTML(userCommand, htmlPrompts[userCommand], currentChat);
                return;
            }
            
            if (htmlCommands.hasOwnProperty(userCommand)) {
                const htmlResponse = htmlCommands[userCommand];
                const contactForPersona = activeChat.isGroup 
                    ? contacts.find(c => c.id === currentChat.memberIds[0]) || currentChat
                    : currentChat;

                const aiMessage = {
                    id: Date.now(),
                    sender: 'received',
                    text: htmlResponse,
                    avatarId: contactForPersona.avatarId,
                    contactId: activeChat.isGroup ? contactForPersona.id : currentChat.id,
                    type: 'text',
                    isHtml: true
                };
                
                currentChat.chatHistory.push(aiMessage);
                await appendMessageToChat(aiMessage);
                await saveData();
                return;
            }
        }

        if (!apiSettings.baseUrl || !apiSettings.apiKey || !apiSettings.model) {
            alert('请先在API应用中完成设置！');
            return;
        }
        if (!isVisionModel(apiSettings.model)) {
            const lastMsg = currentChat.chatHistory[currentChat.chatHistory.length - 1];
            if (lastMsg && lastMsg.type === 'image') {
                 alert(`当前模型 ${apiSettings.model} 不支持识图。请在API设置中选择包含 "vision", "gpt-4o", "gemini-pro-vision" 等关键词的模型。`);
                 return;
            }
        }
        if (isAiThinking) {
            aiRequestController.abort();
            console.log('Previous AI request aborted.');
        }
        aiRequestController = new AbortController();
        isAiThinking = true;

        if (!currentChat.aiThoughtsMap) currentChat.aiThoughtsMap = {};

        if (options.isRegeneration) {
            let lastAiBlockStartIndex = currentChat.chatHistory.length - 1;
            while (lastAiBlockStartIndex >= 0 && currentChat.chatHistory[lastAiBlockStartIndex].sender === 'received') {
                lastAiBlockStartIndex--;
            }
            lastAiBlockStartIndex++;

            if (lastAiBlockStartIndex < currentChat.chatHistory.length) {
                const idsToRemove = currentChat.chatHistory.slice(lastAiBlockStartIndex).map(m => m.id);
                idsToRemove.forEach(id => document.querySelector(`.message[data-id="${id}"]`)?.remove());
                currentChat.chatHistory.splice(lastAiBlockStartIndex);
            }
        }

        const contactsToRespond = activeChat.isGroup 
            ? currentChat.memberIds.map(id => contacts.find(c => c.id === id)).filter(Boolean)
            : [currentChat];
        
        if (contactsToRespond.length === 0) { alert('无法找到回复的角色。'); isAiThinking = false; return; }

        const chatStatusIndicator = document.getElementById('chat-status-indicator');
        
        try {
            const myProfile = currentChat.myProfile || { name: '我', persona: '一个普通人' };
            const memoryDepth = currentChat.memoryDepth || 10;
            const history = (currentChat.chatHistory || []).slice(-memoryDepth);
            
            const baseMessagesForApi = [];
            for (const msg of history) {
                const role = (msg.sender === 'sent') ? 'user' : 'assistant';
                let textContent = '';
                let finalContent;

                switch(msg.type) {
                    case 'image':
                        const imageData = await getImageById(msg.imageId);
                        let imageText = `[用户发送了一张图片，请你描述并评论这张图片。]`;
                        if (role === 'user') {
                            imageText = `(msg_id: ${msg.id}) ${imageText}`;
                        }
                        finalContent = [ { type: 'text', text: imageText }, { type: 'image_url', image_url: { url: imageData } } ];
                        break;
                    
                    default:
                        switch(msg.type) {
                            case 'text': textContent = msg.text; break;
                            case 'reply': 
                                const quoteText = msg.quote ? `[回复 ${msg.quote.authorName}: "${msg.quote.text}"] ` : '';
                                textContent = `${quoteText}${msg.text}`; 
                                break;
                            case 'location': textContent = `[分享了一个位置: ${msg.text}]`; break;
                            case 'image_description': textContent = `[发送了一张图片, 描述是: ${msg.text}]`; break;
                            case 'gift': 
                                const recipientContact = msg.recipientId ? contacts.find(c => c.id === msg.recipientId) : null;
                                const recipientName = recipientContact ? getDisplayName(recipientContact) : '你';
                                textContent = `[送出了一个礼物给 ${recipientName}: ${msg.text}]`; 
                                break;
                            case 'sticker': textContent = `[发送了一个表情包, 描述: ${msg.description || '无'}]`; break;
                            case 'voice': textContent = `[发送了一条语音]: ${msg.text}`; break;
                            case 'transfer': textContent = `[发起了一笔转账]: ¥${msg.amount}`; break;
                            case 'payment_request': textContent = `[发起了外卖代付请求]: ${msg.item} ¥${msg.amount}`; break;
                            case 'system': textContent = `[系统消息: ${msg.text}]`; break;
                            // --- 核心修改：为AI提供音乐分享的上下文 ---
                            case 'chat_music':
                                const song = chatMusicLibrary.find(s => s.id === msg.songId);
                                if (song) {
                                    textContent = `[分享了一首音乐: ${song.name} - ${song.artist || '未知'}]`;
                                } else {
                                    textContent = `[分享了一首已失效的音乐]`;
                                }
                                break;
                        }
                        if (textContent) {
                            if (role === 'user') {
                                finalContent = `(msg_id: ${msg.id}) ${textContent}`;
                            } else {
                                finalContent = textContent;
                            }
                        }
                        break;
                }
                
                if (finalContent) {
                    const apiMsg = { role, content: finalContent };
                    if (role === 'assistant') {
                        const contact = contacts.find(c => c.id === msg.contactId);
                        if (contact) {
                            apiMsg.name = getDisplayName(contact).replace(/[\s\W]/g, '_');
                        }
                    }
                    baseMessagesForApi.push(apiMsg);
                }
            }
            
            const codeKeywords = ['html', 'css', 'javascript', '代码', '脚本', '网页', 'python', 'java', 'sql', '写个', '生成'];
            const lastUserMessageText = lastMessage?.text?.toLowerCase() || '';
            const isCodeRequest = codeKeywords.some(keyword => lastUserMessageText.includes(keyword));

            const rawWorldBookContent = (currentChat.worldBookIds || [])
                .map(id => worldBooks.find(wb => wb.id === id)?.content)
                .filter(Boolean)
                .join('\n\n');
            const cleanedWorldBookForPrompt = getCleanedWorldBookContent(rawWorldBookContent);
            const stickerList = stickers.map(s => s.description).join(', ');

            for (const contactForPersona of contactsToRespond) {
                if (aiRequestController.signal.aborted) {
                    console.log('Group response sequence aborted by user.');
                    break; 
                }

                chatStatusIndicator.style.display = 'block';
                chatStatusIndicator.textContent = `${getDisplayName(contactForPersona)} 正在输入...`;

                const relevantAnniversaries = anniversaries.filter(a => a.contactId === contactForPersona.id);
                const anniversaryInfo = relevantAnniversaries.length > 0 ? relevantAnniversaries.map(a => `${a.title} on ${a.date}`).join('; ') : '';
                
                let groupInfo = null;
                if (activeChat.isGroup) {
                    const otherMemberNames = currentChat.memberIds
                        .filter(id => id !== contactForPersona.id)
                        .map(id => contacts.find(c => c.id === id)?.name)
                        .filter(Boolean)
                        .join(', ');
                    groupInfo = { name: currentChat.name, otherMemberNames: otherMemberNames };
                }

                const systemPrompt = getBaseSystemPrompt(contactForPersona, myProfile, cleanedWorldBookForPrompt, anniversaryInfo, stickerList, groupInfo, 'chat', {isCodeRequest});
                const messagesForThisRequest = [{ role: 'system', content: systemPrompt }, ...baseMessagesForApi];

                const apiResponse = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` },
                    body: JSON.stringify({ model: apiSettings.model, messages: messagesForThisRequest, max_tokens: 2048, stream: true }),
                    signal: aiRequestController.signal
                });

                if (!apiResponse.ok) {
                    const errorText = await apiResponse.text();
                    throw new Error(`API请求失败，状态码: ${apiResponse.status}\n错误信息: ${errorText}`);
                }
                
                const reader = apiResponse.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const jsonString = line.replace('data: ', '');
                        if (jsonString === '[DONE]') continue;
                        
                        try {
                            const chunk = JSON.parse(jsonString);
                            const textChunk = chunk.choices[0]?.delta?.content || chunk.choices[0]?.delta?.text || '';
                            if (textChunk) {
                                fullResponse += textChunk;
                            }
                        } catch (error) {
                        }
                    }
                }

                const thoughtDelimiter = '|||---THOUGHT---|||';
                let aiText = fullResponse;
                if (fullResponse.includes(thoughtDelimiter)) {
                    const parts = fullResponse.split(thoughtDelimiter);
                    aiText = parts[0];
                    currentChat.aiThoughtsMap[contactForPersona.id] = parts[1] ? parts[1].trim() : '';
                }

                if (!aiText || !aiText.trim()) {
                    alert(`来自 ${getDisplayName(contactForPersona)} 的AI回复为空。\n\n可能原因：\n- 网络问题或请求超时\n- 触发了API的内容安全策略\n- 模型内部错误`);
                    continue; 
                }

                if (isCodeRequest) {
                    const aiMessage = {
                        id: Date.now(),
                        sender: 'received',
                        text: aiText.trim(),
                        avatarId: contactForPersona.avatarId,
                        contactId: contactForPersona.id,
                        type: 'text',
                        isHtml: true
                    };
                    currentChat.chatHistory.push(aiMessage);
                    await appendMessageToChat(aiMessage);
                } else {
                    const replies = aiText.split('|||---|||').map(r => r.trim()).filter(Boolean);
                    for (const reply of replies) {
                        if (!reply) continue;
                        
                        let msg = {
                            id: Date.now() + Math.random(),
                            sender: 'received',
                            avatarId: contactForPersona.avatarId,
                            contactId: contactForPersona.id,
                            isHtml: false
                        };

                        const callMatch = reply.match(/\[CALL:\s*(.*?)\]/);
                        const voiceMatch = reply.match(/\[VOICE:\s*(.*?)\]/);
                        const stickerMatch = reply.match(/\[STICKER:\s*(.*?)\]/);
                        const imageMatch = reply.match(/\[IMAGE:\s*(.*?)\]/);
                        const giftMatch = reply.match(/\[GIFT:\s*(.*?)\]/);
                        const transferMatch = reply.match(/\[TRANSFER:\s*amount=([\d.]+),\s*memo=(.*?)\]/);
                        const replyMatch = reply.match(/\[REPLY_TO_ID:\s*([\d.]+)\]/);
                        const locationMatch = reply.match(/\[LOCATION:\s*(.*?)\]/);
                        // --- 核心修改：解析AI分享音乐的指令 ---
                        const musicMatch = reply.match(/\[SHARE_MUSIC:\s*(.*?)\]/);

                        if (callMatch) {
                            msg.type = 'text';
                            msg.text = callMatch[1] || '正在呼叫你...';
                            currentChat.chatHistory.push(msg);
                            await appendMessageToChat(msg);
                            await saveData();
                            await setupAndShowCallScreen({ callReason: callMatch[1] });
                            break;
                        } else if (voiceMatch) {
                            msg.type = 'voice';
                            msg.text = voiceMatch[1];
                            msg.duration = Math.max(1, Math.round(msg.text.length / 5));
                        } else if (stickerMatch) {
                            const bestSticker = findBestSticker(stickerMatch[1]);
                            if (bestSticker) {
                                msg.type = 'sticker';
                                msg.imageId = bestSticker.imageId;
                                msg.description = bestSticker.description;
                            } else {
                                msg.type = 'text';
                                msg.text = `(找不到关于“${stickerMatch[1]}”的表情)`;
                            }
                        } else if (imageMatch) {
                            msg.type = 'image_description';
                            msg.text = imageMatch[1];
                        } else if (giftMatch) {
                            msg.type = 'gift';
                            msg.text = giftMatch[1];
                        } else if (transferMatch) {
                            msg.type = 'transfer';
                            msg.amount = parseFloat(transferMatch[1]);
                            msg.memo = transferMatch[2];
                            msg.status = 'pending';
                            msg.recipientId = null;
                        } else if (locationMatch) {
                            msg.type = 'location';
                            msg.text = locationMatch[1];
                        } else if (musicMatch) {
                            const songName = musicMatch[1].trim();
                            const songToShare = chatMusicLibrary.find(s => s.name.toLowerCase() === songName.toLowerCase());
                            if (songToShare) {
                                msg.type = 'chat_music';
                                msg.songId = songToShare.id;
                            } else {
                                msg.type = 'text';
                                msg.text = `(我想分享一首歌，但在曲库里没找到“${songName}”)`;
                            }
                        } else {
                            msg.type = 'text';
                            msg.text = reply;
                        }

                        if (replyMatch) {
                            const quoteMsgId = Number(replyMatch[1]);
                            const quoteMsg = currentChat.chatHistory.find(m => m.id === quoteMsgId);
                            if (quoteMsg) {
                                let authorName;
                                if (quoteMsg.sender === 'sent') {
                                    authorName = currentChat.myProfile?.name || '我';
                                } else {
                                    const contact = contacts.find(c => c.id === quoteMsg.contactId);
                                    authorName = getDisplayName(contact);
                                }
                                let textPreview = quoteMsg.text || (quoteMsg.type === 'image' ? '[图片]' : `[表情: ${msg.description || '无'}]`);
                                if (textPreview.length > 20) textPreview = textPreview.substring(0, 20) + '...';
                                msg.quote = { authorName, text: textPreview };
                                msg.text = msg.text.replace(replyMatch[0], '').trim();
                                if (!msg.text) {
                                    msg.text = ' '; 
                                }
                            }
                        }
                        
                        currentChat.chatHistory.push(msg);
                        await appendMessageToChat(msg);
                        await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 400));
                    }
                }

                await saveData();
                
                if (activeChat.isGroup && contactsToRespond.length > 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1500));
                }
            }

        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error("AI response error:", error);
                alert(`获取AI回复失败:\n\n${error.message}`);
            }
        } finally {
            if (chatStatusIndicator) chatStatusIndicator.style.display = 'none';
            isAiThinking = false;
            aiRequestController = null;
        }
    }

    async function setupAndShowCallScreen(options = {}) {
        const { callReason = null } = options;
        const currentChat = activeChat.isGroup ? groupChats.find(gc => gc.id === activeChat.id) : contacts.find(c => c.id === activeChat.id);
        if (!currentChat) return;
        
        activeCallState = { 
            isActive: true, 
            chatId: activeChat.id, 
            isGroup: activeChat.isGroup, 
            transcript: [], 
            currentTurnContactId: null,
            startTime: Date.now(),
            callReason: callReason
        };

        document.getElementById('call-avatar').src = await getImageById(currentChat.avatarId);
        document.getElementById('call-name').textContent = activeChat.isGroup ? currentChat.name : getDisplayName(currentChat);
        document.getElementById('call-status').textContent = '正在连接...';
        document.getElementById('call-transcript-area').innerHTML = '';
        showScreen('screen-call');
        await getAiCallResponse(true);
    }

    async function endCall() {
        if (!activeCallState.isActive) return;

        const duration = Math.floor((Date.now() - activeCallState.startTime) / 1000);
        const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
        const seconds = (duration % 60).toString().padStart(2, '0');
        const durationString = `${minutes}:${seconds}`;

        const currentChat = activeCallState.isGroup 
            ? groupChats.find(gc => gc.id === activeCallState.chatId) 
            : contacts.find(c => c.id === activeCallState.chatId);

        if (currentChat && activeCallState.transcript.length > 0) {
            let transcriptText = `通话结束，时长 ${durationString}。通话内容如下：\n`;
            transcriptText += activeCallState.transcript.map(entry => `${entry.speaker}: ${entry.text}`).join('\n');
            
            const summaryMessage = {
                id: Date.now(),
                sender: 'system',
                type: 'system',
                text: transcriptText
            };

            currentChat.chatHistory.push(summaryMessage);
            if (currentChat.id === activeChat.id) {
                await appendMessageToChat(summaryMessage);
            }
            await saveData();
        }

        activeCallState = { isActive: false, chatId: null, isGroup: false, transcript: [], currentTurnContactId: null, startTime: 0, callReason: null };
        showScreen('screen-chat');
    }

    function renderCallTranscript() {
        const container = document.getElementById('call-transcript-area');
        container.innerHTML = '';
        activeCallState.transcript.forEach(entry => {
            const p = document.createElement('p');
            const safeText = entry.text.replace(/</g, "&lt;");
            p.innerHTML = `<strong>${entry.speaker}:</strong> ${safeText}`;
            container.appendChild(p);
        });
        container.scrollTop = container.scrollHeight;
    }

    async function getAiCallResponse(isInitialGreeting = false) {
        if (!apiSettings.baseUrl || !apiSettings.apiKey || !apiSettings.model || !activeCallState.isActive) return;
        
        const currentChat = activeCallState.isGroup ? groupChats.find(gc => gc.id === activeCallState.chatId) : contacts.find(c => c.id === activeCallState.chatId);
        if (!currentChat) return;

        document.getElementById('call-status').textContent = '通话中';

        let contactToRespond;
        let groupInfo = null;
        if (activeCallState.isGroup) {
            const memberIds = currentChat.memberIds;
            if (memberIds.length === 0) return;
            const lastSpeakerId = activeCallState.currentTurnContactId;
            const nextSpeakerIndex = (memberIds.indexOf(lastSpeakerId) + 1) % memberIds.length;
            contactToRespond = contacts.find(c => c.id === memberIds[nextSpeakerIndex]);
            if (!contactToRespond) contactToRespond = contacts.find(c => c.id === memberIds[0]);
            activeCallState.currentTurnContactId = contactToRespond.id;
            const publicMemberNames = currentChat.memberIds.map(id => contacts.find(c => c.id === id)?.name).filter(Boolean);
            groupInfo = { name: currentChat.name, publicMemberNames };
        } else {
            contactToRespond = currentChat;
        }

        const boundBooks = (currentChat.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)).filter(Boolean);
        const worldBookContent = boundBooks.map(b => b.content).join('\n\n');
        const systemPrompt = getBaseSystemPrompt(contactToRespond, currentChat.myProfile, worldBookContent, null, null, groupInfo, 'call');
        
        const memoryDepth = currentChat.memoryDepth || 10;
        const chatHistory = (currentChat.chatHistory || []).slice(-memoryDepth);
        const chatContextMessages = chatHistory.map(msg => {
            const speaker = msg.sender === 'sent' ? (currentChat.myProfile.name || '我') : getDisplayName(contacts.find(c => c.id === msg.contactId));
            return { role: 'user', content: `${speaker}: ${msg.text || `[${msg.type}]`}` };
        });

        const transcriptMessages = activeCallState.transcript.map(entry => {
            const isMe = entry.speaker === (currentChat.myProfile.name || '我');
            const role = isMe ? 'user' : 'assistant';
            const message = { role, content: entry.text };
            if (role === 'assistant') {
                message.name = contactToRespond.name.replace(/[\s\W]/g, '_');
            }
            return message;
        });

        const messages = [
            { role: 'system', content: systemPrompt },
            ...chatContextMessages,
            ...transcriptMessages
        ];

        if (isInitialGreeting) {
            const myName = currentChat.myProfile.name || '我';
            if (activeCallState.callReason) {
                messages.push({ role: 'user', content: `[系统指令: 你刚刚成功呼叫了 ${myName}。你发起通话的原因是：“${activeCallState.callReason}”。通话已接通，请根据你发起通话的原因开始对话。]` });
            } else {
                messages.push({ role: 'user', content: `[系统指令: 你刚刚接到了 ${myName} 的来电。请向对方打个招呼以开始对话。]` });
            }
        }

        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, body: JSON.stringify({ model: apiSettings.model, messages }) });
            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();
            let fullResponse = data.choices[0]?.message?.content || '';
            
            let replyText = fullResponse.split('|||---THOUGHT---|||')[0].replace(/\|\|\|---\|\|\|/g, ' ').replace(/\[.*?\]/g, '').trim();

            activeCallState.transcript.push({ speaker: getDisplayName(contactToRespond), text: replyText });
            renderCallTranscript();
        } catch (error) {
            console.error("AI call response error:", error);
            activeCallState.transcript.push({ speaker: getDisplayName(contactToRespond), text: "(信号不好，没听清...)" });
            renderCallTranscript();
        }
    }
    
    function handleSendMusicChatMessage(text) {
        const myBubble = document.getElementById('music-my-chat-bubble');
        const partnerBubble = document.getElementById('music-partner-chat-bubble');
        
        if(partnerBubble) partnerBubble.style.display = 'none';
        myBubble.textContent = text;
        myBubble.style.display = 'block';
        
        closeModal('music-chat-input-modal');
        triggerAiMusicChatResponse(text);
    }
    
    async function triggerAiMusicChatResponse(myText) {
        if (!apiSettings.baseUrl || !musicAppData.currentPartnerId) return;
        const partner = contacts.find(c => c.id === musicAppData.currentPartnerId);
        if(!partner) return;
        
        const myName = myMomentsProfile.name || '我';
        const systemPrompt = `你是 ${getDisplayName(partner)}，你的人设是: ${partner.persona}。你正在和你的朋友 ${myName} 一起听歌。你们正在通过简短的私信聊天。你的回复必须简短、口语化，并且绝对不能包含任何引号。`;
        
        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, 
                body: JSON.stringify({ 
                    model: apiSettings.model, 
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: myText }
                    ] 
                }) 
            });
            if (!response.ok) {
                console.error("AI music chat error:", await response.text());
                return;
            }
            const data = await response.json();
            let replyText = data.choices[0]?.message?.content || '';
            
            replyText = replyText.replace(/["'“”]/g, '').trim();
            
            const myBubble = document.getElementById('music-my-chat-bubble');
            const partnerBubble = document.getElementById('music-partner-chat-bubble');
            
            setTimeout(() => {
                myBubble.style.display = 'none';
                partnerBubble.textContent = replyText;
                partnerBubble.style.display = 'block';
            }, 1000);

        } catch(error) {
            console.error("AI music chat error:", error);
        }
    }

    async function renderMusicScreen() {
        const partnerId = musicAppData.currentPartnerId;
        const leftAvatarContainer = document.getElementById('music-avatar-left');
        const rightAvatarContainer = document.getElementById('music-avatar-right');
        const wireLeft = document.getElementById('wire-left');
        const wireRight = document.getElementById('wire-right');
        const wires = document.getElementById('music-headphone-wires');

        rightAvatarContainer.innerHTML = `<img src="${await getImageById(myMomentsProfile.avatarId)}"><span>${myMomentsProfile.name}</span>`;

        if (partnerId) {
            const partner = contacts.find(c => c.id === partnerId);
            if(partner) {
                leftAvatarContainer.innerHTML = `<img src="${await getImageById(partner.avatarId)}"><span>${getDisplayName(partner)}</span>`;
                wires.style.display = 'block';
                setTimeout(() => {
                    const playerEl = document.getElementById('music-player-image');
                    const playerRect = playerEl.getBoundingClientRect();
                    const svgRect = wires.getBoundingClientRect();
                    const playerX = playerRect.left - svgRect.left + playerRect.width / 2;
                    const playerY = playerRect.top - svgRect.top + 20;
                    const leftAvatarEl = leftAvatarContainer.querySelector('img');
                    const rightAvatarEl = rightAvatarContainer.querySelector('img');
                    if(leftAvatarEl && rightAvatarEl) {
                        const leftRect = leftAvatarEl.getBoundingClientRect();
                        const rightRect = rightAvatarEl.getBoundingClientRect();
                        const leftX = leftRect.left - svgRect.left + leftRect.width / 2;
                        const leftY = leftRect.top - svgRect.top + leftRect.height;
                        const rightX = rightRect.left - svgRect.left + rightRect.width / 2;
                        const rightY = rightRect.top - svgRect.top + rightRect.height;
                        wireLeft.setAttribute('d', `M ${leftX} ${leftY} C ${leftX} ${playerY}, ${playerX - 50} ${playerY}, ${playerX - 20} ${playerY}`);
                        wireRight.setAttribute('d', `M ${rightX} ${rightY} C ${rightX} ${playerY}, ${playerX + 50} ${playerY}, ${playerX + 20} ${playerY}`);
                    }
                }, 100);
            } else { musicAppData.currentPartnerId = null; await saveData(); renderMusicScreen(); }
        } else {
            leftAvatarContainer.innerHTML = `<div class="invite-plus">+</div>`;
            wires.style.display = 'none';
        }
        renderMusicPlaylist();
    }

    function renderMusicPlaylist() {
        const container = document.getElementById('music-playlist-container');
        container.innerHTML = '';
        if(!musicAppData.playlist) musicAppData.playlist = [];
        musicAppData.playlist.forEach(song => {
            const item = document.createElement('div');
            item.className = 'music-song-item';
            item.dataset.url = song.url;
            item.innerHTML = `<span>${song.name}</span><button class="delete-song-item-btn" data-name="${song.name}">${trashSVG}</button>`;
            container.appendChild(item);
        });
        const player = document.getElementById('music-player-element');
        if (player.src && !player.paused) {
            const playingItem = container.querySelector(`[data-url="${player.src}"]`);
            if (playingItem) playingItem.classList.add('playing');
        }
    }

    async function showGomokuOpponentSelection() {
        const opponentSelection = document.getElementById('gomoku-opponent-selection');
        const gameBoard = document.getElementById('gomoku-game-board');
        opponentSelection.innerHTML = '';
        if (contacts.length === 0) { opponentSelection.innerHTML = '<p style="text-align:center; color:#888; margin-top: 20px;">请先在微信中添加联系人</p>'; } 
        else { 
            for (const contact of contacts) {
                const item = document.createElement('div'); item.className = 'list-item'; item.dataset.id = contact.id;
                const avatarSrc = await getImageById(contact.avatarId); const displayName = getDisplayName(contact);
                item.innerHTML = `<img src="${avatarSrc}" alt="${displayName}" style="width: 40px; height: 40px; border-radius: 6px; margin-right: 12px;"><div class="info"><div class="name">${displayName}</div></div>`;
                opponentSelection.appendChild(item);
            }
        }
        opponentSelection.classList.add('active'); gameBoard.classList.remove('active');
        gomokuGame.inProgress = false;
    }

    async function startGomokuGame(contactId) {
        const opponent = contacts.find(c => c.id === contactId);
        if (!opponent) return;
        document.getElementById('gomoku-opponent-selection').classList.remove('active');
        document.getElementById('gomoku-game-board').classList.add('active');
        const humanPlayerCard = document.getElementById('gomoku-player-human');
        const aiPlayerCard = document.getElementById('gomoku-player-ai');
        humanPlayerCard.querySelector('img').src = await getImageById(myMomentsProfile.avatarId);
        humanPlayerCard.querySelector('span').textContent = myMomentsProfile.name;
        aiPlayerCard.querySelector('img').src = await getImageById(opponent.avatarId);
        aiPlayerCard.querySelector('span').textContent = getDisplayName(opponent);
        const BOARD_SIZE = 15;
        gomokuGame = {
            board: Array(BOARD_SIZE).fill(0).map(() => Array(BOARD_SIZE).fill(0)),
            currentPlayer: 1, gameOver: false, inProgress: true,
            opponentContactId: contactId, humanPlayer: 1, aiPlayer: 2, size: BOARD_SIZE,
            chessStyle: opponent.chessStyle || '中等'
        };
        drawGomokuBoard(); updatePlayerTurnIndicator();
    }

    function drawGomokuBoard() {
        const canvas = document.getElementById('gomoku-board'); const ctx = canvas.getContext('2d');
        const boardSize = canvas.clientWidth; canvas.width = canvas.height = boardSize;
        const cellSize = boardSize / gomokuGame.size; const padding = cellSize / 2;
        ctx.clearRect(0, 0, boardSize, boardSize); ctx.strokeStyle = '#603813'; ctx.lineWidth = 1;
        for (let i = 0; i < gomokuGame.size; i++) {
            ctx.beginPath(); ctx.moveTo(padding + i * cellSize, padding); ctx.lineTo(padding + i * cellSize, boardSize - padding); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(padding, padding + i * cellSize); ctx.lineTo(boardSize - padding, padding + i * cellSize); ctx.stroke();
        }
        for (let y = 0; y < gomokuGame.size; y++) {
            for (let x = 0; x < gomokuGame.size; x++) {
                if (gomokuGame.board[y][x] !== 0) {
                    ctx.beginPath(); const pieceX = padding + x * cellSize; const pieceY = padding + y * cellSize;
                    ctx.arc(pieceX, pieceY, cellSize / 2 * 0.9, 0, 2 * Math.PI);
                    ctx.fillStyle = gomokuGame.board[y][x] === gomokuGame.humanPlayer ? 'black' : 'white'; ctx.fill();
                }
            }
        }
    }
    
    function updatePlayerTurnIndicator() {
        const humanCard = document.getElementById('gomoku-player-human'); const aiCard = document.getElementById('gomoku-player-ai');
        humanCard.classList.toggle('active', gomokuGame.currentPlayer === gomokuGame.humanPlayer);
        aiCard.classList.toggle('active', gomokuGame.currentPlayer === gomokuGame.aiPlayer);
    }
    
    function handleGomokuBoardClick(e) {
        if (gomokuGame.gameOver || gomokuGame.currentPlayer !== gomokuGame.humanPlayer) return;
        const canvas = document.getElementById('gomoku-board'); const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX; const y = (e.clientY - rect.top) * scaleY;
        const cellSize = canvas.width / gomokuGame.size;
        const col = Math.floor(x / cellSize); const row = Math.floor(y / cellSize);
        if (row < 0 || row >= gomokuGame.size || col < 0 || col >= gomokuGame.size || gomokuGame.board[row][col] !== 0) return;
        gomokuGame.board[row][col] = gomokuGame.humanPlayer; drawGomokuBoard();
        if (checkWin(row, col, gomokuGame.humanPlayer)) { endGomokuGame('你赢了！'); } else if (isBoardFull()) { endGomokuGame('平局！'); } else {
            gomokuGame.currentPlayer = gomokuGame.aiPlayer; updatePlayerTurnIndicator(); setTimeout(aiMove, 100);
        }
    }

    function checkWin(r, c, player) {
        const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];
        for (const [dr, dc] of directions) {
            let count = 1;
            for (let i = 1; i < 5; i++) { const nr = r + dr * i; const nc = c + dc * i; if (nr >= 0 && nr < gomokuGame.size && nc >= 0 && nc < gomokuGame.size && gomokuGame.board[nr][nc] === player) count++; else break; }
            for (let i = 1; i < 5; i++) { const nr = r - dr * i; const nc = c - dc * i; if (nr >= 0 && nr < gomokuGame.size && nc >= 0 && nc < gomokuGame.size && gomokuGame.board[nr][nc] === player) count++; else break; }
            if (count >= 5) return true;
        }
        return false;
    }
    
    function isBoardFull() { return gomokuGame.board.every(row => row.every(cell => cell !== 0)); }
    function endGomokuGame(message) { gomokuGame.gameOver = true; gomokuGame.inProgress = false; document.getElementById('gomoku-result-text').textContent = message; openModal('gomoku-result-modal'); }

    async function aiMove() {
        if (gomokuGame.gameOver) return;
        if (!apiSettings.baseUrl) {
            alert('请先在API应用中完成设置！');
            gomokuGame.currentPlayer = gomokuGame.humanPlayer;
            updatePlayerTurnIndicator();
            return;
        }

        const aiStatus = document.getElementById('gomoku-ai-status');
        aiStatus.textContent = '思考中...';

        const opponent = contacts.find(c => c.id === gomokuGame.opponentContactId);
        const myProfile = { name: myMomentsProfile.name, persona: '一个五子棋玩家' };
        const worldBookContent = (opponent.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)?.content).filter(Boolean).join('\n\n');
        
        const boardString = gomokuGame.board.map(row => row.join(' ')).join('\n');
        
        const originalPromptFunction = getBaseSystemPrompt;
        const getMoveOnlyPrompt = (...args) => {
            let prompt = originalPromptFunction(...args);
            prompt = prompt.replace(
                '你下棋时想说的一句简短的话（可选，但强烈建议，以符合人设）',
                '你只需要返回坐标，不要返回任何其他文字。'
            );
            return prompt;
        };

        const extraContext = {
            aiPlayer: gomokuGame.aiPlayer,
            boardString: boardString,
            chessStyle: gomokuGame.chessStyle
        };
        const prompt = getMoveOnlyPrompt(opponent, myProfile, worldBookContent, null, null, null, 'gomoku_move', extraContext);

        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` },
                body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] })
            });

            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();
            const moveString = (data.choices[0]?.message?.content || '').trim();
            
            const moveMatch = moveString.match(/\[\s*(\d+)\s*,\s*(\d+)\s*\]/);
            if (!moveMatch) throw new Error('AI返回了无效的移动格式: ' + moveString);

            const row = parseInt(moveMatch[1], 10);
            const col = parseInt(moveMatch[2], 10);

            if (row < 0 || row >= gomokuGame.size || col < 0 || col >= gomokuGame.size || gomokuGame.board[row][col] !== 0) {
                throw new Error(`AI尝试在无效或已占用的位置下棋: [${row},${col}]`);
            }

            gomokuGame.board[row][col] = gomokuGame.aiPlayer;
            drawGomokuBoard();
            
            getAiGomokuChatAfterMove(row, col);

            if (checkWin(row, col, gomokuGame.aiPlayer)) {
                endGomokuGame('你输了！');
            } else if (isBoardFull()) {
                endGomokuGame('平局！');
            } else {
                gomokuGame.currentPlayer = gomokuGame.humanPlayer;
                updatePlayerTurnIndicator();
            }

        } catch (error) {
            console.error("AI move error:", error);
            alert("AI下棋时出错: " + error.message + "\n将切换为你的回合。");
            gomokuGame.currentPlayer = gomokuGame.humanPlayer;
            updatePlayerTurnIndicator();
        } finally {
            aiStatus.textContent = '';
        }
    }
    
    async function showRpsOpponentSelection() { 
        const opponentSelectionList = document.getElementById('rps-opponent-list'); 
        opponentSelectionList.innerHTML = ''; 
        if (contacts.length === 0) { 
            opponentSelectionList.innerHTML = '<p style="text-align:center; color:#888; margin-top: 20px;">请先在微信中添加联系人</p>'; 
        } else { 
            for (const contact of contacts) { 
                const item = document.createElement('div'); 
                item.className = 'list-item'; 
                item.dataset.id = contact.id; 
                const avatarSrc = await getImageById(contact.avatarId); 
                item.innerHTML = `<img src="${avatarSrc}" alt="${getDisplayName(contact)}" class="list-item-avatar">${getDisplayName(contact)}`; 
                opponentSelectionList.appendChild(item); 
            } 
        } 
        openModal('rps-opponent-selection-modal'); 
    }
    async function startRpsGame(contactId) { 
        const opponent = contacts.find(c => c.id === contactId); 
        if (!opponent) return; 
        rpsGame = { opponentContactId: contactId, isActive: true, lastResult: null }; 
        closeModal('rps-opponent-selection-modal'); 
        document.getElementById('rps-game-container').classList.add('active'); 
        document.getElementById('rps-player-avatar').src = await getImageById(myMomentsProfile.avatarId); 
        document.getElementById('rps-player-name').textContent = myMomentsProfile.name || '我'; 
        document.getElementById('rps-ai-avatar').src = await getImageById(opponent.avatarId); 
        document.getElementById('rps-ai-name').textContent = getDisplayName(opponent); 
        resetRpsGame();
    }
    function resetRpsGame() {
        document.getElementById('rps-result-display').textContent = '选择你的出拳！';
        document.getElementById('rps-player-hand').textContent = '';
        document.getElementById('rps-ai-hand').textContent = '';
        document.getElementById('rps-player-emoji-display').textContent = '';
        document.getElementById('rps-ai-emoji-display').textContent = '';
        const controls = document.getElementById('rps-controls');
        controls.innerHTML = `<button id="rps-rock">✊</button><button id="rps-paper">✋</button><button id="rps-scissors">✌️</button>`;
        controls.style.display = 'flex';
        rpsGame.isActive = true;
    }
    function handleRpsPlayerChoice(playerChoice) { 
        if (!rpsGame.isActive) return; 
        rpsGame.isActive = false;
        const choices = ['rock', 'paper', 'scissors']; 
        const aiChoice = choices[Math.floor(Math.random() * 3)]; 
        const result = determineRpsWinner(playerChoice, aiChoice); 
        rpsGame.lastResult = result; 
        updateRpsUi(playerChoice, aiChoice, result); 
    }
    function determineRpsWinner(player, ai) { 
        if (player === ai) return 'draw'; 
        if ((player === 'rock' && ai === 'scissors') || (player === 'paper' && ai === 'rock') || (player === 'scissors' && ai === 'paper')) { 
            return 'win'; 
        } 
        return 'lose'; 
    }
    function updateRpsUi(playerChoice, aiChoice, result) { 
        const handMap = { rock: '✊', paper: '✋', scissors: '✌️' }; 
        document.getElementById('rps-player-hand').textContent = handMap[playerChoice]; 
        document.getElementById('rps-ai-hand').textContent = handMap[aiChoice]; 
        const resultDisplay = document.getElementById('rps-result-display'); 
        if (result === 'win') resultDisplay.textContent = '你赢了！🎉'; 
        else if (result === 'lose') resultDisplay.textContent = '你输了...'; 
        else resultDisplay.textContent = '平局！'; 
        const controls = document.getElementById('rps-controls');
        controls.innerHTML = `<button id="rps-rematch-btn" class="btn">再玩一次</button>`;
    }
    async function sendRpsEmoji(emoji) { 
        if (!apiSettings.baseUrl) return; 
        document.getElementById('rps-player-emoji-display').textContent = emoji; 
        const opponent = contacts.find(c => c.id === rpsGame.opponentContactId); 
        if (!opponent) return; 
        const resultText = rpsGame.lastResult ? `The last game result was: I ${rpsGame.lastResult}.` : "We haven't played yet."; 
        const prompt = `You are playing Rock-Paper-Scissors with me. Your persona is "${opponent.persona}". ${resultText} In response to this, I am sending you an emoji: ${emoji}. Based on your persona, the game result, and my emoji, you MUST choose exactly ONE emoji from this list to show your reaction: [😎, 😭, 😡, 🥰]. Your entire response must be ONLY the single emoji you choose. Absolutely no other text, words, or explanations.`; 
        try { 
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] }) }); 
            if (response.ok) { 
                const data = await response.json(); 
                const replyText = (data.choices[0]?.message?.content || '').trim(); 
                const validEmojis = ['😎', '😭', '😡', '🥰']; 
                if (validEmojis.includes(replyText)) { 
                    document.getElementById('rps-ai-emoji-display').textContent = replyText; 
                } 
            } 
        } catch (err) { console.error('AI emoji response failed:', err); } 
    }
    
    async function renderIconCustomizerApp() {
        const container = document.getElementById('icon-customizer-list');
        container.innerHTML = '';
        
        const officialAppIds = new Set([
            'wechat', 'music', 'gomoku', 'rps', 'anniversary', 
            'diary', 'api', 'worldbook', 'icon-customizer', 'wallpaper'
        ]);

        const cleanedAppConfig = appConfig.filter(app => officialAppIds.has(app.id));
        
        if (cleanedAppConfig.length !== appConfig.length) {
            console.log("检测到无效的应用配置，已自动清理。");
            appConfig = cleanedAppConfig;
            await saveData();
        }

        for (const app of appConfig) {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<img src="${await getImageById(app.icon)}" alt="${app.name}" class="list-item-avatar"><div class="info"><div class="name">${app.name}</div></div><button class="action-button" data-app-id="${app.id}">更换</button>`;
            container.appendChild(item);
        }
    }

    function handleSendGomokuChatMessage(text) {
        const playerBubble = document.getElementById('gomoku-chat-bubble-player');
        const aiBubble = document.getElementById('gomoku-chat-bubble-ai');
        
        if(aiBubble) aiBubble.style.display = 'none';
        playerBubble.textContent = text;
        playerBubble.style.display = 'block';
        
        closeModal('gomoku-chat-input-modal');
        triggerAiGomokuChatResponse(text);
    }
    async function triggerAiGomokuChatResponse(myText) {
        if (!apiSettings.baseUrl || !gomokuGame.opponentContactId) return;
        const partner = contacts.find(c => c.id === gomokuGame.opponentContactId);
        if(!partner) return;
        
        const myName = myMomentsProfile.name || '我';
        const worldBookContent = (partner.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)?.content).filter(Boolean).join('\n\n');
        const systemPrompt = `你是 ${getDisplayName(partner)}，你的人设是: ${partner.persona}。你的世界观是: ${worldBookContent || '现代都市'}。你正在和你的朋友 ${myName} 一起玩五子棋。在游戏过程中，对方发来一条私信。你的回复必须简短、口语化，符合你的人设和当前正在玩游戏的场景，并且绝对不能包含任何引号。`;
        
        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, 
                body: JSON.stringify({ 
                    model: apiSettings.model, 
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: myText }
                    ] 
                }) 
            });
            if (!response.ok) {
                console.error("AI gomoku chat error:", await response.text());
                return;
            }
            const data = await response.json();
            let replyText = data.choices[0]?.message?.content || '';
            
            replyText = replyText.replace(/["'“”]/g, '').trim();
            
            const playerBubble = document.getElementById('gomoku-chat-bubble-player');
            const aiBubble = document.getElementById('gomoku-chat-bubble-ai');
            
            setTimeout(() => {
                playerBubble.style.display = 'none';
                aiBubble.textContent = replyText;
                aiBubble.style.display = 'block';
                setTimeout(() => { aiBubble.style.display = 'none'; }, 4000);
            }, 1000);

        } catch(error) {
            console.error("AI gomoku chat error:", error);
        }
    }
    
    async function getAiGomokuChatAfterMove(row, col) {
        if (!apiSettings.baseUrl || !gomokuGame.opponentContactId) return;
        const partner = contacts.find(c => c.id === gomokuGame.opponentContactId);
        if(!partner) return;

        const systemPrompt = `你是 ${getDisplayName(partner)}，人设: ${partner.persona}。在五子棋对战中，你刚刚在 (${row}, ${col}) 位置落子。请根据你的人设，说一句简短的、符合当前棋局氛围的台词。可以是挑衅、自言自语、或感叹。回复必须简短，且绝对不能包含任何引号。`;
        
        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, 
                body: JSON.stringify({ 
                    model: apiSettings.model, 
                    messages: [{ role: 'system', content: systemPrompt }] 
                }) 
            });
            if (!response.ok) return;
            const data = await response.json();
            let chatText = (data.choices[0]?.message?.content || '').replace(/["'“”]/g, '').trim();
            
            if (chatText) {
                const aiBubble = document.getElementById('gomoku-chat-bubble-ai');
                aiBubble.textContent = chatText;
                aiBubble.style.display = 'block';
                setTimeout(() => { aiBubble.style.display = 'none'; }, 4000);
            }
        } catch(error) {
            console.error("AI gomoku chat after move error:", error);
        }
    }
    
    function generateRandomStrangers(count) {
        const strangers = [];
        const usedNames = new Set();
        for (let i = 0; i < count; i++) {
            let name;
            do {
                name = strangerNames[Math.floor(Math.random() * strangerNames.length)];
            } while (usedNames.has(name));
            
            name = name.replace(/xx/g, () => nameChars[Math.floor(Math.random() * nameChars.length)] + nameChars[Math.floor(Math.random() * nameChars.length)]);
            name = name.replace(/x/g, () => nameChars[Math.floor(Math.random() * nameChars.length)]);

            usedNames.add(name);
            strangers.push({
                name: name,
                avatar: strangerAvatars[Math.floor(Math.random() * strangerAvatars.length)]
            });
        }
        return strangers;
    }

    async function triggerRandomForumPosts() {
        if (!apiSettings.baseUrl) { alert('请先在API应用中完成设置！'); return; }
        const postCount = Math.floor(Math.random() * 3) + 2;
        const availableContacts = [...contacts];
        const posters = [];

        for (let i = 0; i < postCount; i++) {
            const isContact = Math.random() > 0.5 && availableContacts.length > 0;
            if (isContact) {
                const contactIndex = Math.floor(Math.random() * availableContacts.length);
                posters.push({ type: 'contact', data: availableContacts.splice(contactIndex, 1)[0] });
            } else {
                posters.push({ type: 'stranger', data: generateRandomStrangers(1)[0] });
            }
        }

        for (const poster of posters) {
            const isStranger = poster.type === 'stranger';
            let prompt;

            if (isStranger) {
                const authorName = poster.data.name;
                const scenario = forumScenarios[Math.floor(Math.random() * forumScenarios.length)];
                prompt = getBaseSystemPrompt({ name: authorName, persona: '一个普通的网友' }, { name: '路人', persona: '一个围观网友' }, '', '', '', null, 'forum_post_scenario', { isStranger, authorName, scenario });
            } else {
                const contact = poster.data;
                const myPersonaForThisContact = contact.myProfile || myMomentsProfile;
                const worldBookContent = (contact.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)?.content).filter(Boolean).join('\n\n');
                const recentChatHistory = (contact.chatHistory || []).slice(-5).map(msg => {
                    const speaker = msg.sender === 'sent' ? (myPersonaForThisContact.name || '我') : getDisplayName(contact);
                    return `${speaker}: ${msg.text || `[${msg.type}]`}`;
                }).join('\n');
                prompt = getBaseSystemPrompt(contact, myPersonaForThisContact, worldBookContent, '', '', null, 'forum_post_from_persona', { recentChatHistory });
            }
            
            try {
                const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] }) });
                if (response.ok) {
                    const data = await response.json();
                    const postContent = data.choices[0]?.message?.content || '';
                    
                    const imageMatch = postContent.match(/\[IMAGE:\s*(.*?)\]/);
                    const cleanContent = postContent.replace(/\[IMAGE:.*?\]/, '').trim();
                    const [title, ...textParts] = cleanContent.split('|||---|||');
                    const text = textParts.join(' ').trim();

                    if (title && text) {
                        const newPost = {
                            id: Date.now() + Math.random(),
                            authorId: isStranger ? poster.data.name : poster.data.id,
                            authorType: isStranger ? 'stranger' : 'contact',
                            authorName: isStranger ? poster.data.name : null,
                            authorAvatar: isStranger ? poster.data.avatar : null,
                            title: title.trim(),
                            text: text,
                            imageDesc: imageMatch ? imageMatch[1] : null,
                            comments: [],
                            likes: []
                        };
                        forumPosts.push(newPost);
                        await renderForum();
                        await saveData();
                        triggerForumInteraction(newPost);
                    }
                }
            } catch (err) { console.error('AI forum post failed:', err); }
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }

    async function triggerForumInteraction(post) {
        if (!apiSettings.baseUrl) return;
        const potentialCommenters = [ ...contacts.map(c => ({ ...c, isStranger: false })), ...generateRandomStrangers(Math.floor(Math.random() * 5) + 3).map(s => ({ ...s, isStranger: true })) ];
        const commenters = potentialCommenters.filter(c => (c.isStranger ? c.name : c.id) !== post.authorId);
        let commentedUsers = [];
        for (let i = 0; i < commenters.length; i++) {
            const commenter = commenters[i];
            const delay = 4000 + i * (4000 + Math.random() * 5000);
            setTimeout(async () => {
                const commenterId = commenter.isStranger ? commenter.name : commenter.id;
                if (Math.random() < 0.7) { if (!post.likes) post.likes = []; if (!post.likes.includes(commenterId)) { post.likes.push(commenterId); } }
                if (Math.random() < 0.6) {
                    const newComment = await triggerAIForumComment(post, commenter);
                    if (newComment) {
                        commentedUsers.push({ commenter, comment: newComment });
                        if (post.authorId !== 'me') {
                            setTimeout(async () => {
                                let op;
                                if (post.authorType === 'contact') { op = { ...contacts.find(c => c.id === post.authorId), isStranger: false }; } 
                                else { op = { name: post.authorName, avatar: post.authorAvatar, persona: '一个普通的网友', isStranger: true }; }
                                if (op && (op.isStranger ? op.name : op.id) !== newComment.authorId) {
                                    await triggerAIForumReply(post, newComment, op);
                                    await renderSingleForumPost(post.id);
                                    await saveData();
                                }
                            }, 5000 + Math.random() * 7000);
                        }
                    }
                }
                await renderSingleForumPost(post.id);
                await saveData();
                if (commentedUsers.length > 1 && Math.random() < 0.4) {
                    setTimeout(async () => {
                        const replierData = commentedUsers[commentedUsers.length - 1];
                        const targetCommentData = commentedUsers[Math.floor(Math.random() * (commentedUsers.length - 1))];
                        const replierId = replierData.commenter.isStranger ? replierData.commenter.name : replierData.commenter.id;
                        if (replierId !== targetCommentData.comment.authorId) {
                             await triggerAIForumReply(post, targetCommentData.comment, replierData.commenter);
                             await renderSingleForumPost(post.id);
                             await saveData();
                        }
                    }, 3000 + Math.random() * 4000);
                }
            }, delay);
        }
    }

    async function triggerAIForumComment(post, commenter) {
        if (!apiSettings.baseUrl) return null;
        const isStranger = commenter.isStranger;
        const authorName = isStranger ? commenter.name : getDisplayName(commenter);
        const persona = isStranger ? '一个普通的网友' : commenter.persona;
        
        let postAuthorName;
        if (post.authorId === 'me') { 
            postAuthorName = myMomentsProfile.name; 
        } else if (post.authorType === 'contact') { 
            const contact = contacts.find(c => c.id === post.authorId); 
            postAuthorName = contact ? contact.name : '某人';
        } else { 
            postAuthorName = post.authorName; 
        }

        const worldBookContentForComment = isStranger ? '' : (commenter.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)?.content).filter(Boolean).join('\n\n');
        
        let relationshipContext = null;
        let personaForPrompt = myMomentsProfile;
        if (isStranger) {
            personaForPrompt = { name: '路人', persona: '一个围观网友' };
        } else {
            const commenterContact = contacts.find(c => c.id === commenter.id);
            const myProfileForCommenter = commenterContact.myProfile || myMomentsProfile;
            relationshipContext = { name: myProfileForCommenter.name || '我', persona: myProfileForCommenter.persona || '一个普通人' };
        }

        let prompt = getBaseSystemPrompt({ name: authorName, persona }, personaForPrompt, worldBookContentForComment, '', '', null, 'forum_comment', { postAuthorName, postTitle: post.title, postText: post.text }, relationshipContext);
        
        if (!isStranger && relationshipContext) {
            prompt += `\n\n**VERY IMPORTANT FORUM RULE:** Your primary loyalty is to ${relationshipContext.name}. Before commenting on any post, consider if it's appropriate. Your comments must always reflect your deep relationship with them. Avoid any overly familiar or flirtatious comments with anyone else. You are far more likely to comment on posts by ${relationshipContext.name} or posts that directly involve them. For posts by strangers, your comments should be brief and distant, if you decide to comment at all.`;
        }

        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] }) });
            if (response.ok) {
                const data = await response.json();
                const commentText = (data.choices[0]?.message?.content || '').replace(/["'“”]/g, '').trim();
                if (commentText) {
                    const newComment = {
                        id: Date.now() + Math.random(),
                        authorId: isStranger ? commenter.name : commenter.id,
                        authorType: isStranger ? 'stranger' : 'contact',
                        authorName: isStranger ? commenter.name : null,
                        authorAvatar: isStranger ? commenter.avatar : null,
                        text: commentText,
                        replyTo: null,
                        likes: []
                    };
                    if (!post.comments) post.comments = [];
                    post.comments.push(newComment);
                    return newComment;
                }
            }
        } catch (err) { console.error('AI forum comment failed:', err); }
        return null;
    }

    async function triggerAIForumReply(post, originalComment, replier) {
        if (!apiSettings.baseUrl) return null;
        
        const isReplierStranger = replier.isStranger;
        const replierId = isReplierStranger ? replier.name : replier.id;

        if (replierId === originalComment.authorId) return null;

        const replierName = isReplierStranger ? replier.name : getDisplayName(replier);
        const replierPersona = isReplierStranger ? '一个普通的网友' : replier.persona;
        
        let commentAuthorName = originalComment.replyToName || '某人';
        if (originalComment.authorId === 'me') {
            commentAuthorName = myMomentsProfile.name;
        } else if (originalComment.authorType === 'contact') {
            const contact = contacts.find(c => c.id === originalComment.authorId);
            if (contact) commentAuthorName = getDisplayName(contact);
        } else {
            commentAuthorName = originalComment.authorName;
        }
        const commentText = originalComment.text;

        const worldBookContentForReply = isReplierStranger ? '' : (replier.worldBookIds || []).map(id => worldBooks.find(wb => wb.id === id)?.content).filter(Boolean).join('\n\n');
        
        let relationshipContext = null;
        let personaForPrompt = myMomentsProfile;
        if (isReplierStranger) {
            personaForPrompt = { name: '路人', persona: '一个围观网友' };
        } else {
            const replierContact = contacts.find(c => c.id === replier.id);
            const myProfileForReplier = replierContact.myProfile || myMomentsProfile;
            relationshipContext = { name: myProfileForReplier.name || '我', persona: myProfileForReplier.persona || '一个普通人' };
        }

        let prompt = getBaseSystemPrompt({ name: replierName, persona: replierPersona }, personaForPrompt, worldBookContentForReply, '', '', null, 'forum_reply', { postTitle: post.title, postText: post.text, commentAuthorName, commentText }, relationshipContext);

        if (!isReplierStranger && relationshipContext) {
            prompt += `\n\n**VERY IMPORTANT FORUM RULE:** Your primary loyalty is to ${relationshipContext.name}. Before replying, consider if it's appropriate. Your reply must always reflect your deep relationship with them. Avoid any overly familiar or flirtatious replies to anyone else. You are far more likely to reply to comments by ${relationshipContext.name} or on posts that directly involve them. For replies to strangers, your tone should be brief and distant.`;
        }

        try {
            const response = await fetch(`${apiSettings.baseUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.apiKey}` }, body: JSON.stringify({ model: apiSettings.model, messages: [{ role: 'user', content: prompt }] }) });
            if (response.ok) {
                const data = await response.json();
                const replyText = (data.choices[0]?.message?.content || '').replace(/["'“”]/g, '').trim();
                if (replyText) {
                    const newReply = {
                        id: Date.now() + Math.random(),
                        authorId: replierId,
                        authorType: isReplierStranger ? 'stranger' : 'contact',
                        authorName: isReplierStranger ? replier.name : null,
                        authorAvatar: isReplierStranger ? replier.avatar : null,
                        text: replyText,
                        replyTo: originalComment.authorId,
                        replyToName: commentAuthorName,
                        likes: []
                    };
                    if (!post.comments) post.comments = [];
                    post.comments.push(newReply);
                    return newReply;
                }
            }
        } catch (err) { console.error('AI forum reply failed:', err); }
        return null;
    }

    const player = document.getElementById('music-player-element');
    const island = document.getElementById('dynamic-island');
    const waveform = document.querySelector('.music-waveform');
    const playPauseBtn = document.getElementById('island-play-pause-btn');

    document.getElementById('island-album-art').innerHTML = musicNoteSVG;
    playPauseBtn.innerHTML = playSVG;
    document.getElementById('island-prev-btn').innerHTML = prevSVG;
    document.getElementById('island-next-btn').innerHTML = nextSVG;
    document.getElementById('island-close-btn').innerHTML = closeSVG;

    player.onplay = () => {
        island.classList.add('music-active');
        island.classList.remove('expanded');
        waveform.classList.remove('paused');
        playPauseBtn.innerHTML = pauseSVG;
        updateDynamicIslandMusicInfo();
        const playingItem = document.querySelector(`.music-song-item[data-url="${player.src}"]`);
        document.querySelectorAll('.music-song-item.playing').forEach(i => i.classList.remove('playing'));
        if(playingItem) playingItem.classList.add('playing');
    };

    player.onpause = () => {
        if (island.classList.contains('music-active')) {
            waveform.classList.add('paused');
            playPauseBtn.innerHTML = playSVG;
        }
        const playingItem = document.querySelector('.music-song-item.playing');
        if(playingItem) playingItem.classList.remove('playing');
    };
    
    player.onended = () => {
        playNextSong();
    };

    island.addEventListener('click', (e) => {
        if (!island.classList.contains('music-active')) return;
        if (e.target.closest('.music-control-btn') || e.target.closest('#island-close-btn')) return;
        island.classList.toggle('expanded');
    });

    playPauseBtn.addEventListener('click', () => {
        if (player.paused) {
            if (player.src) {
                player.play().catch(err => console.error("Playback error:", err));
            }
        } else {
            player.pause();
        }
    });

    document.getElementById('island-next-btn').addEventListener('click', playNextSong);
    document.getElementById('island-prev-btn').addEventListener('click', playPrevSong);
    document.getElementById('island-close-btn').addEventListener('click', () => {
        player.pause();
        player.removeAttribute('src');
        island.classList.remove('music-active', 'expanded');
    });

    init();
});
</script>
</body>
</html>
